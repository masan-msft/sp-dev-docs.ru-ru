---
title: "Создание и использование маркеров доступа в надстройках SharePoint с высоким уровнем доверия, размещенных у поставщика"
ms.date: 09/25/2017
ms.prod: sharepoint
ms.openlocfilehash: ff6e28f143eda7eb9f8a088dceb6807964ab586d
ms.sourcegitcommit: 1cae27d85ee691d976e2c085986466de088f526c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2017
---
# <a name="create-and-use-access-tokens-in-provider-hosted-high-trust-sharepoint-add-ins"></a><span data-ttu-id="baf8d-102">Создание и использование маркеров доступа в надстройках SharePoint с высоким уровнем доверия, размещенных у поставщика</span><span class="sxs-lookup"><span data-stu-id="baf8d-102">Create and use access tokens in provider-hosted high-trust SharePoint Add-ins</span></span>
<span data-ttu-id="baf8d-103">Узнайте, какую роль выполняют маркеры доступа в надстройках SharePoint с высоким уровнем доверия и как код работает с ними.</span><span class="sxs-lookup"><span data-stu-id="baf8d-103">Learn about the role of access tokens in high-trust SharePoint Add-ins and how your code works with them.</span></span>
 

 <span data-ttu-id="baf8d-p101">**Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint.md#bk_newname).</span><span class="sxs-lookup"><span data-stu-id="baf8d-p101">**Note**  The name "apps for SharePoint" is changing to "SharePoint Add-ins". During the transition, the documentation and the UI of some SharePoint products and Visual Studio tools might still use the term "apps for SharePoint". For details, see  [New name for apps for Office and SharePoint](new-name-for-apps-for-sharepoint.md#bk_newname).</span></span>
 


 <span data-ttu-id="baf8d-p102">**Важно!**   **Вся данная статья посвящена использованию маркеров доступа в системе авторизации с высоким уровнем доверия (не в системе ACS).** Сведения об использовании маркеров безопасности в системе ACS см. в разделе [Обработка маркеров безопасности в надстройках с низким уровнем доверия для SharePoint, размещаемых у поставщика](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md).</span><span class="sxs-lookup"><span data-stu-id="baf8d-p102">**Important**   **This article is entirely about the use of access tokens in the high-trust authorization system, not the ACS system.** For information about the user of security tokens in the ACS system, see [Handle security tokens in provider-hosted low-trust SharePoint Add-ins](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md).</span></span>
 


 <span data-ttu-id="baf8d-p103">**Надстройки SharePoint, использующие [систему авторизации с высоким уровнем доверия](creating-sharepoint-add-ins-that-use-high-trust-authorization.md) для доступа к SharePoint, должны передавать маркер доступа** (в формате [JSON Web Token](http://datatracker.ietf.org/doc/draft-ietf-oauth-json-web-token/)) в SharePoint с каждым запросом на создание, чтение, обновление или удаление (CRUD). SharePoint проверяет маркер и выполняет запрос. В этой статье представлены сведения о том, как код создает и передает маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p103">**SharePoint Add-ins that use the  [high-trust authorization system](creating-sharepoint-add-ins-that-use-high-trust-authorization.md) to gain access to SharePoint have to pass an access token** (in [JSON Web Token](http://datatracker.ietf.org/doc/draft-ietf-oauth-json-web-token/) format) to SharePoint with each create, read, update, or delete (CRUD) request. SharePoint validates the token and serves the request. This article provides information about how your code creates and passes the access token.</span></span>
 

<span data-ttu-id="baf8d-p104">В системе авторизации с высоким уровнем доверия **маркер доступа создается удаленным компонентом надстройки SharePoint**. Если удаленный компонент использует управляемый код на стороне сервера, большая часть кода для создания маркеров создается автоматически в файлах SharePointContext и TokenHelper (с расширением CS или VB), входящих в состав Инструментов разработчика Office для Visual Studio. Так как пользователь надстройки SharePoint с высоким уровнем доверия применяет локальную среду SharePoint, вероятно, он не будет возражать против использования ASP.NET, служб IIS и Windows Sever в качестве стека для размещения удаленного компонента. Рекомендуем использовать этот стек, так как создание этих двух файлов значительно упростит написание кода и тестирование. Если удаленному компоненту необходимо использовать другой язык, отличный от .NET, а удаленный компонент и ферма SharePoint подключены к Интернету, то рекомендуем использовать [систему авторизации с низким (а не высоким) уровнем доверия](creating-sharepoint-add-ins-that-use-low-trust-authorization.md). В системе службы контроля доступа Microsoft Azure (ACS) созданием маркеров занимается ACS, что также значительно упрощает работу. Оставшаяся часть этой статьи в основном содержит рекомендации для разработчиков по созданию надстроек SharePoint с удаленными компонентами без применения .NET и использованию системы авторизации с высоким уровнем доверия. В ней также представлены ценные сведения об отладке надстроек SharePoint на основе .NET, использующих систему с высоким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p104">In the high-trust authorization system,  **the remote component of your SharePoint Add-in creates the access token**. If the remote component is using managed code for its server-side code, most of the coding work for creating the tokens is done for you in the SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) files that are included in Office Developer Tools for Visual Studio. Since the customer for a high-trust SharePoint Add-in has on-premise SharePoint, they are probably not averse to using ASP.NET, IIS, and Windows Sever as the hosting stack for the remote component. You should consider using this stack because the two generated files will save you a lot of coding and testing labor. If the remote component must use a non-.NET language, and both the remote component and the SharePoint farm are connected to the Internet, you should consider using [the low-trust authorization system](creating-sharepoint-add-ins-that-use-low-trust-authorization.md) instead of high-trust. In the Microsoft Azure Access Control Service (ACS) system, all the token construction is done by ACS, so you are also spared a lot of labor. The remainder of this article is mainly intended to provide guidance to developers creating SharePoint Add-ins with non-.NET remote components and using the high-trust authorization system. It can also provide some valuable information for debugging .NET-based SharePoint Add-ins that use the high-trust system.</span></span>
 

## <a name="understand-the-handling-of-access-tokens"></a><span data-ttu-id="baf8d-120">Общие сведения об обработке маркеров доступа</span><span class="sxs-lookup"><span data-stu-id="baf8d-120">Understand the handling of access tokens</span></span>
<span data-ttu-id="baf8d-121"><a name="AccessTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-121"></span></span>


 <span data-ttu-id="baf8d-p105">**Примечание.** При чтении этой статьи помните (особенно это касается задач, которые должен выполнять ваш код), что если вы используете управляемый код, Инструменты разработчика Microsoft Office для Visual Studio добавляют к каждому проекту надстройки SharePoint два сгенерированных файла с кодом: SharePointContext и TokenHelper (с расширением CS или VB), которые выполняют большую часть таких задач за вас. Код для обработки маркера, используемый в вашем приложении, обычно состоит всего лишь из нескольких вызовов классов в этих файлах. Сведения в этой статье призваны помочь разработчикам, которые не используют управляемый код (и помочь при устранении проблем с маркерами). Ссылки на библиотеки OAuth для многих языков и платформ представлены на странице [OAuth 2.0](http://oauth.net/2/). Прокрутите страницу до раздела **Клиентские библиотеки**. Чтобы получить дополнительные сведения, выполните поиск по запросам "OAuth 2" и "JSON web token" (без кавычек) на сайте [GitHub](https://github.com/).</span><span class="sxs-lookup"><span data-stu-id="baf8d-p105">**Note**   Keep in mind when reading this article, particularly about tasks that your code must carry out, that if you are using managed code, the Microsoft Office Developer Tools for Visual Studio add to every SharePoint Add-in project two generated code files, SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) that do most of these tasks for you. Your application's token handling code usually consists of just a few calls to the classes in these files. The details in this topic are to help developers who are not using managed code (and to help those who are with troubleshooting problems with tokens). Links to OAuth libraries for many languages and platforms are at: [OAuth 2.0](http://oauth.net/2/) Scroll to **Client Libraries**. You can find more by searching [github](https://github.com/) for "OAuth 2" and for "JSON web token" (without the quotation marks).</span></span>
 

<span data-ttu-id="baf8d-127">Ниже описаны главные **задачи, которые должен выполнять ваш код**.</span><span class="sxs-lookup"><span data-stu-id="baf8d-127">The main  **things that your code needs to** do are:</span></span>
 

 

1.  <span data-ttu-id="baf8d-p106">**Создание маркера доступа.** Подзадачи по созданию этого маркера разнятся в зависимости того, какие вызовы делает удаленное веб-приложение: SharePointтолько для надстройки, для надстройки и пользователя или оба вида вызовов. (Сведения об обоих видах вызовов см. в разделе [Типы политик авторизации для надстроек в SharePoint 2013](add-in-authorization-policy-types-in-sharepoint.md).)</span><span class="sxs-lookup"><span data-stu-id="baf8d-p106">**Create an access token.** The subtasks for creating this token vary depending on whether the remote web application makesadd-in-only calls to SharePoint,user+add-in calls, or both. (For information about the two kinds of calls, see [Add-in authorization policy types in SharePoint 2013](add-in-authorization-policy-types-in-sharepoint.md).)</span></span> 
    
    <span data-ttu-id="baf8d-131">Если надстройка делает вызовы для пользователя и надстройки, то создание маркера доступа включает указанные ниже подзадачи.</span><span class="sxs-lookup"><span data-stu-id="baf8d-131">If the add-in makes user+add-in calls, then creating the access token includes the following subtasks:</span></span>
    
      1. <span data-ttu-id="baf8d-p107">Создание маркера субъекта, который идентифицирует надстройку SharePoint и указывает SharePoint делегировать функцию проверки подлинности и авторизации пользователей вашей надстройке, а также кодировать ее с помощью кодировки Base 64. Сведения об утверждениях и структуре маркера субъекта см. в таблице 2 ниже. Сведения о кодировании и подписании маркера см. в разделе  [Кодирование и подписание маркеров](#EncodeTokens) ниже.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p107">Create an actor token that identifies the SharePoint Add-in and tells SharePoint to delegate user authentication and authorization to your add-in, and encode it in base 64 encoding. Details about the claims and structure of the actor token are in table 2 below. Details about encoding and signing the token are in [Encoding and signing tokens](#EncodeTokens) below.</span></span>
    
 
  2. <span data-ttu-id="baf8d-135">Подписание маркера субъекта с помощью учетных данных из сертификата x509, указанного в качестве доверенного для SharePoint администратором фермы SharePoint.</span><span class="sxs-lookup"><span data-stu-id="baf8d-135">Sign the actor token with credentials from an x509 certificate that a SharePoint farm administrator has configured SharePoint to trust.</span></span>
    
 
  3. <span data-ttu-id="baf8d-136">Включение маркера субъекта в маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-136">Include the actor token in the access token.</span></span>
    
 
  4. <span data-ttu-id="baf8d-p108">Добавление других требуемых утверждений в маркер доступа. Сведения об утверждениях и структуре маркера приведены в таблице 1 ниже.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p108">Add other required claims to the access token. Details about the claims and structure of the token are in table 1 below.</span></span>
    
 
  5. <span data-ttu-id="baf8d-p109">Кодирование маркера доступа с использованием base 64. Сведения о кодировании и подписании маркера представлены в разделе  [Кодирование и подпись маркеров](#EncodeTokens) ниже.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p109">Encode the access token with base 64. Details about encoding and signing the token are in  [Encoding and signing tokens](#EncodeTokens) below.</span></span>
    
 

    <span data-ttu-id="baf8d-p110">Если надстройка делает только вызовы для надстройки, то в коде необходимо реализовать только первые две из этих подзадач. Маркер субъекта выступает маркером доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p110">If the add-in makes add-in-only calls, then your code only needs to do the first two of these subtasks. The actor token serves as the access token.</span></span>
    
    <span data-ttu-id="baf8d-p111">Если надстройка делает часть вызовов для пользователя и надстройки и часть только для надстройки, то она должна создать простой маркер субъекта для вызовов только для надстройки и более крупный вложенный маркер доступа для вызовов для пользователя и надстройки. Невозможно использовать один и тот же маркер для обеих целей.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p111">If the add-in makes some user+add-in calls and some add-in-only calls, it must create a simple actor token for the add-in-only calls and the larger, nested access token for the user+add-in calls. The same access token cannot be used for both.</span></span>
    
 
2.  <span data-ttu-id="baf8d-p112">**Включение маркера доступа в каждый HTTP-запрос к SharePoint.** Маркер добавляется в запрос как заголовок **Authorization**. Значением заголовка является слово "Bearer", после которого следует пробел и маркер доступа в кодировке base 64.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p112">**Include the access token in every HTTP request to SharePoint.** The token is added as an **Authorization** header to the request. The value of the header is the word "Bearer", followed by a space, followed by the base 64-encoded access token.</span></span>
    
 
3. <span data-ttu-id="baf8d-148">Необязательно: **кэширование маркера доступа** для повторного использования в последующих запросах.</span><span class="sxs-lookup"><span data-stu-id="baf8d-148">Optionally,  **cache the access token** for reuse on subsequent requests.</span></span>
    
 
<span data-ttu-id="baf8d-p113">Эти задачи должны выполняться кодом на стороне сервера. Если вы используете управляемый код, пример кода для некоторых из этих задач вы найдете в файлах SharePointContext и TokenHelper (с расширением CS или VB), генерируемых Инструменты разработчика Microsoft Office для Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p113">These tasks must be done with server-side code. If you are using managed code, sample code for some of these tasks is in the SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) files that the Microsoft Office Developer Tools for Visual Studio generate.</span></span>
 

 

### <a name="cache-the-access-token"></a><span data-ttu-id="baf8d-151">Кэширование маркера доступа</span><span class="sxs-lookup"><span data-stu-id="baf8d-151">Cache the access token</span></span>
<span data-ttu-id="baf8d-152"><a name="CacheAccessToken"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-152"></span></span>

<span data-ttu-id="baf8d-p114">После создания маркера его можно повторно использовать в последующих вызовах к SharePoint, пока не истечет срок его действия. Существует несколько **способов кэширования маркера доступа** на сервере в зависимости от архитектуры и платформы размещения компонента.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p114">After a token is created, it can be reused in later calls to SharePoint until it expires. Depending on the remote component's architecture and hosting platform, there are several  **ways to cache the access token** on the server.</span></span>
 

 

- <span data-ttu-id="baf8d-155">В состоянии сеанса.</span><span class="sxs-lookup"><span data-stu-id="baf8d-155">In session state</span></span>
    
 
- <span data-ttu-id="baf8d-156">В состоянии приложения.</span><span class="sxs-lookup"><span data-stu-id="baf8d-156">In application state</span></span>
    
 
- <span data-ttu-id="baf8d-157">В  [кэше Windows Server AppFabric](http://msdn.microsoft.com/library/8aef3f5d-2a77-46d9-b951-0768fedd31a1%28Office.15%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="baf8d-157">In  [Windows Server AppFabric Caching](http://msdn.microsoft.com/library/8aef3f5d-2a77-46d9-b951-0768fedd31a1%28Office.15%29.aspx).</span></span>
    
 
- <span data-ttu-id="baf8d-158">В базе данных.</span><span class="sxs-lookup"><span data-stu-id="baf8d-158">In a database</span></span>
    
 
- <span data-ttu-id="baf8d-159">В системе [memcached](http://www.memcached.org/).</span><span class="sxs-lookup"><span data-stu-id="baf8d-159">In a  [memcached](http://www.memcached.org/) system</span></span>
    
 
<span data-ttu-id="baf8d-p115">Если хранилище кэша совместно используется различными сеансами пользователя (например, кэшем приложения), обязательно используйте ключ кэша, уникальный для сеанса. Кроме того, если кэш совместно используется несколькими приложениями, ваш код должен **сделать ключ кэша относительным** для этой переменной. Возможно также, что ваша надстройка обращается к различным фермам SharePoint. Вам понадобятся отдельные маркеры доступа для каждой из них, поэтому в данном сценарии ваш ключ кэша должен быть относительным для фермы. Наконец, вам могут потребоваться ключи кэша, основанные на одном или нескольких идентификаторах пользователей, идентификаторах приложений и домене или области SharePoint. Рекомендуем использовать систему ключей кэша, аналогичную той, которую используют надстройки SharePoint, применяющие систему авторизации с низким уровнем доверия. Дополнительные сведения см. в разделе [Общие сведения о ключе кэша](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md#CacheKey). По сути, вы будете объединять один или несколько из этих трех идентификаторов (с необязательным хэшированием результата в более короткую строку), получая ключ кэша.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p115">If the cache storage is shared by different user sessions, such as the application cache, then be sure to use a cache key that is unique to the session. If the cache is shared by multiple applications, your code must also  **relativize the cache key** for that variable as well. It is also possible that your add-in accesses different SharePoint farms. You will need distinct access tokens for each of them, so in that scenario your cache key would need to relativize for the farm. Altogether you may need cache keys that are based on one or more of user ID, application ID, and SharePoint domain or realm. Consider using a cache key system similar to the one used by SharePoint Add-ins that use the low-trust authorization system. For details, see [Understand the cache key](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md#CacheKey). Essentially, you would concatenate one or more of these three IDs (and optionally hash the result into a shorter string) to serve as a cache key.</span></span> 
 

 

### <a name="handle-expired-access-tokens"></a><span data-ttu-id="baf8d-168">Обработка маркеров доступа с истекшим сроком действия</span><span class="sxs-lookup"><span data-stu-id="baf8d-168">Handle expired access tokens</span></span>
<span data-ttu-id="baf8d-169"><a name="CacheAccessToken"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-169"></span></span>

 <span data-ttu-id="baf8d-p116">**У маркера доступа есть время действия**, для которого с помощью кода можно установить любое значение. Если ваша надстройка создает новый маркер доступа для каждого запроса, то срок действия каждого маркера должен быть достаточным лишь для того, чтобы пройти проверку SharePoint, то есть не больше нескольких секунд, если только локальная сеть клиента обычно не перегружена. В качестве срока действия можно устанавливать даже годы, но даже при "полностью локальном" сценарии, для которого разрабатываются надстройки с высоким уровнем доверия, существует определенная опасность кражи маркеров доступа. Поэтому рекомендуется не задавать срок действия дольше нескольких часов. Если вы работаете с управляемым кодом, то в примере кода для создания маркера в файле TokenHelper (с расширением CS или VB) показано, как задать 12-часовой срок действия.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p116">**The access token has an expiration time** which your code can set to any value you want. If your add-in constructs a new access token for every request, then each token only has to live long enough to be validated by SharePoint, no more than a few seconds unless the customer's LAN is usually clogged. You could set the expiration to years in the future, but even in the "all on-premise" scenario for which high-trust add-ins are designed, there is some danger of access tokens being stolen. So you should consider setting the expiration to no more than a few hours. (If you are working with managed code, the sample token-creation code in the TokenHelper.cs [or .vb] file sets the expiration to 12 hours.)</span></span>
 

 
<span data-ttu-id="baf8d-p117">Если продолжительность сеанса пользователя, в котором используется надстройка SharePoint, превышает срок действия кэшированного маркера доступа, то первый запрос к SharePoint после истечения срока действия маркера приведет к ошибке **401 - Не санкционировано**. В коде должна быть предусмотрена обработка такого отклика. Или же код может проверять срок действия маркера доступа до его использования. **Ваш код должен реагировать на просроченный маркер доступа, создавая новый** и повторяя запрос, который не удалось выполнить.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p117">If a user's session with your SharePoint Add-in lasts longer than the lifespan of the cached access token, then the first request to SharePoint after the expiration of the token will result in a  **401 Unauthorized** error. Your code has to handle this response. Alternatively, it can test the expiration time of the access token before it is used. **Your code should respond to an expired access token by creating a new access token** and repeating the request that failed.</span></span>
 

 

## <a name="understand-the-structure-of-access-tokens"></a><span data-ttu-id="baf8d-179">Общие сведения о структуре маркеров доступа</span><span class="sxs-lookup"><span data-stu-id="baf8d-179">Understand the structure of access tokens</span></span>
<span data-ttu-id="baf8d-180"><a name="Structure"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-180"></span></span>

<span data-ttu-id="baf8d-p118">Ниже приведен **пример маркера доступа, созданного надстройкой SharePoint с высоким уровнем доверия**, а именно примером кода из файла TokenHelper (с расширением CS или VB) в шаблоне проекта надстройки SharePoint, созданного Инструментами разработчика Office для Visual Studio в среде Visual Studio 2013 с обновлением 2. Маркер был раскодирован, и к нему добавлен пробел для удобочитаемости. Маркеры доступа, используемые в системе с высоким уровнем доверия, поддерживают [протокол проверки подлинности OAuth 2.0](http://msdn.microsoft.com/library/05f9759b-0fa4-45ff-bd4b-0d7d254e7010.aspx) ([MS-SPS2SAUTH]: OAuth 2.0 Authentication Protocol: SharePoint Profile), который также называется протоколом S2S. Эти сведения призваны помочь разработчикам при отладке надстроек SharePoint с высоким уровнем доверия при помощи управляемого кода, а также содержат рекомендации по созданию маркеров для разработчиков, использующих другие языки.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p118">The following is an  **example of an access token generated by a high-trust SharePoint Add-in**; specifically, this token was generated by the sample code in the TokenHelper.cs (or .vb) file that is part of the SharePoint Add-in project template created by the Office Developer Tools for Visual Studio in Visual Studio 2013 Update 2. The token has been decoded and white space has been added for readability. The access tokens used in the high-trust system are compliant with the [[MS-SPS2SAUTH]: OAuth 2.0 Authentication Protocol: SharePoint Profile](http://msdn.microsoft.com/library/05f9759b-0fa4-45ff-bd4b-0d7d254e7010.aspx), which is also called the server-to-server or S2S protocol. This information is provided to help developers using managed code debug high-trust SharePoint Add-ins, and to provide some guidance to developers using other languages about how to construct the tokens.</span></span>
 

 
 <span data-ttu-id="baf8d-p119">**Этот маркер доступа создается, если надстройка отправляет запрос к SharePoint с использованием  [политики для пользователя и надстройки](add-in-authorization-policy-types-in-sharepoint.md).** Если надстройка использует [политику только для надстройки](add-in-authorization-policy-types-in-sharepoint.md) и отправляет запрос только для надстройки к SharePoint, маркер субъекта (дочерний маркер в маркере доступа для пользователя и надстройки, описанный ниже), становится маркером доступа (при этом родительский маркер отсутствует).</span><span class="sxs-lookup"><span data-stu-id="baf8d-p119">**This access token is generated if the add-in is making a call to SharePoint using the  [user+add-in policy](add-in-authorization-policy-types-in-sharepoint.md).** If the add-in is using the [add-in-only policy](add-in-authorization-policy-types-in-sharepoint.md) and it makes an add-in-only call to SharePoint, then the actor token (which is a child token within the user+add-in access token and is described below), becomes the access token (and there is no parent token).</span></span>
 

 

 <span data-ttu-id="baf8d-p120">**Примечание.** Обратите внимание, что создаваемые кодом маркеры доступа с высоким уровнем доверия отличаются от маркеров, создаваемых службой ACS Azure при использовании системы авторизации с низким уровнем доверия. Для утверждения **alg** в заголовке задано значение none, так как маркер доступа в вызове для пользователя и надстройки, отправленном надстройкой с высоким уровнем доверия, не подписан. URL-адрес надстройки в значении **aud** из этого примера принадлежит локальному серверу (это нормально для системы с высоким уровнем доверия). Утверждение **identityprovider** отсутствует, но существует утверждение **nii** (поставщик удостоверения имени) с такими же значениями, как в маркерах доступа из утверждения **identityprovider** в системе авторизации с низким уровнем доверия. Сведения об этом значении при использовании поставщика удостоверений на основе SAML вы найдете в статьях [Безопасность в надстройках SharePoint. Часть 8](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-8.aspx) и [Использование надстроек SharePoint с сайтами SAML и FBA в SharePoint 2013](http://blogs.technet.com/b/speschka/archive/2012/12/07/using-sharepoint-apps-with-saml-and-fba-sites-in-sharepoint-2013.aspx) Стива Пешки (Steve Peschka). Утверждение **actor** отсутствует, но существует утверждение **actortoken**, содержащее внутренний маркер в кодировке Base 64, срок действия которого составляет 12 часов.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p120">**Note**   Note that the high-trust access tokens that your code creates are different from those created by Azure ACS when the low-trust authorization system is being used: The **alg** claim in the header is "none" because the access token in a user+add-in call from a high-trust add-in is not signed. The add-in URL in the **aud** value in this example is an on premise server, which is normal for the high-trust system. There is no **identityprovider** claim, but there is a **nii** (name identity issuer) with the same kind of values as the **identityprovider** claim access tokens used in the low-trust authorization system. (For information about this value when the identity provider is SAML-based, see Steve Peschka's blog posts [Security in SharePoint Add-ins - Part 8](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-8.aspx) and [Using SharePoint Add-ins with SAML and FBA Sites in SharePoint 2013](http://blogs.technet.com/b/speschka/archive/2012/12/07/using-sharepoint-apps-with-saml-and-fba-sites-in-sharepoint-2013.aspx).  There is no **actor** claim, but there is an **actortoken** claim that contains a base 64 encoded inner token with a 12 hour lifespan.</span></span>
 

<span data-ttu-id="baf8d-p121">У заголовка есть два свойства. typ это тип маркера. Код удаленного веб-приложения должен всегда устанавливать для него значение JWT. alg это алгоритм, используемый для подписи маркера. Так как внешний маркер в вызове для пользователя и надстройки от надстройки с высоким уровнем доверия не подписан, установите для этого свойства значение none. В таблице 1 представлены сведения о значениях в теле маркера доступа с высоким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p121">The header has two properties. The "typ" is the type of token. Code in the remote web application should always set this value to "JWT". The "alg" is the algorithm used to sign the token. Since the outer token in a user+add-in call from a high-trust add-in is not signed, set this value to "none". See table 1 for information about the values in the body part of the high-trust access token.</span></span>
 

 



```
{"typ":"JWT", "alg":"none"} 
.
{
 "aud":"00000003-0000-0ff1-ce00-000000000000/MarketingServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2",
 "iss":"c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2",
 "nbf":"1403212820",
 "exp":"1403256020",
 "nameid":"s-1-5-21-2127521184-1604012920-1887927527-2963467",
 "nii":"urn:office:idp:activedirectory",
 "actortoken":"6sMZhbw … [remainder of long base 64 string omitted] … "
}

```

<span data-ttu-id="baf8d-p122">В приведенной ниже таблице содержатся сведения о том, какие **свойства ваш код должен включать в маркер доступа и какие значения необходимо задавать для них **. Если вы используете управляемый код, файлы SharePointContext и TokenHelper (с расширением CS или VB) создают маркеры автоматически. Допустим, ваш код один раз вызывает метод **SharePointContext.CreateUserClientContextForSPHost**. Тот, в свою очередь, вызывает методы в классе **TokenHelper**, создающем маркер доступа. Затем маркер доступа включается в каждый вызов к SharePoint от объекта контекста клиента SharePoint, возвращаемого методом **SharePointContext.CreateUserClientContextForSPHost**.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p122">The following table provides some guidance for what  **properties your code should include in the access token and what values to set for them**. If you are using managed code, the SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) files create the tokens for you. For example, you code makes a single call to the **SharePointContext.CreateUserClientContextForSPHost** method. It, in turn, calls methods in the **TokenHelper** class that construct the access token which is then included in every call made to SharePoint by the SharePoint client context object that is returned by **SharePointContext.CreateUserClientContextForSPHost**.</span></span>
 

 

<span data-ttu-id="baf8d-202">**Таблица 1. Утверждения с маркерами доступа, выдаваемыми приложением**</span><span class="sxs-lookup"><span data-stu-id="baf8d-202">**Table 1: App-issued access token claims**</span></span>


|<span data-ttu-id="baf8d-203">**Утверждение**</span><span class="sxs-lookup"><span data-stu-id="baf8d-203">**Claim**</span></span>|<span data-ttu-id="baf8d-204">**Описание**</span><span class="sxs-lookup"><span data-stu-id="baf8d-204">**Description**</span></span>|<span data-ttu-id="baf8d-205">**Соответствующее значение в примере маркера доступа**</span><span class="sxs-lookup"><span data-stu-id="baf8d-205">**Corresponding value in the sample access token**</span></span>|
|:-----|:-----|:-----|
| `aud`|<span data-ttu-id="baf8d-p123">Сокращение от слова audience (аудитория), означающего субъект, для которого предназначен маркер. Используется следующий формат: _идентификатор субъекта аудитории_/ _полное доменное имя SharePoint_@ _область SharePoint_. Для надстроек SharePoint всегда используется субъект аудитории 00000003-0000-0ff1-ce00-000000000000. Надстройки SharePoint с высоким уровнем доверия обычно используются исключительно в локальной среде, поэтому полное доменное имя SharePoint обычно совпадает с именем сервера. _Область SharePoint_ — это GUID локальной фермы SharePoint, для доступа к которой используется маркер (или GUID клиента, если ферма настроена для клиентов). Чтобы определить область SharePoint, выполните командлет PowerShell **Get-SPAuthenticationRealm** на сервере SharePoint. Затем используйте его непосредственно в коде или сохраните в файле конфигурации, где код может его прочитать, например в разделе app.Settings файла web.config. Или же код может динамически обнаруживать область SharePoint во время выполнения, отправляя запрос проверки подлинности в SharePoint. Метод `GetRealmFromTargetUrl` в файле TokenHelper (с расширением CS или VB) представляет собой пример того, как реализовать это с помощью управляемого кода.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p123">Short for "audience", meaning the principal for which the token is intended. The format is  _audience principal ID_/ _fully qualified SharePoint domain_@ _SharePoint realm_.The audience principal for a SharePoint Add-in is always 00000003-0000-0ff1-ce00-000000000000.Since high-trust SharePoint Add-ins are normally used in an entirely on-premise scenario, the fully qualified SharePoint domain name is often just a server name.The  _SharePoint realm_ is the GUID of the on-premise SharePoint farm that the access token is used to access, (or the GUID of the tenancy, if the farm has been configured for tenancies).Find the SharePoint realm by running the PowerShell  **Get-SPAuthenticationRealm** cmdlet on the SharePoint server. Then use it directly in your code or store it in a configuration file where your code can read it, such as the app.Settings section of a web.config file. Alternatively, your code can dynamically discover the SharePoint realm at runtime by sending an authentication challenge to SharePoint. See the `GetRealmFromTargetUrl` method in the TokenHelper.cs (or .vb) file for an example of how this is done in managed code.</span></span>|<span data-ttu-id="baf8d-211">00000003-0000-0ff1-ce00-000000000000/MarketingSharePointServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span><span class="sxs-lookup"><span data-stu-id="baf8d-211">00000003-0000-0ff1-ce00-000000000000/MarketingSharePointServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span></span>|
| `iss`|<span data-ttu-id="baf8d-p124">Сокращение от слова issuer (поставщик). Представляет субъект, который создал маркер. Используется следующий формат: _GUID поставщика_@ _GUID области SharePoint_. В системе с высоким уровнем доверия поставщиком является сама надстройка, поэтому в качестве GUID поставщика обычно используется идентификатор клиента для надстройки SharePoint. *Идентификатор поставщика должен быть целиком в нижнем регистре.*</span><span class="sxs-lookup"><span data-stu-id="baf8d-p124">Short for "issuer". It represents the principal that created the token. The format is  _Issuer GUID_@ _SharePoint realm GUID_.In the high-trust system, the add-in itself is the issuer, so the client ID of the SharePoint Add-in is normally used for the issuer GUID.  *All letters in the issuer ID must be lower case.*</span></span> |<span data-ttu-id="baf8d-216">c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span><span class="sxs-lookup"><span data-stu-id="baf8d-216">c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span></span>|
| `nbf`|<span data-ttu-id="baf8d-p125">Сокращение от "not before" (не ранее). Означает время, с которого маркер  *становится*  допустимым, в секундах, начиная с полуночи 1 января 1970 г. Ваш код должен задать для него время создания маркера.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p125">Short for "not before". It represents the time at which the token  *starts*  being valid, in seconds since midnight, January 1, 1970. Your code should set this to the moment the token is created.</span></span>|<span data-ttu-id="baf8d-220">1403212820</span><span class="sxs-lookup"><span data-stu-id="baf8d-220">1403212820</span></span>|
| `exp`|<span data-ttu-id="baf8d-p126">Сокращение от "expiration" (срок действия). Означает время, когда истекает срок действия маркера, в секундах, после полуночи 1 января 1970 г.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p126">Short for "expiration". It represents the time the token expires, in seconds since midnight, January 1, 1970.</span></span>|<span data-ttu-id="baf8d-223">1403256020</span><span class="sxs-lookup"><span data-stu-id="baf8d-223">1403256020</span></span>|
| `nameid`|<span data-ttu-id="baf8d-p127">Уникальный идентификатор пользователя, которому выдан маркер. Формат зависит от поставщика удостоверения. В данном примере поставщик Active Directory.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p127">A unique identifier for the user for whom the token is issued. The format varies depending on the identity provider. In this example, the provider is Active Directory.</span></span>|<span data-ttu-id="baf8d-227">s-1-5-21-2127521184-1604012920-1887927527-2963467</span><span class="sxs-lookup"><span data-stu-id="baf8d-227">s-1-5-21-2127521184-1604012920-1887927527-2963467</span></span>|
| `nii`|<span data-ttu-id="baf8d-p128">Сокращение от "name identifier issuer" (поставщик идентификатора имени). Уникальное имя поставщика удостоверений, зарегистрированного в управлении по присвоению интернет-номеров (IANA). Для надстроек SharePoint с высоким уровнем доверия обычно указывают локального поставщика удостоверений (в этом примере — Active Directory).</span><span class="sxs-lookup"><span data-stu-id="baf8d-p128">Short for "name identifier issuer." The unique name of the identity provider as registered with the Internet Assigned Numbers Authority (IANA).For a high-trust SharePoint Add-in, it is typically be an on-premise identity provider, such as Active Directory as in this example.</span></span>|<span data-ttu-id="baf8d-230">urn:office:idp:activedirectory</span><span class="sxs-lookup"><span data-stu-id="baf8d-230">urn:office:idp:activedirectory</span></span>|
| `actortoken`|<span data-ttu-id="baf8d-231">Маркер JWT в кодировке Base 64, идентифицирующий надстройку SharePoint и указывающий SharePoint доверять надстройке независимо от того, какой пользователь запускает ее.</span><span class="sxs-lookup"><span data-stu-id="baf8d-231">A base 64-encoded JWT token that identifies the SharePoint Add-in and tells SharePoint to trust the add-in regardless of what user is running the add-in.</span></span>|<span data-ttu-id="baf8d-232">См. ниже.</span><span class="sxs-lookup"><span data-stu-id="baf8d-232">See below.</span></span>|
 <span data-ttu-id="baf8d-p129">**Ниже показан раскодированный **actortoken**.** Представленный в начале небольшой объект заголовка в нотации объектов JavaScript (JSON) содержит метаданные о маркере, включая тип и алгоритм подписания. Свойство **x5t** заголовка — это дайджест, созданный из отпечатка сертификата x.509, который официально является поставщиком маркера. Для создания этого значения коду необходимо выполнить указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p129">**The following shows the decoded  **actortoken**.** The small JavaScript Object Notation (JSON) header object at the top contains metadata about the token, including the type of token and the algorithm that is used to sign it. The **x5t** property of the header is a digest made from the thumbprint of the x.509 certificate that is officially the issuer of the token. To construct this value, your code does the following:</span></span>
 

 

1. <span data-ttu-id="baf8d-p130">Получить отпечаток сертификата в виде массива байтов (не строки). Это дайджест сертификата SHA-1. (В управляемом коде это можно выполнить с помощью метода  [GetCertHash()](http://msdn2.microsoft.com/EN-US/library/4f9acc3f). Вам потребуется его эквивалент в языке, который вы используете.)</span><span class="sxs-lookup"><span data-stu-id="baf8d-p130">Obtain the byte array (not string) version of the thumbprint of the certificate. This is a SHA-1 digest of the certificate. (In managed code, this can be done with the  [GetCertHash()](http://msdn2.microsoft.com/EN-US/library/4f9acc3f) method. You will need something equivalent in the language you are using.)</span></span>
    
 
2. <span data-ttu-id="baf8d-241">Закодировать байтовый массив с помощью кодировки Base 64 для URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="baf8d-241">Encode the byte array with Base 64 URL encoding.</span></span>
    
 
3. <span data-ttu-id="baf8d-242">Указать закодированный дайджест в качестве значения свойства **x5t**.</span><span class="sxs-lookup"><span data-stu-id="baf8d-242">Set the value of the  **x5t** property to the encoded digest.</span></span>
    
 
<span data-ttu-id="baf8d-243">В таблице 2 описываются утверждения, которые код должен включить в основной текст маркера, и значения, которые следует для них задать.</span><span class="sxs-lookup"><span data-stu-id="baf8d-243">Table 2 describes the claims your code must include in the body of the token and the values to set for them.</span></span>
 

 



```
{"typ":"JWT","alg":"RS256","x5t":"7MjK99QvkVdwz6UrKldx8AG7ydM"}
.
{
 "aud":"00000003-0000-0ff1-ce00-000000000000/MarketingServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2",
 "iss":"11111111-1111-1111-1111-111111111111@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2",
 "nbf":"1403212820",
 "exp":"1403256020",
 "nameid":"c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2",
 "trustedfordelegation":"true"
}

```


 <span data-ttu-id="baf8d-p131">**Примечание** Если надстройка с высоким уровнем доверия использует [политику только для надстройки](add-in-authorization-policy-types-in-sharepoint.md) и отправляет в SharePoint вызов только для надстройки, то показанный здесь маркер фактически является маркером доступа. Внешнего маркера не существует. Более того, отсутствует утверждение **trustedfordelegation**, так как разрешения пользователя не имеют значения в вызове только для надстройки.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p131">**Note**  If the high-trust add-in is using the  [add-in-only policy](add-in-authorization-policy-types-in-sharepoint.md) and it makes an add-in-only call to SharePoint, then the token shown here is actually the access token. There is no outer token. Moreover, there is no **trustedfordelegation** claim, since the user's permissions are irrelevant for an add-in-only call.</span></span>
 


<span data-ttu-id="baf8d-247">**Таблица 2. Утверждения actortoken, выданные сертификатом**</span><span class="sxs-lookup"><span data-stu-id="baf8d-247">**Table 2: Certificate-issued actortoken claims**</span></span>


|<span data-ttu-id="baf8d-248">**Утверждение**</span><span class="sxs-lookup"><span data-stu-id="baf8d-248">**Claim**</span></span>|<span data-ttu-id="baf8d-249">**Описание**</span><span class="sxs-lookup"><span data-stu-id="baf8d-249">**Description**</span></span>|<span data-ttu-id="baf8d-250">**Соответствующее значение в примере маркера доступа**</span><span class="sxs-lookup"><span data-stu-id="baf8d-250">**Corresponding value in the sample access token**</span></span>|
|:-----|:-----|:-----|
| `aud`|<span data-ttu-id="baf8d-251">Аналогично родительскому маркеру доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-251">Same as in the parent access token.</span></span>|<span data-ttu-id="baf8d-252">00000003-0000-0ff1-ce00-000000000000/MarketingSharePointServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span><span class="sxs-lookup"><span data-stu-id="baf8d-252">00000003-0000-0ff1-ce00-000000000000/MarketingSharePointServer@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span></span>|
| `iss`|<span data-ttu-id="baf8d-p132">То же значение, что и в родительском маркере доступа, но GUID поставщика не является идентификатором клиента для веб-приложения. Это GUID сертификата. Код приложения создает маркер субъекта, но поставщиком этого маркера считается сертификат. Обратите внимание, что GUID поставщика в этом примере представляет собой легко запоминаемую строку GUID, которую администратор фермы использовал при регистрации сертификата x.509 в качестве доверенного поставщика маркеров в SharePoint. Это часто происходит, если один и тот же сертификат используется в качестве поставщика маркеров субъекта для всех надстроек SharePoint с высоким уровнем доступа в ферме. Администратор также может использовать отдельный сертификат для каждой надстройки SharePoint. В этом случае для сертификатов используются разные случайно сгенерированные идентификаторы GUID. *GUID поставщика должен быть целиком в нижнем регистре.*</span><span class="sxs-lookup"><span data-stu-id="baf8d-p132">Same meaning as in the parent access token, but the issuer GUID is not the client ID of the web application. It is the GUID of the certificate. Although code in the application constructs the actor token, the certificate is considered the issuer of the actor token.Note that the issuer GUID in this example is an easy-to-remember GUID string that the farm administrator used when she registered the x.509 certificate as a trusted token issuer in SharePoint. This is common when the same certificate is used as the actor token issuer for all high-trust SharePoint Add-ins on the farm. An administrator can also choose to have distinct certificates for each SharePoint Add-in. In that case, she would use different randomly generated GUIDs for the certificates.  *All letters in the issuer GUID must be lower case.*</span></span> |<span data-ttu-id="baf8d-260">11111111-1111-1111-1111-111111111111@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span><span class="sxs-lookup"><span data-stu-id="baf8d-260">11111111-1111-1111-1111-111111111111@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span></span>|
| `nbf`|<span data-ttu-id="baf8d-261">Такое же значение, как и в родительском маркере доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-261">Same meaning as in the parent access token.</span></span>|<span data-ttu-id="baf8d-262">Такое же значение, как и в родительском маркере доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-262">Same value as the parent access token.</span></span>|
| `exp`|<span data-ttu-id="baf8d-263">Такое же значение, как и в родительском маркере доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-263">Same meaning as in the parent access token.</span></span>|<span data-ttu-id="baf8d-264">Такое же значение, как и в родительском маркере доступа.</span><span class="sxs-lookup"><span data-stu-id="baf8d-264">Same value as the parent access token.</span></span>|
| `nameid`|<span data-ttu-id="baf8d-p133">Уникальный идентификатор надстройки SharePoint, являющейся "субъектом" в системе с высоким уровнем доверия. Используется следующий формат: _ИД_клиента_@ _область_SharePoint_</span><span class="sxs-lookup"><span data-stu-id="baf8d-p133">A unique identifier for the SharePoint Add-in, because it is the "actor" in the high-trust system. The format is  _client_ID_@ _SharePoint_realm_</span></span>|<span data-ttu-id="baf8d-267">c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span><span class="sxs-lookup"><span data-stu-id="baf8d-267">c3ab8885-458f-4864-8804-1608145e2ac4@52aa6841-b76b-4ed4-a3d7-a259fce1dfa2</span></span>|
| `trustedfordelegation`|<span data-ttu-id="baf8d-p134">Логическое значение, указывающее, должна ли среда SharePoint разрешить надстройке SharePoint выполнить проверку подлинности пользователя и авторизовать его. Как правило, в системе с высоким уровнем доверия это значение равно True. Не включайте это утверждение в вызов только для надстройки в системе с высоким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p134">A Boolean value that specifies whether SharePoint should trust the SharePoint Add-in to authenticate and authorize the user. This is normally true in the high-trust system.Do not include this claim in an add-in-only call in the high-trust system.</span></span>|<span data-ttu-id="baf8d-270">true</span><span class="sxs-lookup"><span data-stu-id="baf8d-270">true</span></span>|

## <a name="encode-and-sign-tokens"></a><span data-ttu-id="baf8d-271">Кодирование и подпись маркеров</span><span class="sxs-lookup"><span data-stu-id="baf8d-271">Encode and sign tokens</span></span>
<span data-ttu-id="baf8d-272"><a name="EncodeTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-272"></span></span>

 <span data-ttu-id="baf8d-p135">**После того как код добавил все свойства и значения в заголовок и тело объектов JSON, он должен закодировать и объединить их в JWT, а затем подписать.** Ниже описаны шаги этого процесса.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p135">**After your code has added all the properties and values to the header and body JSON objects, it has to encode them, combine them into a JWT, and sign it.** The following are the steps.</span></span>
 

 

1. <span data-ttu-id="baf8d-275">Закодировать заголовок с помощью кодировки URL-адреса Base 64.</span><span class="sxs-lookup"><span data-stu-id="baf8d-275">Encode the header with Base 64 URL encoding.</span></span>
    
 
2. <span data-ttu-id="baf8d-276">Закодировать полезную нагрузку с помощью кодировки URL-адреса Base 64.</span><span class="sxs-lookup"><span data-stu-id="baf8d-276">Encode the payload with Base 64 URL encoding.</span></span>
    
 
3. <span data-ttu-id="baf8d-p136">Объединить закодированное тело после закодированного заголовка, указав между ними символ ".". Это JWT.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p136">Concatenate the encoded body after the encoded header with a "." character in between them. This is the JWT.</span></span>
    
 
4. <span data-ttu-id="baf8d-279">Объединить подпись SHA256 с использованием JWT и закрытый ключ сертификата.</span><span class="sxs-lookup"><span data-stu-id="baf8d-279">Create a SHA256 signature using the JWT and the private key of the certificate.</span></span>
    
 
5. <span data-ttu-id="baf8d-280">Закодировать подпись с помощью кодировки URL-адреса Base 64.</span><span class="sxs-lookup"><span data-stu-id="baf8d-280">Encode the signature with Base 64 URL encoding.</span></span>
    
 
6. <span data-ttu-id="baf8d-281">Добавить подпись в конце JWT, добавив символ "." между этими двумя частями.</span><span class="sxs-lookup"><span data-stu-id="baf8d-281">Append the signature to the end of the JWT, with a "." character between them.</span></span> 
    
 
<span data-ttu-id="baf8d-p137">Для маркера субъекта, используемого в вызове только для надстройки, маркер субъекта служит маркером доступа. Внешнего маркера нет. Для маркера доступа, используемого в вызове для пользователя и надстройки, на предыдущих этапах можно создать маркер субъекта, который затем вставляется в текст маркера доступа в качестве значения свойства **actortoken**. Полный маркер доступа затем кодируется и создается с помощью первых трех этапов, но он по-прежнему не подписан, поэтому остальные этапы не применяются для внешнего маркера.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p137">For an actor token that is used with an add-in-only call, the actor token serves as the access token. There is no outer token. For an access token that is used with a user+add-in call, the preceding steps are used to construct an actor token which is then inserted into the body of an access token as the value of the  **actortoken** property. The full access token is then encoded and constructed with the first three steps above, but it is not signed, so the remaining steps are not used for the outer token.</span></span>
 

 

## <a name="troubleshoot-access-tokens"></a><span data-ttu-id="baf8d-286">Устранение неполадок, связанных с маркерами доступа</span><span class="sxs-lookup"><span data-stu-id="baf8d-286">Troubleshoot access tokens</span></span>
<span data-ttu-id="baf8d-287"><a name="Trouble"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-287"></span></span>

<span data-ttu-id="baf8d-p138">HTTP-запросы, которые удаленный компонент надстройки отправляет в SharePoint, можно перехватывать с помощью бесплатного  [средства Fiddler](http://www.telerik.com/fiddler). Для него также есть  [бесплатное расширение](https://github.com/andrewconnell/SPOAuthFiddlerExt), которое автоматически декодирует маркеры в запросах.</span><span class="sxs-lookup"><span data-stu-id="baf8d-p138">The free  [Fiddler tool](http://www.telerik.com/fiddler) can be used to capture the HTTP Requests sent by the remote component of your add-in to SharePoint. There is a [free extension to the tool](https://github.com/andrewconnell/SPOAuthFiddlerExt) that automatically decodes the tokens in the requests.</span></span>
 

 

## <a name="additional-resources"></a><span data-ttu-id="baf8d-290">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="baf8d-290">Additional resources</span></span>
<span data-ttu-id="baf8d-291"><a name="bk_addresources"> </a></span><span class="sxs-lookup"><span data-stu-id="baf8d-291"></span></span>


-  [<span data-ttu-id="baf8d-292">Создание надстроек для SharePoint, которые используют авторизацию с высоким уровнем доверия</span><span class="sxs-lookup"><span data-stu-id="baf8d-292">Creating SharePoint Add-ins that use high-trust authorization</span></span>](creating-sharepoint-add-ins-that-use-high-trust-authorization.md)
    
 
- <span data-ttu-id="baf8d-293">Запись блога Стива Пешки (Steve Peschka)  [Безопасность в надстройках SharePoint часть 7](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-7.aspx)</span><span class="sxs-lookup"><span data-stu-id="baf8d-293">Steve Peschka's  [Security in SharePoint Add-ins - Part 7](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-7.aspx)</span></span>
    
 
- <span data-ttu-id="baf8d-294">Запись блога Стива Пешки (Steve Peschka)  [Безопасность в надстройках SharePoint часть 8](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-8.aspx)</span><span class="sxs-lookup"><span data-stu-id="baf8d-294">Steve Peschka's  [Security in SharePoint Add-ins - Part 8](http://blogs.technet.com/b/speschka/archive/2013/08/01/security-in-sharepoint-apps-part-8.aspx)</span></span>
    
 
- <span data-ttu-id="baf8d-295">Запись блога Стива Пешки (Steve Peschka)  [Использование надстроек SharePoint с сайтами SAML и FBA в SharePoint 2013](http://blogs.technet.com/b/speschka/archive/2012/12/07/using-sharepoint-apps-with-saml-and-fba-sites-in-sharepoint-2013.aspx)</span><span class="sxs-lookup"><span data-stu-id="baf8d-295">Steve Pescka's  [Using SharePoint Add-ins with SAML and FBA Sites in SharePoint 2013](http://blogs.technet.com/b/speschka/archive/2012/12/07/using-sharepoint-apps-with-saml-and-fba-sites-in-sharepoint-2013.aspx)</span></span>
    
 
- <span data-ttu-id="baf8d-296">Запись блога Кирка Ивана (Kirk Evan)  [Надстройки SharePoint с высоким уровнем доверия на платформах, отличных от платформ Майкрософт](http://blogs.msdn.com/b/kaevans/archive/2014/07/14/high-trust-sharepoint-apps-on-non-microsoft-platforms.aspx)</span><span class="sxs-lookup"><span data-stu-id="baf8d-296">Kirk Evan's  [High Trust SharePoint Add-ins on Non-Microsoft Platforms](http://blogs.msdn.com/b/kaevans/archive/2014/07/14/high-trust-sharepoint-apps-on-non-microsoft-platforms.aspx)</span></span>
    
 
-  [<span data-ttu-id="baf8d-297">OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="baf8d-297">OAuth 2.0</span></span>](http://oauth.net/2/)
    
 
