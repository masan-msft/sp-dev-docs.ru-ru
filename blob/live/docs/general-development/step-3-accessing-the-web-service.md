---
title: "Этап 3. Получение доступа к веб-службе"
ms.date: 09/25/2017
ms.prod: sharepoint
ms.assetid: d27f654d-242f-4f34-8385-be857c170532
ms.openlocfilehash: be159956d3799a2c9dac2d3aef309a178889f494
ms.sourcegitcommit: 1cae27d85ee691d976e2c085986466de088f526c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2017
---
# <a name="step-3-accessing-the-web-service"></a><span data-ttu-id="16a86-102">Этап 3. Получение доступа к веб-службе</span><span class="sxs-lookup"><span data-stu-id="16a86-102">Step 3: Accessing the Web Service</span></span>

<span data-ttu-id="16a86-p101">Следующим этапом после добавления ссылки на веб-службы Веб-службы Excel в проект является создание экземпляра прокси-класса веб-службы. Затем можно будет получить доступ к методам веб-службы путем вызова методов в прокси-классе. Когда приложение вызывает эти методы, код прокси-класса созданный Visual Studio, обрабатывает обмен данными между приложением и веб-службой.</span><span class="sxs-lookup"><span data-stu-id="16a86-p101">After you have added a reference to Excel Web Services to your project, the next step is to create an instance of the Web service's proxy class. You can then access the methods of the Web service by calling the methods in the proxy class. When your application calls these methods, the proxy class code generated by Visual Studio handles the communications between your application and the Web service.</span></span> 
  
    
    

<span data-ttu-id="16a86-p102">Сначала требуется создать экземпляр прокси-класса веб-службы ExcelWebService. Затем с помощью прокси-класса выполняется вызов различных методов и свойств веб-службы. Такие вызовы используются для открытия книги, получения кода сеанса, предъявления стандартных учетных данных, определения объекта координат диапазона, получения диапазона, использующего объект координат диапазона, закрытия книги и перехвата исключений SOAP.</span><span class="sxs-lookup"><span data-stu-id="16a86-p102">First you create an instance of the Web service's proxy class, ExcelWebService. Next you call several of the Web service's methods and properties using the proxy class. You use the calls to open a workbook, get the session ID, pass in the default credentials, define the range coordinate object, get the range that uses the range coordinate object, close the workbook, and catch the SOAP exceptions.</span></span>
  
    
    


## <a name="accessing-the-web-service"></a><span data-ttu-id="16a86-109">Получение доступа к веб-службе</span><span class="sxs-lookup"><span data-stu-id="16a86-109">Accessing the Web Service</span></span>


### <a name="to-add-directives"></a><span data-ttu-id="16a86-110">Добавление директив</span><span class="sxs-lookup"><span data-stu-id="16a86-110">To add directives</span></span>


1. <span data-ttu-id="16a86-111">При добавлении веб-ссылки в более ранних версий он создан объект с именем ExcelService в пространство имен с именем <yourProject>. <webReferenceName>.</span><span class="sxs-lookup"><span data-stu-id="16a86-111">When you added the Web reference earlier, it created an object named ExcelService in a namespace called <yourProject>.<webReferenceName>.</span></span> <span data-ttu-id="16a86-112">В этом примере объект с именем SampleApplication.ExcelWebService.</span><span class="sxs-lookup"><span data-stu-id="16a86-112">In this example, the object is named SampleApplication.ExcelWebService.</span></span> <span data-ttu-id="16a86-113">В этом пошаговом руководстве также показано, как для перехвата исключений SOAP.</span><span class="sxs-lookup"><span data-stu-id="16a86-113">This walkthrough also shows how to catch SOAP exceptions.</span></span> <span data-ttu-id="16a86-114">Чтобы сделать это, используйте объект **System.Web.Services.Protocols** .</span><span class="sxs-lookup"><span data-stu-id="16a86-114">To do so, you use the **System.Web.Services.Protocols** object.</span></span> <span data-ttu-id="16a86-115">Пространство имен **System.Web.Services.Protocols** состоит из классов, определяющих протоколы, используемые для передачи данных по сети между клиентами веб-службы и веб-служб XML с помощью ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="16a86-115">The **System.Web.Services.Protocols** namespace consists of the classes that define the protocols used to transmit data across the wire during the communication between XML Web service clients and XML Web services created using ASP.NET.</span></span>
  
    
    
<span data-ttu-id="16a86-p104">Для упрощения использования этих объектов необходимо сначала добавить пространства имен в качестве директив в файл Class1.cs. В этом случае при использовании таких директив не требуется указывать полные имена типов в пространстве имен.</span><span class="sxs-lookup"><span data-stu-id="16a86-p104">To facilitate using these objects, you must first add the namespaces as directives to the Class1.cs file. This way, if you use these directives, you do not need to fully qualify the types in the namespace.</span></span> 
    
  
2. <span data-ttu-id="16a86-118">Для добавления таких директив добавьте следующий код в начало собственного кода в файле Class1.cs после элемента  `using System:`</span><span class="sxs-lookup"><span data-stu-id="16a86-118">To add these directives, add the following code to the beginning of your code in the Class1.cs file, after  `using System:`</span></span>
    
```cs
  
using SampleApplication.ExcelWebService;
using System.Web.Services.Protocols;
```


```VB.net
  
Imports SampleApplication.ExcelWebService
Imports System.Web.Services.Protocols
```


### <a name="to-call-the-web-service"></a><span data-ttu-id="16a86-119">Вызов веб-службы</span><span class="sxs-lookup"><span data-stu-id="16a86-119">To call the Web service</span></span>


1. <span data-ttu-id="16a86-120">Выполните создание экземпляра и инициализацию прокси-объекта веб-службы путем добавления следующего кода после открывающей скобки в строке  `static void Main(string[] args)`:</span><span class="sxs-lookup"><span data-stu-id="16a86-120">Instantiate and initialize the Web service proxy object by adding the following code after the opening bracket in  `static void Main(string[] args)`:</span></span>
    
```cs
  
ExcelService es = new ExcelService();
```


```VB.net
  Dim es As New ExcelService()
```

2. <span data-ttu-id="16a86-121">Для создания массива состояний и объектов координат диапазона добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="16a86-121">Add the following code to create a status array and range coordinate objects:</span></span>
    
```cs
  Status[] outStatus;
RangeCoordinates rangeCoordinates = new RangeCoordinates();
```


```VB.net
  
Dim outStatus() As Status
Dim rangeCoordinates As New RangeCoordinates()
```

3. <span data-ttu-id="16a86-p105">Добавьте код, чтобы указать лист, к которому требуется получить доступ. В этом примере лист называется Sheet1. Добавьте в свой код следующее:</span><span class="sxs-lookup"><span data-stu-id="16a86-p105">Add the code to point to the worksheet you want to access. In this example, the worksheet is called "Sheet1". Add the following to your code:</span></span> 
    
```cs
  
string sheetName = "Sheet1";
```


```VB.net
  Dim sheetName As String = "Sheet1"
```


    > **Note:**
      > Make sure the workbook you want to open has a worksheet called "Sheet1" that contains values. Alternatively, you can change "Sheet1" in the code to the name of your worksheet. 
4.  <span data-ttu-id="16a86-125">`Add the following code to point to the workbook you want to open`:</span><span class="sxs-lookup"><span data-stu-id="16a86-125"></span></span>
    
```cs
  string targetWorkbookPath = "http://myserver02/example/Shared%20Documents/Book1.xlsx";
```


```VB.net
  Dim targetWorkbookPath As String = "http://myserver02/example/Shared%20Documents/Book1.xlsx"
```


    > **Important:**
      > Change the workbook path to match the location of the workbook you are using for this walkthrough. Make sure the workbook exists and that the location where the workbook is saved is a trusted location. Using an HTTP URL to point to the location of a workbook allows you to access it remotely. 

    > **Note:**
      > You can get the path to a workbook in Microsoft SharePoint Server 2010 by right-clicking the workbook and selecting **Copy Shortcut**. Alternatively, you can select **Properties** and copy the path to the workbook from there.
5. <span data-ttu-id="16a86-126">Добавьте следующий код, чтобы указать учетные данные для запроса.</span><span class="sxs-lookup"><span data-stu-id="16a86-126">Add the following code to set the credentials for the request.</span></span> 
    
    > <span data-ttu-id="16a86-127">**Примечание:** Необходимо явно задать учетные данные, даже в том случае, если вы намерены использовать учетные данные по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="16a86-127">**Note:** You have to explicitly set the credentials even if you intend to use the default credentials.</span></span> 

```cs
  es.Credentials = System.Net.CredentialCache.DefaultCredentials;
```


```VB.net
  es.Credentials = System.Net.CredentialCache.DefaultCredentials
```

6. <span data-ttu-id="16a86-p106">Добавьте следующий код, чтобы открыть книгу и указать надежное расположение, где размещается эта книга. Поместите код в блок **try**:</span><span class="sxs-lookup"><span data-stu-id="16a86-p106">Add the following code to open the workbook and point to the trusted location where the workbook is located. Place the code in a **try** block:</span></span>
    
```cs
  try
{
string sessionId = es.OpenWorkbook(targetWorkbookPath, "en-US", 
    "en-US", out outStatus);
```


```VB.net
  
Try
Dim sessionId As String = es.OpenWorkbook(targetWorkbookPath, "en-US", "en-US", outStatus)
```

7. <span data-ttu-id="16a86-p107">Добавьте следующий код, чтобы подготовить объект для определения координат диапазона и вызвать метод **GetRange**. Код также выполнит печать общего количества строк в диапазоне и значений в конкретном диапазоне.</span><span class="sxs-lookup"><span data-stu-id="16a86-p107">Add the following code to prepare an object to define range coordinates, and call the **GetRange** method. The code will also print the total number of rows in the range and the value in a particular range.</span></span>
    
```cs
  
rangeCoordinates.Column = 3;
rangeCoordinates.Row = 9;
rangeCoordinates.Height = 18;
rangeCoordinates.Width = 12;

object[] rangeResult1 = es.GetRange(sessionId, sheetName,
    rangeCoordinates, false, out outStatus);
Console.WriteLine("Total rows in range: " + rangeResult1.Length);
Console.WriteLine("Value in range is: " + ((object[])rangeResult1[5])[2]);
```


```VB.net
  
rangeCoordinates.Column = 3
rangeCoordinates.Row = 9
rangeCoordinates.Height = 18
rangeCoordinates.Width = 12

Dim rangeResult1() As Object = es.GetRange(sessionId, sheetName, rangeCoordinates, False, outStatus)
Console.WriteLine("Total rows in range: " &amp; rangeResult1.Length)
Console.WriteLine("Value in range is: " &amp; (CType(rangeResult1(5), Object()))(2))
```

8. <span data-ttu-id="16a86-p108">Добавьте код, чтобы закрыть рабочую книгу и завершить текущий сеанс. Затем добавьте закрывающую скобку в конце блока **try**.</span><span class="sxs-lookup"><span data-stu-id="16a86-p108">Add code to close the workbook and close the current session. Also add a close bracket to end the **try** block.</span></span>
    
    > <span data-ttu-id="16a86-134">**Важные:** Рекомендуется закрыть книгу, если вы выполнили к сеансу.</span><span class="sxs-lookup"><span data-stu-id="16a86-134">**Important:** It is good practice to close the workbook if you are done using the session.</span></span> <span data-ttu-id="16a86-135">Это приведет к закрытию сеанса и освобождения ресурсов.</span><span class="sxs-lookup"><span data-stu-id="16a86-135">This will close the session and free resources.</span></span> 

```cs
  
es.CloseWorkbook(sessionId);
}
```


```VB.net
  
es.CloseWorkbook(sessionId)
```

9. <span data-ttu-id="16a86-136">Добавьте блок **catch** для перехвата исключений SOAP и печати сообщения об исключении:</span><span class="sxs-lookup"><span data-stu-id="16a86-136">Add a **catch** block to catch the SOAP exception and print the exception message:</span></span>
    
```cs
  catch (SoapException e)
{
    Console.WriteLine("SOAP Exception Message: {0}", e.Message);
}
```


```VB.net
  
Catch e As SoapException
    Console.WriteLine("SOAP Exception Message: {0}", e.Message)
End Try
```


## <a name="complete-code"></a><span data-ttu-id="16a86-137">Полный пример кода</span><span class="sxs-lookup"><span data-stu-id="16a86-137">Complete Code</span></span>

<span data-ttu-id="16a86-138">Приведенный ниже пример кода представляет собой полный фрагмент кода в файле примера Class1.cs, который описывается выше.</span><span class="sxs-lookup"><span data-stu-id="16a86-138">The following code sample is the complete code in the Class1.cs example file described in the previous procedures.</span></span>
  
    
    

> <span data-ttu-id="16a86-139">**Важные:** Вносить изменения в путь к книге, имя листа и т. д соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="16a86-139">**Important:** Make changes to the workbook path, sheet name, and so on, as appropriate.</span></span> 
  
    
    


```cs

using System;
using SampleApplication.ExcelWebService;
using System.Web.Services.Protocols;

namespace SampleApplication
{
    class Class1
    {
        [STAThread]
        static void Main(string[] args)
        {            
            // Instantiate the Web service and create a status array object and range coordinate object
            ExcelService es = new ExcelService();
            Status[] outStatus;
            RangeCoordinates rangeCoordinates = new RangeCoordinates();
            
string sheetName = "Sheet1";
            // Using workbookPath this way will allow 
            // you to call the workbook remotely.
            // TODO: change the workbook path to 
            // point to workbook in a trusted location
            // that you have access to 
            string targetWorkbookPath = "http://myserver02/example/Shared%20Documents/Book1.xlsx";
//you can also use .xlsb files, for example, //"http://myserver02/example/Shared%20Documents/Book1.xlsb";

            // Set credentials for requests
            es.Credentials = System.Net.CredentialCache.DefaultCredentials;
            //Console.WriteLine("Cred: {0}", es.Credentials);
            try
            {
                // Call open workbook, and point to the trusted   
                // location of the workbook to open.
                string sessionId = es.OpenWorkbook(targetWorkbookPath, "en-US", "en-US", out outStatus);
                // Console.WriteLine("sessionID : {0}", sessionId);

                // Prepare object to define range coordinates
                // and the GetRange method.
                rangeCoordinates.Column = 3;
                rangeCoordinates.Row = 9;
                rangeCoordinates.Height = 18;
                rangeCoordinates.Width = 12;

                object[] rangeResult1 = es.GetRange(sessionId, sheetName, rangeCoordinates, false, out outStatus);
                Console.WriteLine("Total Rows in Range: " + rangeResult1.Length);
                Console.WriteLine("Value in range is: " + ((object[])rangeResult1[5])[3]); 
        
                // Close workbook. This also closes session.
                es.CloseWorkbook(sessionId);
            }
            catch (SoapException e)
            {
                Console.WriteLine("SOAP Exception Message: {0}", e.Message);
            }
            // catch (Exception e)
//            {
//                Console.WriteLine("Exception Message: {0}", e.Message);
//            }
//            Console.ReadLine();
        }
    }
}
     
```


```VB.net

Imports System
Imports SampleApplication.ExcelWebService
Imports System.Web.Services.Protocols

Namespace SampleApplication
    Friend Class Class1
        <STAThread> _
        Shared Sub Main(ByVal args() As String)
            ' Instantiate the Web service and create a status array object and range coordinate object
            Dim es As New ExcelService()
            Dim outStatus() As Status
            Dim rangeCoordinates As New RangeCoordinates()

Dim sheetName As String = "Sheet1"
            ' Using workbookPath this way will allow 
            ' you to call the workbook remotely.
            ' TODO: change the workbook path to 
            ' point to workbook in a trusted location
            ' that you have access to 
            Dim targetWorkbookPath As String = "http://myserver02/example/Shared%20Documents/Book1.xlsx"
'you can also use .xlsb files, for example, //"http://myserver02/example/Shared%20Documents/Book1.xlsb";

            ' Set credentials for requests
            es.Credentials = System.Net.CredentialCache.DefaultCredentials
            'Console.WriteLine("Cred: {0}", es.Credentials);
            Try
                ' Call open workbook, and point to the trusted   
                ' location of the workbook to open.
                Dim sessionId As String = es.OpenWorkbook(targetWorkbookPath, "en-US", "en-US", outStatus)
                ' Console.WriteLine("sessionID : {0}", sessionId)

                ' Prepare object to define range coordinates
                ' and the GetRange method.
                rangeCoordinates.Column = 3
                rangeCoordinates.Row = 9
                rangeCoordinates.Height = 18
                rangeCoordinates.Width = 12

                Dim rangeResult1() As Object = es.GetRange(sessionId, sheetName, rangeCoordinates, False, outStatus)
                Console.WriteLine("Total Rows in Range: " &amp; rangeResult1.Length)
                Console.WriteLine("Value in range is: " &amp; (CType(rangeResult1(5), Object()))(3))

                ' Close workbook. This also closes session.
                es.CloseWorkbook(sessionId)
            Catch e As SoapException
                Console.WriteLine("SOAP Exception Message: {0}", e.Message)
            ' Catch e As Exception
            '    Console.WriteLine("Exception Message: {0}", e.Message)
            End Try
            'Console.ReadLine()
        End Sub
    End Class
End Namespace
```


## <a name="see-also"></a><span data-ttu-id="16a86-140">См. также</span><span class="sxs-lookup"><span data-stu-id="16a86-140">See also</span></span>


#### <a name="concepts"></a><span data-ttu-id="16a86-141">Понятия</span><span class="sxs-lookup"><span data-stu-id="16a86-141">Concepts</span></span>


  
    
    
 [<span data-ttu-id="16a86-142">Доступ к API SOAP</span><span class="sxs-lookup"><span data-stu-id="16a86-142">Accessing the SOAP API</span></span>](accessing-the-soap-api.md)
#### <a name="other-resources"></a><span data-ttu-id="16a86-143">Другие ресурсы</span><span class="sxs-lookup"><span data-stu-id="16a86-143">Other resources</span></span>


  
    
    
 [<span data-ttu-id="16a86-144">Шаг 1. Создание проекта клиента веб-службы</span><span class="sxs-lookup"><span data-stu-id="16a86-144">Step 1: Creating the Web Service Client Project</span></span>](step-1-creating-the-web-service-client-project.md)
  
    
    
 [<span data-ttu-id="16a86-145">Этап 2. Добавление веб-ссылки</span><span class="sxs-lookup"><span data-stu-id="16a86-145">Step 2: Adding a Web Reference</span></span>](step-2-adding-a-web-reference.md)
  
    
    
 [<span data-ttu-id="16a86-146">Этап 4. Построение и тестирование приложения</span><span class="sxs-lookup"><span data-stu-id="16a86-146">Step 4: Building and Testing the Application</span></span>](step-4-building-and-testing-the-application.md)
  
    
    
 [<span data-ttu-id="16a86-147">Пошаговое руководство. Разработка настраиваемого приложения с помощью веб-служб Excel</span><span class="sxs-lookup"><span data-stu-id="16a86-147">Walkthrough: Developing a Custom Application Using Excel Web Services</span></span>](walkthrough-developing-a-custom-application-using-excel-web-services.md)
  
    
    
 [<span data-ttu-id="16a86-148">How to: Trust Workbook Locations Using Script</span><span class="sxs-lookup"><span data-stu-id="16a86-148">How to: Trust Workbook Locations Using Script</span></span>](http://msdn.microsoft.com/library/79ab6ced-7a0c-4275-b852-bb246fc6be57%28Office.15%29.aspx)
