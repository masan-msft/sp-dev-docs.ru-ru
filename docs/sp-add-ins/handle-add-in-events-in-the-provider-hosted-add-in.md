# <a name="handle-add-in-events-in-the-provider-hosted-add-in"></a>Обработка событий надстройки, размещенной у поставщика
Узнайте, как настроить установку надстройки SharePoint, размещаемой у поставщика.
 

 **Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint#bk_newname).
 

Это седьмая часть серии статей, посвященной основам разработки надстроек SharePoint, размещаемых у поставщика. Для начала вам следует ознакомиться со статьей [Надстройки SharePoint](sharepoint-add-ins) и предыдущими статьями из этой серии.
 

-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins)
    
 
-  [Настройка внешнего вида надстройки SharePoint, размещенной у поставщика](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel)
    
 
-  [Добавление настраиваемой кнопки в надстройку, размещенную у поставщика](include-a-custom-button-in-the-provider-hosted-add-in)
    
 
-  [Краткий обзор объектной модели SharePoint](get-a-quick-overview-of-the-sharepoint-object-model)
    
 
-  [Добавление операций записи SharePoint в надстройку, размещенную у поставщика](add-sharepoint-write-operations-to-the-provider-hosted-add-in)
    
 
-  [Добавление веб-части надстройки в надстройку, размещенную у поставщика](include-an-add-in-part-in-the-provider-hosted-add-in)
    
 

 **Примечание.** Если вы изучали предыдущие статьи этой серии о надстройках, размещаемых у поставщика, то у вас уже есть решение для Visual Studio, которое можно использовать для работы с данной статьей. Кроме того, вы можете скачать репозиторий [SharePoint_Provider-hosted_Add-Ins_Tutorials](https://github.com/OfficeDev/SharePoint_Provider-hosted_Add-ins_Tutorials) и открыть файл BeforeAdd-inEventHandlers.sln.
 

В данной статье мы настроим в SharePoint обработку событий, называемых событиями надстройки. Точнее мы создадим обработчики событий установки и удаления надстройки. Кроме того, настраиваемые обработчики можно использовать и для событий списка и элементов списка. О таких обработчиках вы узнаете в одной из следующих статей этой серии. Все эти события создаются в SharePoint, но пользовательский код, обрабатывающий каждое событие, находится в вашем удаленном веб-приложении. Вы настроите SharePoint, чтобы он вызывал настраиваемый обработчик, зарегистрировав URL-адрес обработчика для события SharePoint.
 

## <a name="two-places-to-programmatically-deploy-sharepoint-components"></a>Два способа развертывания компонентов SharePoint программным путем

Мы хотим, чтобы наша надстройка "Сеть магазинов" автоматически создавала и развертывала списки **Местные сотрудники** и **Ожидаемые отгрузки**. Надстройка может в любое время развертывать компоненты SharePoint, например настраиваемые списки. Однако если надстройка зависит от определенного компонента, например настраиваемого списка, этот компонент необходимо развернуть *до того*, как пользователи начнут работать с надстройкой. Для таких критически важных компонентов пользовательский код, выполняющий развертывание, можно разместить в двух местах:
 

 

- в обработчике события установки для надстройки;
    
 
- в коде, выполняемом при первом запуске надстройки в SharePoint.
    
 
Описание процесса принятия решения о том, какой способ лучше подходит для конкретной надстройки, выходит за рамки данной статьи. В нашей статье мы приведем только несколько соображений, оказывающих влияние на выбор.
 

 

- Работа пользовательского обработчика установки должна завершиться в течение 30 секунд. Время работы логики первого запуска не ограничено.
    
 
- Если в процессе установки надстройки что-то пойдет не так, SharePoint отменит все действия, которые он выполнил в ходе установки. Настраиваемый обработчик события установки запускается  *после*  того как SharePoint выполнит все действия, необходимые для установки надстройки, поэтому обработчик может принять участие в работе этой системы. Например, если ваш пользовательский код создал исключение, вы можете сообщить SharePoint, что необходимо полностью отменить установку надстройки. Если же что-то пойдет не так в пользовательском коде, выполняемом при первом запуске, надстройка останется установленной и, возможно, будет работать неправильно.
    
 
- Если SharePoint придется отменить установку надстройки, он не "успокоится" на этом. Он сразу же попытается установить надстройку еще раз. Он совершает до 4 попыток (на каждую попытку выделяется 30 секунд). При каждой повторной попытке настраиваемый обработчик события установки запускается  *с самого начала*  . Если обработчик установил, например, список, прежде чем были отменены все действия по установке, то он будет пытаться установить этот же список при каждой новой попытке установки надстройки. Чтобы не допустить этого, необходимо написать код обработчика события установки так, чтобы он не выполнял никаких действий (например, развертывание компонента), прежде чем проверит, не было ли выполнено это действие ранее. Из-за этого код обработчика события установки сложнее кода, выполняемого при первом запуске, так как последний не выполняется повторно (если, конечно, вы намеренно не запрограммируете повторное выполнение). Кроме того, для проверки того, не развернут ли какой-либо компонент, необходимо выполнить затратный по времени вызов через Интернет от удаленного обработчика к SharePoint. После этого понадобится выполнить второй вызов для развертывания компонента (если он не был развернут ранее).
    
 
В надстройке Chain Store мы объединим эти стратегии. В данной статье вы создадите обработчик события установки, который будет регистрировать хост-сайт в качестве клиента в корпоративной базе данных, а затем задавать сигнал о том, была ли уже запущена надстройка на хост-сайте. В одной из следующих статей серии вы добавите код, выполняемый при первом запуске, в метод **Page_Load** начальной страницы надстройки. Этот код будет развертывать два настраиваемых списка и выполнять ряд других действий.
 

 

## <a name="configure-the-solution-for-event-receiver-debugging"></a>Настройка решения для отладки приемника событий
<a name="RERDebug"> </a>

Для отладки приемников событий необходимо использовать шину обслуживания Azure. Следуйте инструкциям в статье  [Устранение неполадок и отладка удаленного приемника событий в надстройке для SharePoint](debug-and-troubleshoot-a-remote-event-receiver-in-a-sharepoint-add-in). Так как в качестве тестового сайта вы используете веб-сайт SharePoint Online, не забудьте выполнить эти инструкции на удаленном тестовом сайте. В следующих статьях серии подразумевается, что вы успешно настроили среду отладки. 
 

 

## <a name="create-the-installation-handler"></a>Создание обработчика установки
<a name="RERDebug"> </a>


 

 

 **Примечание.** Параметры запускаемых проектов в Visual Studio обычно возвращаются к значениям по умолчанию каждый раз, когда вы заново открываете решение. Открывая пример решения, рассматриваемый в этой серии статей, всегда выполняйте следующие действия: щелкните правой кнопкой мыши узел решения в **обозревателе решений** и выберите пункт **Назначить запускаемые проекты**, а затем убедитесь, что для всех трех проектов в столбце **Действие** задано значение **Запуск**.
 


1. В **обозревателе решений** выберите проект **ChainStore**, чтобы его свойства появились в области **Свойства** в Visual Studio.
    
 
2. Задайте для параметра **Управление установленными надстройками** значение **True** (этот параметр может по-прежнему называться **Управление установленными приложениями**). При этом выполняется два указанных ниже действия.
    
      - В проекте **ChainStoreWeb** (но не в проекте **ChainStore**) создается папка **Службы**, в которую добавляются два файла: файл AppEventReceiver.svc и его файл кода программной части AppEventReceiver.svc.cs. Имена файлов начинаются со строки App, так как ранее надстройки назывались приложениями. *Не переименовывайте эти файлы.* Для правильной работы Инструментов разработчика Office для Visual Studio необходимо, чтобы у файлов были именно такие имена.
    
 
  - URL-адрес обработчика регистрируется в манифесте надстройки. Эта часть не отображается в конструкторе манифеста. Чтобы увидеть ее, щелкните правой кнопкой мыши файл AppManifest.xml и выберите пункт **Перейти к коду**. Там вы увидите новый дочерний объект элемента **Properties**, представленный ниже. Эта часть кода сообщает SharePoint, что по завершении установки надстройки необходимо будет вызвать метод **ProcessEvent** этой службы. Настраиваемый обработчик — это последний компонент, запускаемый в процессе установки. Строка `~remoteAppUrl` — это заполнитель, который Инструменты разработчика Office для Visual Studio заменят на URL-адрес узла службы. При отладке в качестве этого адреса используется URL-адрес служебной шины Azure. Соответственно, при создании пакета для развертывания в рабочей среде используется URL-адрес рабочей среды.
    
```XML
  <InstalledEventEndpoint>~remoteAppUrl/Services/AppEventReceiver.svc</InstalledEventEndpoint>
```

3. Откройте файл AppEventReceiver.svc.cs.
    
 
4. Вы увидите, что Инструменты разработчика Office для Visual Studio создали пример реализации метода **ProcessEvent**. Все реализации этого метода начинаются с инициализации объекта **SPRemoteEventResult** и заканчиваются возвращением этого объекта в SharePoint. Помимо прочего, этот объект сообщает среде SharePoint, следует ли откатить событие из-за сбоя кода настраиваемого обработчика. Кроме того, возможно, что инструменты включили в этот метод блок **using**, который создает объект **ClientContext**. Настраиваемый обработчик в надстройке "Сеть магазинов" не будет отправлять обратный вызов в SharePoint, поэтому удалите этот блок. Теперь этот метод должен выглядеть так, как показано ниже.
    
```C#
  public SPRemoteEventResult ProcessEvent(SPRemoteEventProperties properties)
{
    SPRemoteEventResult result = new SPRemoteEventResult();


    return result;
}
```

5. Приемник событий можно вызвать с помощью любого из трех возможных событий надстройки, поэтому добавьте приведенную ниже структуру **switch** в метод **ProcessEvent** между строками, в которых создается и возвращается объект `result`. В именах событий имеется строка App (Приложение), так как ранее надстройки назывались приложениями.
    
```C#
  switch (properties.EventType)
{
    case SPRemoteEventType.AppInstalled:

        // TODO2: Custom installation logic goes here.

        break;
    case SPRemoteEventType.AppUpgraded:
        // This sample does not implement an add-in upgrade handler.
        break;
    case SPRemoteEventType.AppUninstalling:

        // TODO3: Custom uninstallation logic goes here.         
         
        break;
}
```

6. Для регистрации магазина в Гонконге в качестве клиента в удаленном веб-приложении наш код, выполняемый во время установки, должен вызывать хранимую процедуру SQL. Очень важно, чтобы в случае сбоя процесса обработчик сообщал SharePoint, что необходимо откатить установку надстройки. Поэтому добавьте приведенные ниже блоки **try/catch** вместо `TODO2`. Обратите внимание на указанные ниже особенности этого кода.
    
      - Мы создадим объект `tenantName` и метод `CreateTenant` на последующем этапе.
    
 
  - Свойство **Status** объекта **SPRemoteEventResult** может принимать одно из трех следующих значений: **Continue** (используется по умолчанию), **CancelNoError** и **CancelWithError**. Два последних значения сообщают SharePoint, что необходимо откатить событие.
    
 

```C#
  try
{
    CreateTenant(tenantName);
 }
catch (Exception e)
{
     // Tell SharePoint to cancel and roll back the event.
    result.ErrorMessage = e.Message;
    result.Status = SPRemoteEventServiceStatus.CancelWithError;
}
```

7. URL-адрес хост-сайта, представляющий собой дискриминатор клиента в примере, включается в сведения, которые SharePoint передает приемнику в параметре **SPRemoteEventProperties**. Добавьте приведенную ниже строку в метод **ProcessEvent** сразу же после блока инициализации объекта **SPRemoteEventResult**.
    
```C#
  string tenantName = properties.AppEventProperties.HostWebFullUrl.ToString();
```

8. Теперь в нашем коде придется учесть небольшую особенность свойства **AppEventProperties.HostWebFullUrl**. В большинстве других контекстов SharePoint добавляет закрывающий символ косой черты "/" в конце URL-адреса хост-сайта, поэтому в нашем примере кода предполагается, что этот символ присутствует. Но SharePoint добавляет этот символ в конце значения **HostWebFullUrl** только в том случае, если хост-сайт является корневым в семействе веб-сайтов. Так как наш веб-сайт магазина в Гонконге является дочерним в семействе веб-сайтов, то нам потребуется добавить этот символ, чтобы во всем примере использовалось одно и то же имя клиента. Добавьте приведенный ниже код сразу после блока инициализации объекта `tenantName`.
    
```C#
  if (!tenantName.EndsWith("/"))
{
    tenantName += "/";
}
```

9. Добавьте приведенные ниже операторы **using** в начале файла.
    
```
  using System.Data.SqlClient;
using System.Data;
using ChainStoreWeb.Utilities;
```

10. Добавьте указанный ниже метод в класс  `AppEventReceiver`. Мы не будем подробно рассматривать его, так как цель этой серии статей научить вас программированию надстроек SharePoint, а не программированию для SQL Server или Azure.
    
    Этот метод будет создавать строку в таблице **Tenants** (Клиенты) базы данных. Помимо столбца **Name** (Имя), в таблице имеется столбец **Version** (Версия) со значением 0000.0000.0000.0000, используемым по умолчанию. В одной из следующих статей этой серии описывается создание кода, выполняемого во время первого запуска, который будет использовать это значение, чтобы проверить, установлена ли надстройка на хост-сайте. Если номер версии равен 0000.0000.0000.0000, то ваш код развернет списки **Местные сотрудники** и **Ожидаемые поставки**, а затем увеличит номер версии.
    


```C#
  private void CreateTenant(string tenantName)
{
    // Do not catch exceptions. Allow them to bubble up and trigger roll back
    // of installation.

    using (SqlConnection conn = SQLAzureUtilities.GetActiveSqlConnection())
    using (SqlCommand cmd = conn.CreateCommand())
    {
        conn.Open();
        cmd.CommandText = "AddTenant";
        cmd.CommandType = CommandType.StoredProcedure;
        SqlParameter name = cmd.Parameters.Add("@Name", SqlDbType.NVarChar);
        name.Value = tenantName;
        cmd.ExecuteNonQuery();
    }//dispose conn and cmd
}
```


## <a name="create-the-uninstallation-handler"></a>Создание обработчика удаления
<a name="RERDebug"> </a>

В случаях, когда обрабатывается событие установки, обычно рекомендуется обрабатывать и событие удаления. Основная причина этого состоит в том, что обработчик события удаления должен перемещать в корзину или удалять объекты, установленные обработчиком события установки. Тем не менее существует много исключений, поэтому вам необходимо хорошо понимать варианты использования вашей надстройки. Например, в списке, который был развернут и заполнен надстройкой, могут остаться значения даже после ее удаления, при этом вам может быть потребоваться, чтобы обработчик события удаления не удалял этот список. 
 

 
Если пользователь удаляет надстройку со страницы **Содержимое сайта**, то событие удаления не создается, как того можно было ожидать. В этом случае надстройка лишь перемещается в корзину веб-сайта. Пользователь может восстановить ее, но при восстановлении обработчик события установки не запускается повторно, поэтому необходимо, чтобы по-прежнему существовали все объекты, развернутые обработчиком события установки. Компоненты SharePoint можно перемещать из корзины во вторую корзину. Событие удаления будет создано только при удалении надстройки из второй корзины. Если пользователь сделает это, то надстройка будет безвозвратно удалена, поэтому в этот момент нам необходимо будет удалить клиент магазина в Гонконге из корпоративной базы данных.
 

 

1. Задайте для параметра **Управление удалением надстроек** значение **True** (этот параметр может по-прежнему называться **Управление удалением приложений**). При этом обработчик будет зарегистрирован в файле AppManifest.xml точно так же, как ранее был зарегистрирован обработчик события установки. Взглянув на содержимое файла, вы увидите, что их URL-адреса полностью совпадают. Инструменты разработчика Office для Visual Studio предполагают, что вы используете один и тот же SVC-файл. Мы делаем это в данном примере, и это является стандартной рекомендацией. 
    
 
2. Добавьте приведенный ниже код вместо заполнителя `TODO3` в файле AppEventReceiver.svc.cs. Обратите внимание на указанные ниже особенности этого кода.
    
      - Метод `DeleteTenant` будет добавлен на следующем этапе.
    
 
  - При откате удаления надстройка останется во второй корзине, из которой ее все еще можно восстановить.
    
 

```C#
  try
{
    DeleteTenant(tenantName);
 }
catch (Exception e)
{
     // Tell SharePoint to cancel and roll back the event.
    result.ErrorMessage = e.Message;
    result.Status = SPRemoteEventServiceStatus.CancelWithError;
}
```

3. Добавьте приведенный ниже метод в класс `AppEventReceiver`.
    
```C#
  private void DeleteTenant(string tenantName)
{
    // Do not catch exceptions. Allow them to bubble up and trigger roll back
    // of un-installation (removal from 2nd level Recycle Bin).

    using (SqlConnection conn = SQLAzureUtilities.GetActiveSqlConnection())
    using (SqlCommand cmd = conn.CreateCommand())
    {
        conn.Open();
        cmd.CommandText = "RemoveTenant";
        cmd.CommandType = CommandType.StoredProcedure;
        SqlParameter name = cmd.Parameters.Add("@Name", SqlDbType.NVarChar);
        name.Value = tenantName;
        cmd.ExecuteNonQuery();                
    }//dispose conn and cmd
}
```


 **Примечание.** В предыдущей статье этой серии вы настроили проект так, чтобы при каждом нажатии клавиши F5 перестраивалась корпоративная база данных. При этом выполняется очистка таблицы **Tenants** (Клиенты).
 


## <a name="run-the-add-in-and-test-the-installation-handler"></a>Запуск надстройки и тестирование обработчика установки
<a name="RERDebug"> </a>


1. Нажмите клавишу F5, чтобы развернуть и запустить вашу надстройку. Visual Studio размещает удаленное веб-приложение в IIS Express, а базу данных SQL в SQL Express. Кроме того, он создает временную установку надстройки на вашем тестовом сайте SharePoint, запускает обработчик события установки и немедленно запускает надстройку. Прежде чем откроется начальная страница надстройки, вам будет предложено предоставить надстройке необходимые разрешения. 
    
 
2. Когда откроется начальная страница надстройки, нажмите значок с изображением шестеренки на расположенном вверху элементе управления хрома и выберите **Параметры учетной записи**.
    
 
3. На странице **Учетные записи** нажмите кнопку **Показать версию надстройки**. Появится номер версии 0000.0000.0000.0000.
    
  ![Страница "Учетные записи" с заголовком "Параметры учетной записи". Под кнопкой "Показать версию надстройки" находится строка "Зарегистрированная версия: ноль ноль ноль ноль точка ноль ноль ноль ноль точка ноль ноль ноль ноль точка ноль ноль ноль ноль".](../../images/2a905b7d-89c7-456a-8456-21a9b7e9efc5.PNG)
 

 

 
4. Чтобы завершить сеанс отладки, закройте окно браузера или остановите отладку в Visual Studio. При каждом нажатии клавиши F5 Visual Studio будет отзывать предыдущую версию надстройки и устанавливать ее последнюю версию.
    
 
5. Эти надстройка и решение Visual Studio будут рассматриваться и в других статьях, поэтому при перерывах в работе рекомендуется отзывать надстройку. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункт **Отозвать**.
    
 

## 
<a name="Nextsteps"> </a>

 В следующей статье этой серии вы добавите в надстройку код, выполняемый при первом запуске, для автоматического развертывания списка **Local Employees** (Местные сотрудники) и настраиваемой кнопки ленты: [Добавление кода, выполняемого при первом запуске, в надстройку, размещаемую у поставщика](add-first-run-logic-to-the-provider-hosted-add-in).
 

 

