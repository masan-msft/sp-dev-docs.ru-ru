---
title: "Создание надстройки с размещением у поставщика, которая включает пользовательский список SharePoint и тип контента"
ms.date: 09/25/2017
ms.prod: sharepoint
ms.openlocfilehash: e5dacf516a3569b2dd38cdbe1936e6c874cb0556
ms.sourcegitcommit: 1cae27d85ee691d976e2c085986466de088f526c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2017
---
# <a name="create-a-provider-hosted-add-in-that-includes-a-custom-sharepoint-list-and-content-type"></a>Создание надстройки с размещением у поставщика, которая включает пользовательский список SharePoint и тип контента
Узнайте, как создать надстройку SharePoint, которая объединяет веб-приложение, размещенное в облаке, с размещенными в SharePoint пользовательскими шаблонами списков, экземплярами списков и пользовательскими типами контента, с помощью Инструментов разработчика Office для Visual Studio 2012. Узнайте, как взаимодействовать с сайтами надстроек SharePoint с помощью веб-службы REST/OData и как реализовать OAuth в надстройке SharePoint.
 

 **Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint.md#bk_newname).
 

Большинство классических компонентов SharePoint, например настраиваемые типы контента, пользовательские определения списков и рабочие процессы, можно включить в надстройку SharePoint, размещенную в облаке. Простой пример, приведенный в этой статье, включает следующие компоненты:
 

- Сайт надстройки с
    
      - рядом настраиваемых столбцов веб-сайтов
    
 
  - типом пользовательского контента, использующим настраиваемые столбцы
    
 
  - шаблоном настраиваемых списков, в котором используется данный тип пользовательского контента
    
 
  - экземпляром списка, основанным на пользовательском определении списка
    
 
- Веб-приложение ASP.NET, считывающее данные из экземпляра списка
    
 

## <a name="prerequisites-for-creating-this-sharepoint-add-in"></a>Необходимые условия для создания этой надстройки SharePoint
<a name="Prerequisites"> </a>


-  [Visual Studio 2012](https://www.microsoft.com/en-us/download/details.aspx?id=30682) или более поздней версии.
    
 
-  [Office Developer Tools](https://msdn.microsoft.com/ru-RU/office/aa905340.aspx).
    
 
- Установка SharePoint для тестирования и отладки
    
      - Это можно сделать на том же компьютере, который используется для разработки. Для разработки также можно использовать удаленную установку SharePoint. Если вы работаете с удаленной установкой, необходимо установить распространяемую клиентскую объектную модель для целевой установки. Она доступна в качестве распространяемого пакета в Центре загрузки Майкрософт. Выполните поиск по словам "пакет SDK для клиентских компонентов SharePoint Server 2013" или "пакет SDK для клиентских компонентов SharePoint Online". 
    
 
  - Тестовый веб-сайт SharePoint необходимо создать на основе определения **Сайт разработчика** (его можно создать в Центре администрирования).
    
 
  - Для обмена данными с сайтом надстройки ваше удаленное приложение использует либо JavaScript и [междоменную библиотеку](access-sharepoint-data-from-add-ins-using-the-cross-domain-library.md), либо [OAuth](authorization-and-authentication-of-sharepoint-add-ins.md). При использовании OAuth, как демонстрирует пример в данной статье, необходимо настроить установку SharePoint для работы с OAuth.
    
 

 **Примечание.** Рекомендации по настройке среды разработки, соответствующей вашим потребностям, вы найдете в разделе [Разработка решений Office](http://msdn.microsoft.com/library/187f8c8c-1b15-471c-80b5-69a40e67deea.aspx).
 


### <a name="core-concepts-to-know-for-creating-an-add-in"></a>Ключевые понятия, которые необходимо знать при создании надстройки

Перед созданием первой надстройки необходимо иметь базовое представление о том, что такое Надстройки SharePoint, и о различиях между размещением надстроек SharePoint в SharePoint и в облаке. Такие сведения имеются в статьях, перечисленных в таблице 1.
 

 

**Таблица 1. Ключевые понятия для создания надстройки**


|**Название статьи**|**Описание**|
|:-----|:-----|
| [Надстройки SharePoint](sharepoint-add-ins.md)|Изучите новую модель надстроек в SharePoint, с помощью которой можно создавать небольшие и удобные в использовании надстройки для пользователей.|
| [Важные аспекты разработки и архитектуры для надстроек SharePoint](important-aspects-of-the-sharepoint-add-in-architecture-and-development-landscap.md)|Изучите аспекты архитектуры надстроек SharePoint и Модель для надстроек SharePoint, в том числе параметры размещения надстроек и пользовательского интерфейса, систему развертывания, систему безопасности и жизненный цикл.|
| [Выбор шаблонов для разработки и размещения надстройки SharePoint](choose-patterns-for-developing-and-hosting-your-sharepoint-add-in.md)|Узнайте о различных способах размещения надстроек SharePoint.|

## <a name="develop-the-sharepoint-add-in"></a>Разработка надстройки SharePoint
<a name="Develop"> </a>

 С помощью процедур в данном разделе на своем компьютере для разработки вы сможете создать надстройку SharePoint, включающую сайт надстройки с компонентами SharePoint и удаленное веб-приложение.
 

 

### <a name="to-set-up-the-visual-studio-2012-solution-and-its-elements"></a>Настройка решения Visual Studio 2012 и его элементов


1. В Visual Studio 2012 создайте проект на основе шаблона **Надстройка для SharePoint** из узла **Office SharePoint | Надстройки** (либо на **C#**, либо на **Visual Basic**) в дереве шаблонов мастера **создания проектов**. Выберите вариант **Размещено у поставщика**. В примере, рассматриваемом в этой статье, выбран язык C# и указано имя проекта LocalTheater.
    
 
2. Нажмите в мастере кнопку **Готово**.
    
 
3. Откройте файл AppManifest.xml в конструкторе манифеста. По умолчанию в качестве значения элемента **Title** используется имя проекта. Замените его на более понятное имя, так как именно это название надстройки будет отображаться в пользовательском интерфейсе.
    
 
4. Укажите значение параметра **Name** для надстройки. Это внутреннее имя, в котором можно использовать только символы ASCII без пробелов. Пример: LocalTheater.
    
 
5. Откройте файл Web.config в проекте веб-приложения и добавьте элемент `<customErrors mode="Off"/>` к элементу **system.web**.
    
 
6. Проверьте, находятся ли ссылки на следующие сборки в проекте веб-приложения. (Если ваша версия Visual Studio 2012 не добавила ссылки автоматически, добавьте их.)
    
      -  **Microsoft.IdentityModel.dll** Данная сборка устанавливается в глобальном кэше сборки посредством Windows Identity Foundation (WIF). Так как данная сборка является сборкой.NET Framework 3.5, она отфильтровывается из узла **Framework** в диалоговом окне **Добавить ссылку** по умолчанию. Вы можете добавить к ней ссылку, переместившись непосредственно в папку `C:\Program Files\Reference Assemblies\Microsoft\Windows Identity Foundation\v3.5` вашего компьютера, используемого для разработки.
    
 
  -  **Microsoft.IdentityModel.Extensions.dll** Вы можете добавить ссылку на эту библиотеку. Для этого перейдите непосредственно к папке `C:\Program Files\Reference Assemblies\Microsoft\Microsoft Identity Extensions\1.0` на компьютере, используемом для разработки.
    
 
  -  **System.IdentityModel.dll** Данная сборка является частью .NET Framework 4, и она появляется в узле **Assemblies | Framework** диалогового окна **Добавить ссылку**.
    
 
7. Если удаленное веб-приложение получает доступ к данным на хост-сайте и на сайте надстройки, то необходимо добавить элемент **AppPermissionRequests** (с одним или несколькими дочерними элементами **AppPermissionRequest**) в файл AppManifest.xml. Веб-приложение в нашем примере получает доступ только к сайту надстройки. Субъекты надстроек автоматически получают все разрешения, необходимые для сайта надстройки, поэтому в файле AppManifest.xml из этого примера нет элемента **AppPermissionRequests**. Дополнительные сведения о запросах разрешений для надстроек и о том, как добавлять их, см. в статье [Разрешения для надстроек в SharePoint](add-in-permissions-in-sharepoint.md).
    
 

### <a name="to-add-the-sharepoint-components"></a>Добавление компонентов SharePoint


1. Вы можете добавлять компоненты SharePoint в надстройку точно так же, как и в классическое решение фермы. Тем не менее, не каждый тип компонентов SharePoint можно включить в надстройку SharePoint. Цели, для которых служат этих компоненты, Надстройки SharePoint достигают другими способами. Подробные сведения о том, какие типы компонентов SharePoint можно включить в надстройку SharePoint, и о том, как включить их в проект, см. в разделах  [Типы компонентов SharePoint, которые могут находиться в надстройке для SharePoint](host-webs-add-in-webs-and-sharepoint-components-in-sharepoint.md#TypesOfSPComponentsInApps).
    
    Для примера используйте указанные ниже процедуры. В них имеются примеры использования Visual Studio 2012, с помощью которых можно добавить настраиваемые столбцы, типы содержимого, шаблоны списков и экземпляры списков в надстройку SharePoint.
    
### <a name="to-create-the-custom-column-types"></a>Создание пользовательских типов столбцов


1. В **обозревателе решений** добавьте в проект надстройки SharePoint элемент **Столбец сайта** с именем Actor.
    
 
2. В файле elements.xml для нового столбца сайта отредактируйте элемент **Field**, указав атрибуты и значения, приведенные в следующем примере, но не меняйте GUID в атрибуте **ID**, оставив значение, созданное средой Visual Studio 2012. Не забудьте добавить фигурные скобки: {}.
    
```
  <Field ID="{generated GUID}" 
       Name="Actor" 
       Title="Actor" 
       DisplayName="Actor/Actress" 
       Group="Theater and Movies" 
       Description="The person cast, perhaps tentatively, in the role" 
       Type="Text" 
/>
```

3. Добавьте в проект еще один элемент **Столбец сайта** с именем CastingStatus.
    
 
4. В файле elements.xml для нового столбца сайта отредактируйте элемент **Field**, указав атрибуты и значения, приведенные в следующем примере, но не меняйте GUID в атрибуте **ID**, оставив значение, созданное средой Visual Studio 2012.
    
```
  <Field ID="{generated GUID}" 
       Name="CastingStatus" 
       Title="CastingStatus"
       DisplayName="Casting Status" 
       Group="Theater and Movies" 
       Description="The current casting status of the role" 
       Type="Choice">
</Field>
```

5. Так как это поле является полем выбора, необходимо указать возможные варианты, порядок их отображения в раскрывающемся списке и вариант, выбранный по умолчанию. Добавьте следующую дочернюю маркировку к элементу **Field**:
    
```
  <CHOICES>
      <CHOICE>Not Started</CHOICE>
      <CHOICE>Audition Scheduled</CHOICE>
      <CHOICE>Auditioned</CHOICE>
      <CHOICE>Role Offered</CHOICE>
      <CHOICE>Committed to Role</CHOICE>
</CHOICES>
<MAPPINGS>
      <MAPPING Value="1">Not Started</MAPPING>
      <MAPPING Value="2">Audition Scheduled</MAPPING>
      <MAPPING Value="3">Auditioned</MAPPING>
      <MAPPING Value="4">Role Offered</MAPPING>
      <MAPPING Value="5">Committed to Role</MAPPING>
</MAPPINGS>
<Default>Not Started</Default>
```


### <a name="to-create-the-custom-content-type"></a>Создание пользовательского типа контента


1. В **обозревателе решений** добавьте в проект надстройки SharePoint элемент **Тип контента** с именем ActingRole. Когда мастер предложит выбрать базовый тип контента, выберите **Элемент**, а затем нажмите кнопку **Готово**.
    
 
2. Если конструктор типа контента не откроется автоматически, выберите тип контента **ActingRole** в **обозревателе решений**, чтобы открыть его.
    
 
3. Откройте вкладку **Тип контента** в конструкторе и заполните текстовые поля следующим образом:
    
      -  **Имя типа контента**: ActingRole
    
 
  -  **Описание**: "Соответствует роли в пьесе или фильме"
    
 
  -  **Имя группы**: "Театр и кино"
    
 
4. Убедитесь, что ни один из флажков, находящихся во вкладке, не выбран ( *None*  ). Флажок **Наследует столбцы из родительского Типа контента** может быть выбран по умолчанию. *Обязательно очистите его.* 
    
 
5. Откройте вкладку **Столбцы** конструктора.
    
 
6. Добавьте эти два столбца сайта к типу контента, используя сетку. Они располагаются в раскрывающемся списке по отображаемым именам: **Actor/Actress** и **CastingStatus**. Если они отсутствуют в списке, возможно, вы не сохранили проект после добавления настраиваемых столбцов сайтов. Нажмите **Сохранить все**.
    
 
7. Сохраните файл и закройте конструктор.
    
 
8. На следующем этапе вам потребуется работать непосредственно с необработанным кодом XML типа контента, поэтому в **обозревателе решений** необходимо выбрать дочерний файл elements.xml типа контента **ActingRole**.
    
 
9. Для двух добавленных вами столбцов в файле уже есть элементы **FieldRef**. Добавьте аналогичные им элементы **FieldRef** для двух встроенных столбцов SharePoint. Ниже представлена маркировка элементов. *Для атрибута ID необходимо использовать те же идентификаторы GUID, так как это встроенные типы полей с фиксированными идентификаторами.* Добавьте их *над* двумя имеющимися элементами **FieldRef** для настраиваемых столбцов сайтов.
    
```
  <FieldRef Name="LinkTitle" ID="{82642ec8-ef9b-478f-acf9-31f7d45fbc31}" DisplayName="Character" />
<FieldRef Name="Title" ID="{fa564e0f-0c70-4ab9-b863-0177e6ddd247}" DisplayName="Character" />
```


    Note that we have given these fields a custom display name:  **Character**, in the sense of a character in a play or movie.
    
 

### <a name="to-create-the-custom-list-template-and-a-list-instance"></a>Создание пользовательского шаблона и экземпляра списка


1. Добавьте в проект надстройки SharePoint элемент **Список** с именем CharactersInShow. На странице **Выберите параметры списка** в **мастере настроек SharePoint** оставьте заданное по умолчанию отображаемое имя списка (**CharactersInShow**), нажмите кнопку **Создать настраиваемый список на основе**, а затем выберите элемент **По умолчанию (пусто)** в раскрывающемся списке. Затем нажмите кнопку **Готово**.
    
 
2. По завершении работы мастера будет создан шаблон списка **CharactersInShow** с дочерним экземпляром списка под названием **CharactersInShowInstance**. По умолчанию может открыться конструктор списка. Он понадобится на следующем этапе.
    
 
3. Откройте дочерний файл elements.xml шаблона списка **CharactersInShow** (*не* дочерний файл elements.xml, относящийся к списку **CharactersInShowInstance**).
    
 
4. Измените значение атрибута **DisplayName** на более понятное: "Герои представления".
    
 
5. Для атрибута **Description** задайте значение "Персонажи пьесы или фильма".
    
 
6. Оставьте для других атрибутов значения по умолчанию, а затем сохраните и закройте файл.
    
 
7. Если конструктор списка не открыт, выберите узел **CharactersInShow** в **обозревателе решений**.
    
 
8. Откройте вкладку **Столбцы** конструктора и нажмите кнопку **Типы контента**.
    
 
9. В диалоговом окне **Параметры типов содержимого** добавьте тип контента **ActingRole**.
    
 
10. Выберите тип контента **ActingRole** в списке типов контента, а затем нажмите кнопку **По умолчанию**.
    
    Выберите тип контента **Элемент**, щелкните правой кнопкой мыши маленькую стрелку слева от имени типа контента и выберите пункт **Удалить**.
    
 
11. Повторите предыдущий этап для типа контента **Папка**, чтобы в списке остался только тип контента **ActingRole**. Чтобы закрыть диалоговое окно, нажмите кнопку **ОК**.
    
 
12. Теперь в списке столбцов отображается три столбца. Выберите **Название**, щелкните правой кнопкой мыши маленькую стрелку слева от имени типа контента и выберите пункт **Удалить**. Теперь должно остаться только два столбца: **Актер или актриса** и **Статус кастинга**.
    
 
13. Откройте вкладку **Список** конструктора. Эта вкладка используется для настройки определенных значений для *экземпляра*, а не *шаблона* списка.
    
 
14. Замените значения на этой вкладке следующими:
    
      -  **Заголовок**: "Герои пьесы «Гамлет»"
    
 
  -  **URL-адрес списка**: Lists/CharactersInHamlet
    
 
  -  **Описание**: "Герои пьесы «Гамлет» и сведения о кастинге".
    
 

     Оставьте установленные по умолчанию флажки и закройте конструктор.
    
 
15. В **обозревателе решений** может отображаться старое имя экземпляра списка. В этом случае откройте контекстное меню элемента **CharactersInShowInstance**, выберите пункт **Переименовать** и измените имя на CharactersInHamlet.
    
 
16. Откройте файл schema.xml.
    
 
17. Файл может содержать два элемента **ContentType**: один со значением ActingRole для атрибута **Name**, другой с именем **ListFieldsContentType**. Нас интересует только элемент ActingRole, поэтому следует удалить остальные элементы **ContentType**.
    
     **Примечание.** Между элементами **ContentType** может не быть разрывов строк, вследствие чего может показаться, что отображается только один элемент. Прокрутите представление вправо и внимательно проверьте наличие остальных элементов.
18. Элемент **Fields** должен содержать два элемента **Field** (в одной строке, если между ними нет разрыва строки). Один из них должен быть точной копией элемента **Field** из файла elements.xml столбца сайта **Actor**, а другой — точной копией элемента **Field** из файла elements.xml столбца сайта **CastingStatus**. Если между ними нет полного совпадения (включая все дочерние элементы, например **CHOICES** и **MAPPINGS**), скопируйте элемент **Field** из файла elements.xml столбца сайта и вставьте его вместо несоответствующего элемента **Field** в файле schema.xml.
    
 
19. Не закрывая файл schema.xml, в элементе **View**, значение BaseViewID которого равно 0, замените элемент **ViewFields** на приведенную ниже разметку. Используйте именно этот GUID для параметра **FieldRef** с именем `LinkTitle`.
    
```
  <ViewFields>
  <FieldRef Name="Title" ID="{fa564e0f-0c70-4ab9-b863-0177e6ddd247}" DisplayName="Character" />
  <FieldRef Name="Actor" ID="{GUID from the site column elements.xml}" />
  <FieldRef Name="CastingStatus" ID="{GUID from the site column elements.xml}" />
</ViewFields>
```

20. Замените два отсутствующих значения атрибута ID на идентификаторы GUID в соответствующих файлах elements.xml столбцов сайтов. Не забудьте добавить фигурные скобки: {}. 
    
 
21. Не закрывая файл schema.xml, в элементе **View**, значение BaseViewID которого равно 1, замените имеющийся элемент **ViewFields** на приведенную ниже разметку. Используйте именно этот GUID для параметра **FieldRef** с именем `LinkTitle`.
    
```
  <ViewFields>
  <FieldRef Name="LinkTitle" ID="{82642ec8-ef9b-478f-acf9-31f7d45fbc31}" DisplayName="Character" />
</ViewFields>
```

22. Скопируйте два элемента **FieldRef** столбцов `Actor` и `CastingStatus`, которые вы добавили в предыдущее представление, в этот элемент **ViewFields** на одном уровне с элементом **FieldRef** для `LinkTitle`.
    
 
23. Сохраните и закройте файл schema.xml.
    
 
24. Откройте файл elements.xml, являющийся дочерним объектом экземпляра списка **CharactersInHamlet**.
    
 
25. Заполните список какими-либо начальными данными, добавив приведенную ниже разметку в качестве дочернего объекта элемента **ListInstance**.
    
```
  <Data>
  <Rows>
    <Row>
      <Field Name="Title">Hamlet</Field>
      <Field Name="Actor">Tom Higginbotham</Field>
      <Field Name="CastingStatus">Committed to Role</Field>
    </Row>
    <Row>
      <Field Name="Title">Claudius</Field>
      <Field Name="Actor"></Field>
      <Field Name="CastingStatus">Not Started</Field>
    </Row>
    <Row>
      <Field Name="Title">Gertrude</Field>
      <Field Name="Actor">Satomi Hayakawa</Field>
      <Field Name="CastingStatus">Auditioned</Field>
    </Row>
    <Row>
      <Field Name="Title">Ophelia</Field>
      <Field Name="Actor">Cassi Hicks</Field>
      <Field Name="CastingStatus">Committed to Role</Field>
    </Row>
    <Row>
      <Field Name="Title">The ghost</Field>
      <Field Name="Actor">Lertchai Treetawatchaiwong</Field>
      <Field Name="CastingStatus">Role Offered</Field>
    </Row>
  </Rows>
</Data>
```

2. В **обозревателе решений** выберите элемент **Feature1**, чтобы открыть конструктор возможностей. В конструкторе задайте для поля **Заголовок** значение "Компоненты данных театра и кино", а для поля **Описание** — "Столбцы сайтов, типы контента и экземпляры списков для данных о театре и кино". Сохраните файл и закройте конструктор.
    
 
3. Если элемент **Feature1** в **обозревателе решений** не был переименован, откройте его контекстное меню, выберите пункт **Переименовать** и укажите имя TheaterAndMovieDataComponents.
    
 

### <a name="to-code-the-remote-web-application-project"></a>Написание кода проекта удаленного веб-приложения


- Создайте веб-приложение так же, как и любое другое веб-приложение для выбранного вами комплекса платформ. Что касается платформ корпорации Майкрософт, вы можете использовать либо веб-службу REST/OData, либо одну из клиентских объектных моделей в SharePoint. При работе с другими платформами вы можете использовать конечные точки REST/OData в SharePoint для выполнения операций CRUD (создания, чтения, обновления и удаления данных) на сайте надстройки.
    
     **Примечание.** При добавлении ссылки на сборку для проекта веб-приложения в Visual Studio задайте для свойства **Копировать локально** этой сборки значение **True**, если вы не уверены, установлена ли сборка на веб-сервере и сможете ли вы обеспечить ее установку перед развертыванием надстройки. Платформа .NET Framework устанавливается в веб-ролях Microsoft Azure и на веб-сайтах Azure. Тем не менее клиентские сборки для SharePoint, а также различные расширения и основы для управляемого кода Майкрософт не устанавливаются. Инструменты разработчика Office для Visual Studio 2012 автоматически добавляют ссылки на некоторые сборки, часто используемые надстройками SharePoint, и задают свойство **Копировать локально**.

    В нашем примере создается веб-приложение ASP.NET. Выполните указанные ниже действия.
    
      1. Откройте файл Default.aspx и замените основной элемент файла на приведенную ниже разметку. Она добавляет кнопку **Get the Cast** (Получить состав актеров), при нажатии которой данные из списка **Герои пьесы "Гамлет"** на сайте приложения отображаются в элементе управления [GridView](http://msdn2.microsoft.com/ru-RU/library/4w7ya1ts), появляющемся только после нажатия кнопки.
    
```HTML
  <body >
    <form id="form1" runat="server">
    <div>
    <h2>Local Theater</h2>
    </div>
    <asp:Literal ID="Literal1" runat="server"><br /><br /></asp:Literal>

    <asp:Button ID="Button1" runat="server" OnClick="Button1_Click" Text="Get the Cast"/>

    <asp:Literal ID="Literal2" runat="server"><br /><br /></asp:Literal>

    <asp:GridView ID="GridView1" runat="server" Caption="The Cast" ></asp:GridView>
    </form>
</body>
```

  2. Откройте файл Default.aspx.cs и добавьте в него приведенные ниже операторы **using**.
    
```C#
  using Microsoft.SharePoint.Client;
using Microsoft.IdentityModel.S2S.Tokens;
using System.Net;
using System.IO;
using System.Xml;
using System.Data;
using System.Xml.Linq;
using System.Xml.XPath;
using Microsoft.SharePoint.Samples;
```


    The last of these statements refers to the namespace that is declared in the TokenHelper.cs file.
    
 
  3. Добавьте приведенные ниже поля в класс **Default**.
    
```C#
  SharePointContextToken contextToken;
string accessToken;
Uri sharepointUrl;
```

  4. Замените метод **Page_Load** на приведенный ниже код, который использует класс **TokenHelper** для получения маркеров с защищенного сервера маркеров, совместимого с OAuth. Затем маркер доступа сохраняется в свойстве [CommandArgument](http://msdn2.microsoft.com/ru-RU/library/hykdabtx) кнопки для дальнейшего вызова обработчиком события при нажатии кнопки.
    
```C#
  protected void Page_Load(object sender, EventArgs e)
{
    TokenHelper.TrustAllCertificates();
    string contextTokenString = TokenHelper.GetContextTokenFromRequest(Request);

    if (contextTokenString != null)
    {
        // Get context token
        contextToken = TokenHelper.ReadAndValidateContextToken(contextTokenString, Request.Url.Authority);

        // Get access token
        sharepointUrl = new Uri(Request.QueryString["SPAppWebUrl"]);
        accessToken = TokenHelper.GetAccessToken(contextToken, sharepointUrl.Authority).AccessToken;
        
        // Pass the access token to the button event handler.
        Button1.CommandArgument = accessToken;
    }
}
```

  5. Добавьте к классу **Default** приведенный ниже обработчик событий. Сначала обработчик получает маркер доступа, который был сохранен в свойстве [CommandArgument](http://msdn2.microsoft.com/ru-RU/library/hykdabtx) кнопки.
    
```C#
  protected void Button1_Click(object sender, EventArgs e)
{
    // Retrieve the access token that the Page_Load method stored
    // in the button's command argument.
    string accessToken = ((Button)sender).CommandArgument;
}
```

  6. Обработчику требуется заново получить измененный URL-адрес сайта надстройки при обратной передаче, поэтому следует добавить приведенный ниже код.
    
```C#
  if (IsPostBack)
{
    sharepointUrl = new Uri(Request.QueryString["SPAppWebUrl"]);
}
```

  7. Для получения данных списка добавьте приведенную ниже строку, в которой используется одна из конечных точек SharePoint REST/OData. В этом примере код считывает список **Герои пьесы "Гамлет"**, развернутый на сайте надстройки. Благодаря API для этой службы достаточно одной строки кода, чтобы выбрать список и указать три возвращаемых поля. Обратите внимание, что в URL-адресе OData необходимо использовать внутренние имена полей (столбцов), а не отображаемые имена, поэтому в коде используются значения `Title`, `Actor` и `CastingStatus`, а не `Character`, `Actor/Actress` и `Casting Status.`. Дополнительные сведения о веб-службе REST/OData см. в статье [Использование операций запросов OData в запросах SharePoint REST](use-odata-query-operations-in-sharepoint-rest-requests.md).
    
```C#
  // REST/OData URL section
 string oDataUrl = "/_api/Web/lists/getbytitle('Characters In Hamlet')/items?$select=Title,Actor,CastingStatus";
```

  8. Добавьте приведенный ниже код, создающий объекты HTTP-запроса и отклика с помощью классов [HttpWebRequest](http://msdn2.microsoft.com/ru-RU/library/8y7x3zz2) и [HttpWebResponse](http://msdn2.microsoft.com/ru-RU/library/ww5755y6) из пространства имен [System.Net](http://msdn2.microsoft.com/ru-RU/library/btdf6a7e).
    
```C#
  // HTTP Request and Response construction section
HttpWebRequest request = (HttpWebRequest)HttpWebRequest.Create(sharepointUrl.ToString() + oDataUrl);
request.Method = "GET";
request.Accept = "application/atom+xml";
request.ContentType = "application/atom+xml;type=entry";
request.Headers.Add("Authorization", "Bearer " + accessToken);
HttpWebResponse response = (HttpWebResponse)request.GetResponse();
```

  9. Для выполнения синтаксического анализа XML-ответа в формате ATOM добавьте следующий код. Он использует классы области имен  [System.Xml.Linq](http://msdn2.microsoft.com/ru-RU/library/bb299195) для синтаксического анализа возвращенных данных и создания [List<T>](http://msdn2.microsoft.com/ru-RU/library/6sh2ey19) элементов из списка SharePoint. (Вы также могли бы использовать классы области имен [System.Xml](http://msdn2.microsoft.com/ru-RU/library/y3y47afh) .) Обратите внимание, что в XML-файле, возвращаемом SharePoint, дочерние элементы элемента **entry** содержат метаданные об элементе списка. Фактические данные строк элемента списка SharePoint размещаются двумя уровнями ниже в элементе **properties**. По этой причине для отфильтровывания верхних уровней дважды используется метод расширения  [Elements<T>](http://msdn2.microsoft.com/ru-RU/library/bb348465)
    
```C#
  // Response markup parsing section
XDocument oDataXML = XDocument.Load(response.GetResponseStream(), LoadOptions.None);
XNamespace atom = "http://www.w3.org/2005/Atom";
XNamespace d = "http://schemas.microsoft.com/ado/2007/08/dataservices";
XNamespace m = "http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"; 

List<XElement> entries = oDataXML.Descendants(atom + "entry")
                         .Elements(atom + "content")
                         .Elements(m + "properties")
                         .ToList();
```

  10. Добавьте приведенный ниже запрос LINQ, чтобы создать коллекцию [IEnumerable<T>](http://msdn2.microsoft.com/ru-RU/library/9eekhta0) анонимного типа, включающего только необходимые нам свойства. Обратите внимание: несмотря на то что код должен ссылаться на поле имени элемента по его внутреннему имени (`Title`), в качестве имени свойства в анонимном типе, которому назначается значение, можно указать значение `Character`. В результате после привязки коллекции к элементу управления сетки на странице будет отображаться более понятное название — **Персонаж**.
    
```C#
  var entryFieldValues = from entry in entries
                       select new { Character=entry.Element(d + "Title").Value, 
                                    Actor=entry.Element(d + "Actor").Value, 
                                    CastingStatus=entry.Element(d + "CastingStatus").Value };

```

  11. Завершите настройку обработчика следующим кодом, привязывающим данные к элементу контроля  [GridView](http://msdn2.microsoft.com/ru-RU/library/4w7ya1ts) на странице. Заголовкам столбцов в сетке по умолчанию присваиваются имена свойств анонимного типа: `Character`,  `Actor` и `CastingStatus`. Элемент управления  [GridView](http://msdn2.microsoft.com/ru-RU/library/4w7ya1ts) имеет свойства, позволяющие управлять именем и форматировать заголовки колонок, поэтому вы можете сделать так, чтобы имена **Actor/Actress** (Актер/актриса) и **Casting Status** (Статус кастинга) совпадали с заголовками колонок в SharePoint. Чтобы избежать сложностей, эти методы здесь не описываются. (Вы можете также использовать элемент управления [DataGrid](http://msdn2.microsoft.com/ru-RU/library/e1zk1ey1) .)
    
```C#
  GridView1.DataSource = entryFieldValues;
GridView1.DataBind();

```

  12. Сохраните все файлы.
    
 

### <a name="to-test-and-debug-the-sharepoint-add-in"></a>Тестирование и отладка надстройки SharePoint


1. Чтобы протестировать надстройку SharePoint и ее удаленное веб-приложение, в Visual Studio 2012 нажмите клавишу F5. Веб-приложение будет развернуто в IIS Express в localhost. Надстройка SharePoint будет установлена на целевом веб-сайте SharePoint. (В нашем примере удаленная надстройка *не* пытается взаимодействовать с *хост*-сайтом, и субъект надстройки автоматически получает разрешения для доступа к сайту *надстройки*, поэтому для вас *не* отображается предложение предоставить разрешения.) Откроется страница **Содержимое сайта** целевого веб-сайта SharePoint, на которой отобразится новая надстройка.
    
 
2. Выберите надстройку SharePoint, и удаленное веб-приложение откроется на странице, указанной в элементе **StartPage** файла AppManifest.xml. Откройте приложение и проверьте его работоспособность. В нашем примере достаточно нажать кнопку. После этого будет создана таблица, заполненная элементами списка **Герои пьесы "Гамлет"** с сайта надстройки.
    
 

## <a name="publishing-the-sharepoint-add-in"></a>Публикация надстройки SharePoint
<a name="Publish"> </a>

Чтобы опубликовать вашу надстройку SharePoint, отправьте пакет надстройки в корпоративный каталог надстроек или в магазин надстроек Office. Дополнительные сведения см. в разделах  [Публикация в Магазин Office или каталоге надстроек организации](deploying-and-installing-sharepoint-add-ins-methods-and-options.md#MarketOrCatalog) и [Публикация надстроек для SharePoint](publish-sharepoint-add-ins.md).
 

 

## <a name="troubleshooting"></a>Устранение неполадок
<a name="Troubleshooting"> </a>

Если надстройка не работает, рекомендуется проверить, не является ли это следствием ошибки разметки CAML, блокирующей развертывание компонентов SharePoint. Чтобы проверить развертывание, используйте процедуру, аналогичную описанной ниже.
 

 

### <a name="to-test-the-provisioning-of-the-add-in-web"></a>Проверка подготовки сайта надстройки


1. Откройте страницу **Параметры сайта** на хост-сайте. В разделе **Администрирование семейства веб-сайтов** выберите ссылку **Иерархия сайтов**.
    
 
2. На странице **Иерархия сайтов** вы увидите свою надстройку, указанную по URL-адресу. Не запускайте ее. Вместо этого скопируйте URL-адрес и используйте его URL на оставшихся этапах.
    
 
3. Перейдите по адресу _URL-адрес_сайта_приложения_/_layouts/15/ManageFeatures.aspx и на открывшейся странице **Возможности сайта** убедитесь, что возможность **Компоненты данных театра и кино** указана в алфавитном списке возможностей вашей надстройки SharePoint, а ее состояние — **Активна**.
    
 
4. Перейдите по адресу _URL-адрес_сайта_приложения_/_layouts/15/mngfield.aspx и на открывшейся странице **Столбцы сайта** убедитесь, что группа **Театр и кино** отображается в списке столбцов сайта и содержит новые настраиваемые столбцы сайта: **Актер или актриса** и **Статус кастинга**.
    
 
5. Перейдите по адресу _URL-адрес_сайта_приложения_/_layouts/15/mngctype.aspx и на открывшейся странице **Типы контента сайта** убедитесь, что группа **Театр и кино** указана в списке типов контента и содержит новый тип контента — **ActingRole**.
    
 
6. Перейдите по ссылке на тип контента **ActingRole**. На открывшейся странице **Тип контента сайта** убедитесь, что тип контента содержит два новых типа столбцов сайта, **Актер или актриса** и **Статус кастинга**, а в поле названия элемента указано заданное вами отображаемое имя: **Персонаж**.
    
 
7. Перейдите по адресу _URL-адрес_сайта_приложения_/_layouts/15/mcontent.aspx и на открывшейся странице **Списки и библиотеки сайта** проверьте наличие ссылки **Настроить "Герои пьесы «Гамлет»"**.
    
 
8. Перейдите по ссылке **Настроить "Герои пьесы «Гамлет»"** и убедитесь, что на странице параметров списка единственный тип контента для списка — это **ActingRole**, а два новых столбца сайта, **Актер или актриса** и **Статус кастинга** указаны в разделе **Столбцы**. Столбец заголовка может быть обозначен внутренним именем **Title**, а не присвоенным вами отображаемым именем **Персонаж**.
    
     **Примечание.** Если на этой странице отсутствует раздел **Типы контента**, необходимо включить управление типами контента. Перейдите по ссылке **Дополнительные параметры**, а затем на странице **Дополнительные параметры** включите управление типами контента и нажмите кнопку **ОК**. Снова откроется предыдущая страница, которая теперь содержит раздел **Типы контента**.
9. В верхней части страницы указан **веб-адрес** списка. Скопируйте его и вставьте в адресной строке вашего браузера, а затем перейдите к списку. Убедитесь, что список содержит элементы, созданные вами качестве образцов. Столбец заголовка может появиться на экране с внутренним именем **Title** вместо присвоенного вами отображаемого имени **Персонаж**.
    
 

## <a name="next-steps"></a>Дальнейшие действия
<a name="NextSteps"> </a>

В данной статье показано, как создать несложную комбинацию надстройки SharePoint с удаленным веб-приложением. Ниже указаны некоторые действия, которые вы можете предпринять дальше.
 

 

- Добавление в надстройку всех функций CRUD с помощью конечных точек REST/OData или с помощью одной из клиентских объектных моделей. Дополнительные сведения см. в статье [Использование операций запросов OData в запросах SharePoint REST](use-odata-query-operations-in-sharepoint-rest-requests.md) и [Выполнение базовых операций с помощью кода клиентской библиотеки SharePoint](complete-basic-operations-using-sharepoint-client-library-code.md).
    
 
- Локализация надстройки SharePoint для других языков. Дополнительные сведения см. в статье [Локализация надстроек SharePoint](localize-sharepoint-add-ins.md).
    
 
- Создание надстройки-компаньона для Windows Phone, которая дублирует функции удаленного веб-приложения. Дополнительные сведения см. в разделе  [Создание мобильных надстроек для SharePoint 2013](http://msdn.microsoft.com/ru-RU/library/office/jj163228.aspx).
    
 

## <a name="additional-resources"></a>Дополнительные ресурсы
<a name="SP15createcloud_bk_addlresources"> </a>


-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md)
    
 
-  [Знакомство с созданием надстроек SharePoint с размещением в SharePoint](get-started-creating-sharepoint-hosted-sharepoint-add-ins.md)
    
 

