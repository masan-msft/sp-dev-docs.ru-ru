
# <a name="programmatically-deploy-a-custom-button-in-the-provider-hosted-add-in"></a>Программное развертывание настраиваемой кнопки в надстройке, размещенной у поставщика
Узнайте, как программным путем зарегистрировать настраиваемую кнопку ленты с настраиваемым списком в одной надстройке SharePoint, размещенной у поставщика.
 

 **Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint#bk_newname).
 

Это девятая часть серии статей, посвященной основам разработки надстроек SharePoint, размещаемых у поставщика. Для начала вам следует ознакомиться со статьей [Надстройки SharePoint](sharepoint-add-ins) и предыдущими статьями из этой серии.
 

-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins)
    
 
-  [Настройка внешнего вида надстройки SharePoint, размещенной у поставщика](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel)
    
 
-  [Добавление настраиваемой кнопки в надстройку, размещенную у поставщика](include-a-custom-button-in-the-provider-hosted-add-in)
    
 
-  [Краткий обзор объектной модели SharePoint](get-a-quick-overview-of-the-sharepoint-object-model)
    
 
-  [Добавление операций записи SharePoint в надстройку, размещенную у поставщика](add-sharepoint-write-operations-to-the-provider-hosted-add-in)
    
 
-  [Добавление веб-части надстройки в надстройку, размещенную у поставщика](include-an-add-in-part-in-the-provider-hosted-add-in)
    
 
-  [Обработка событий надстройки, размещенной у поставщика](handle-add-in-events-in-the-provider-hosted-add-in)
    
 
-  [Добавление логики, выполняемой при первом запуске, в надстройку, размещаемую у поставщика](add-first-run-logic-to-the-provider-hosted-add-in)
    
 

 **Примечание.** Если вы изучали предыдущие статьи этой серии о надстройках, размещаемых у поставщика, то у вас уже есть решение для Visual Studio, которое можно использовать для работы с данной статьей. Кроме того, вы можете скачать репозиторий [SharePoint_SP-hosted_Add-Ins_Tutorials](https://github.com/OfficeDev/SharePoint_Provider-hosted_Add-ins_Tutorials) и открыть файл BeforeProgrammaticButton.sln.
 

Из данной статьи вы узнаете, как включать настраиваемую кнопку ленты в Надстройка SharePoint, когда список, лента которого получает кнопку, также развертывается программным способом в той же самой надстройке.
 

## <a name="re-add-the-custom-button-to-the-project"></a>Повторное добавление настраиваемой кнопки в проект


 **Примечание.** Параметры запускаемых проектов в Visual Studio обычно возвращаются к значениям по умолчанию каждый раз, когда вы заново открываете решение. Открывая пример решения, рассматриваемый в этой серии статей, всегда выполняйте следующие действия: щелкните правой кнопкой мыши узел решения в **обозревателе решений** и выберите пункт **Назначить запускаемые проекты**, а затем убедитесь, что для всех трех проектов в столбце **Действие** задано значение **Запуск**.
 

В предыдущей статье описывалось удаление настраиваемой кнопки ленты **AddEmployeeToCorpDB** из проекта. Чтобы добавить ее обратно, выполните указанные ниже действия.
 

 

1. Откройте **обозреватель решений** и на небольшой панели инструментов в верхней его части нажмите кнопку **Показать все файлы**.
    
  ![Панель инструментов обозревателя решений с рамкой вокруг кнопки "Показать все файлы".](../../images/f6b035f5-1aa7-452a-8f59-9dd44b062d06.PNG)
 

 

 
2. В проекте **ChainStore** щелкните правой кнопкой мыши элемент **AddEmployeeToCorpDB** и выберите пункт **Включить в проект**.
    
 
3. Еще раз нажмите кнопку **Показать все файлы**.
    
 
4. В проекте **ChainStore** разверните узел **AddEmployeeToCorpDB**, а затем откройте файл elements.xml.
    
 

## <a name="understand-a-dilemma-and-its-solution"></a>Описание проблемы и ее решение

В файле elements.xml атрибут **RegistrationId** элемента **CustomAction** служит для идентификации списка, на ленту которого добавляется кнопка: `{$ListId:Lists/Local Employees;}`. Этого было достаточно, когда список уже был добавлен на хост-сайт вручную. Но теперь, когда список развертывается с помощью кода, выполняемого при первом запуске, SharePoint устанавливает надстройку и пытается развернуть кнопку, но списка еще не существует. В этом случае установка надстройки может привести к возникновению исключения и завершиться со сбоем.
 

 
Развертывание списка в обработчике событий установки, а не в коде, выполняемом при первом запуске, не решит эту проблему. Это связано с тем, что SharePoint развертывает описанные настраиваемые компоненты, например настраиваемую кнопку (и веб-часть надстройки **Размещение заказа**), *перед тем как* запустить настраиваемый обработчик, поэтому когда SharePoint пытается развернуть кнопку, списка еще не существует.
 

 
Создание настраиваемой кнопки полностью программным способом непрактично по причинам, которые слишком сложны, чтобы обсуждать их здесь. К счастью, это не нужно. Существует относительно безболезненный способ полупрограммного создания настраиваемой кнопки и назначения ее настраиваемому списку. Ниже перечислены необходимые для этого основные действия.
 

 

1. Оставьте описательно определенную кнопку в проекте, но назначьте ее ленте какого-либо приложения, которое всегда имеется на сайтах SharePoint, а не ленте списка, который развертывается программным способом с помощью той же надстройки. 
    
 
2. В коде, выполняемом при первом запуске, после программного создания списка добавьте неопределенную кнопку на ленту списка.
    
 
3. Инициализируйте свойства новой кнопки, используя значения свойств исходной кнопки. Итак, на данный момент у нас имеются две идентичные кнопки. Вторая кнопка назначена ленте списка **Местные сотрудники**.
    
 
4. Удалите исходную кнопку программным способом.
    
 

## <a name="programmatically-register-the-custom-button"></a>Регистрация настраиваемой кнопки программным способом

Ниже описывается реализация этой стратегии.
 

 

1. В проекте **ChainStore** разверните узел **AddEmployeeToCorpDB**, откройте файл elements.xml, а затем измените значение атрибута **RegistrationId** элемента **CustomAction** на "100". Это идентификатор типа списка. Даже если на веб-сайте нет экземпляров списков этого типа, сам *тип* списка имеется на всех веб-сайтах SharePoint. Теперь атрибут должен выглядеть, как показано ниже.
    
```XML
  RegistrationId="100"
```

2. В файле SharePointComponentDeployer.cs добавьте указанную ниже строку в метод  `DeployChainStoreComponentsToHostWeb` сразу же после строки, в которой вызывается метод `CreateLocalEmployeesList`. Вы создадите этот метод на следующем этапе.
    
```C#
  ChangeCustomActionRegistration();
```

3. Добавьте приведенный ниже метод в класс `SharePointComponentDeployer`. Обратите внимание на указанные ниже особенности этого кода.
    
      - Так как дополнительное действие, то есть настраиваемая кнопка, было зарегистрировано на ленте для  *типа*  списка, область его действия распространяется на весь веб-сайт и находится в коллекции дополнительных действий веб-сайта. Таким образом, код получает его из этой коллекции.
    
 
  - Значение свойства `action.Name` поступает из атрибута **ID** элемента **CustomAction** в файле element.xml из узла **AddEmployeeToCorpDB**.
    
     **Важно!****Вам необходимо изменить значение `action.Name` в коде ниже, чтобы оно совпадало со значением в файле elements.xml.** Часть имени с идентификатором GUID будет другой. Обратите внимание, что GUID отделен точкой от остальной части имени. Ниже приведен пример строки. `where action.Name == "4a926a42-3577-4e02-9d06-fef78586b1bc.AddEmployeeToCorpDB"`

```C#
  private static void ChangeCustomActionRegistration()
{
    using (var clientContext = sPContext.CreateUserClientContextForSPHost())
    {
         var query = from action in clientContext.Web.UserCustomActions
                     where action.Name == "{button_GUID} .AddEmployeeToCorpDB"
                     select action;
          IEnumerable<UserCustomAction> matchingActions = clientContext.LoadQuery(query);          
             clientContext.ExecuteQuery();
    
          UserCustomAction webScopedEmployeeAction = matchingActions.Single();

         // TODO8: Get a reference to the (empty) collection of custom actions 
         // that are registered with the custom list.

         // TODO9: Add a blank custom action to the list's collection.

         // TODO10: Copy property values from the descriptively deployed
         // custom action to the new custom action

        // TODO11: Delete the original custom action.         

          clientContext.ExecuteQuery();
    }
}
```

4. Замените строку `TODO8` на приведенный ниже код.
    
    Обратите внимание, что если вы отзовете надстройку, созданные ею компоненты не будут удалены. По завершении работы кода, выполняемого при первом запуске, в коллекции **UserCustomActions** списка появится дополнительное действие, которое не будет отозвано при следующем нажатии клавиши F5. Во избежание путаницы в последней строке этого кода метод `listActions.Clear();` очищает коллекцию.
    


```C#
  var queryForList = from list in clientContext.Web.Lists
                   where list.Title == "Local Employees"
                   select list;
IEnumerable<List> matchingLists = clientContext.LoadQuery(queryForList);
clientContext.ExecuteQuery();

List employeeList = matchingLists.First();
var listActions = employeeList.UserCustomActions;
clientContext.Load(listActions);
listActions.Clear();
```

5. Замените строку `TODO9` на приведенную ниже строку. В список **Местные сотрудники** будет добавлено неопределенное дополнительное действие.
    
```C#
  var listScopedEmployeeAction = listActions.Add();
```

6. Замените строку `TODO10` на приведенный ниже код. Обратите внимание на указанные ниже особенности этого кода.
    
      - Он назначает значения свойств кнопки уровня веб-сайта (которая была развернута с помощью описательной разметки) соответствующим свойствам кнопки уровня списка, так что эти две кнопки становятся идентичными за исключением области их действия.
    
 
  - Свойство **Sequence** указывает относительное положение кнопки в соответствующей области на ленте. В данном случае кнопка находится в разделе **Действия** на вкладке **Элементы** ленты. В описательной части кода это значение составляло 10001. Это достаточно большое значение, чтобы кнопка отображалась после (справа от) всех встроенных кнопок, которые SharePoint помещает в раздел **Действия**.
    
 

```C#
  listScopedEmployeeAction.Title = webScopedEmployeeAction.Title;
listScopedEmployeeAction.Location = webScopedEmployeeAction.Location;
listScopedEmployeeAction.Sequence = webScopedEmployeeAction.Sequence;
listScopedEmployeeAction.CommandUIExtension = webScopedEmployeeAction.CommandUIExtension;
listScopedEmployeeAction.Update();
```

7. Замените  `TODO11` указанной ниже строкой, в которой выполняется удаление исходной описательным способом определенной кнопки. Если бы у нас не было этой строки, то на каждом списке на веб-сайте, для которого используется шаблон списка 100, была бы настраиваемая кнопка. Так как функциональность кнопки тесно связана со списком **Local Employees** (Местные сотрудники), то нет никакого смысла размещать эту кнопку в других списках. Кроме того, без этой строки кнопка будет *дважды*  размещена в списке **Local Employees** (Местные сотрудники), так как для этого списка используется шаблон 100.
    
```C#
  webScopedEmployeeAction.DeleteObject();
```


    The entire method should now look like the following (except there should be a GUID in place of the placeholder).
    


```C#
  private static void ChangeCustomActionRegistration()
{
    using (var clientContext = SPContext.CreateUserClientContextForSPHost())
    {
         var query = from action in clientContext.Web.UserCustomActions
                     where action.Name == "{button_GUID} .AddEmployeeToCorpDB"
                     select action;
          IEnumerable<UserCustomAction> matchingActions = clientContext.LoadQuery(query);          
             clientContext.ExecuteQuery();
    
          UserCustomAction webScopedEmployeeAction = matchingActions.Single();

         var queryForList = from list in clientContext.Web.Lists
                            where list.Title == "Local Employees"
                            select list;
         IEnumerable<List> matchingLists = clientContext.LoadQuery(queryForList);
         clientContext.ExecuteQuery();

        List employeeList = matchingLists.First();
        var listActions = employeeList.UserCustomActions;
        clientContext.Load(listActions);
        listActions.Clear();

        var listScopedEmployeeAction = listActions.Add();

        listScopedEmployeeAction.Title = webScopedEmployeeAction.Title;
        listScopedEmployeeAction.Location = webScopedEmployeeAction.Location;
        listScopedEmployeeAction.Sequence = webScopedEmployeeAction.Sequence;
        listScopedEmployeeAction.CommandUIExtension = webScopedEmployeeAction.CommandUIExtension;
        listScopedEmployeeAction.Update();

        webScopedEmployeeAction.DeleteObject();         

        clientContext.ExecuteQuery();
    }
}
```


## <a name="request-full-control-of-the-host-web"></a>Запрос полного доступа к хост-сайту

Так как теперь надстройка добавляет и удаляет дополнительные действия уровня веб-сайта, необходимо расширить разрешения для нее с уровня "Управление" до уровня "Полный контроль". Выполните указанные ниже действия.
 

 

1. В **обозревателе решений** откройте файл AppManifest.xml проекта **ChainStore**.
    
 
2. Откройте вкладку **Разрешения**. Для поля **Область** оставьте значение **Интернет**, а в поле **Разрешение** выберите из раскрывающегося списка пункт **Полный доступ**.
    
 
3. Сохраните файл.
    
 

## <a name="run-the-add-in-and-test-the-button-deployment"></a>Запуск надстройки и тестирование развертывания кнопки


 

 

1. Откройте страницу **Содержимое сайта** для веб-сайта магазина в Гонконге *и удалите список **Местные сотрудники**.* 
    
     **Примечание.** При отзыве надстройки в Visual Studio не будут удалены созданные ею списки, поэтому вам потребуется вручную удалять их каждый раз, когда вы тестируете создающий их код.
2. Нажмите клавишу F5, чтобы развернуть и запустить вашу надстройку. Visual Studio размещает удаленное веб-приложение в IIS Express, а базу данных SQL в SQL Express. Кроме того, он создает временную установку надстройки на вашем тестовом сайте SharePoint и немедленно запускает ее. Прежде чем откроется начальная страница надстройки, вам будет предложено предоставить надстройке необходимые разрешения.
    
 
3. Когда откроется начальная страница надстройки, нажмите кнопку **Вернуться на сайт** на расположенном в верхней части элементе управления хрома.
    
 
4. Перейдите на страницу **Содержимое сайта**. Список **Местные сотрудники** отображается, потому что его добавил код, выполняемый при первом запуске.
    
     **Примечание.** Если список не отображается или имеются другие признаки того, что код для первого запуска не выполняется, это может быть вызвано тем, что таблица **Tenants** (Клиенты) не очищается при нажатии клавиши F5. Как правило, это связано с тем, что проект **ChainCorporateDB** больше не задан в качестве запускаемого проекта в Visual Studio. В начале этой статьи есть примечание о том, как это исправить. Кроме того, убедитесь, что база данных настроена на повторное создание, как описано в разделе [Настройка Visual Studio на повторное создание корпоративной базы данных в каждом сеансе отладки](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel#Rebuild).
5. Откройте список и добавьте элемент.
    
 
6. В представлении списка выберите этот элемент и откройте вкладку **Элемент** на ленте. На ленте имеется кнопка **Добавить в корпоративную базу данных**.
    
 
7. Нажмите эту кнопку. Сотрудник будет добавлен в корпоративную базу данных, а значение поля **Добавлено в корпоративную базу данных** изменится на **Да**.
    
 
8. Вернитесь на страницу **Содержимое сайта** и нажмите **Добавить надстройку**.
    
 
9. Добавьте новый **настраиваемый список**. По умолчанию он будет относиться к типу Generic (ему соответствует значение 100). После создания списка откройте вкладку **Элемент** на ленте. Обратите внимание, что кнопки **Добавить в корпоративную базу данных** *нет* на ленте. Это связано с тем, что код удалил кнопку на уровне веб-сайта.
    
 
10. Чтобы завершить сеанс отладки, закройте окно браузера или остановите отладку в Visual Studio. При каждом нажатии клавиши F5 Visual Studio будет отзывать предыдущую версию надстройки и устанавливать ее последнюю версию.
    
 
11. Эти надстройка и решение Visual Studio будут рассматриваться и в других статьях, поэтому при перерывах в работе рекомендуется отзывать надстройку. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункт **Отозвать**.
    
 

## 
<a name="Nextsteps"> </a>

 Для событий в списках и элементах списков также можно использовать настраиваемые обработчики в SharePoint. Сведения о том, как создать такой обработчик и развернуть его в коде, выполняемом при первом запуске, см. в статье [Обработка событий элемента списка в надстройке, размещаемой у поставщика](handle-list-item-events-in-the-provider-hosted-add-in).
 

 

