# <a name="creating-sharepoint-add-ins-that-use-low-trust-authorization"></a>Создание надстроек SharePoint, использующих авторизацию с низким уровнем доверия
Сведения о системе авторизации с низким уровнем доверия для надстроек SharePoint.
 

 **Примечание.** Название "приложения для SharePoint" меняется на "надстройки SharePoint". Пока изменения не будут внесены полностью, в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio по-прежнему может встречаться термин "приложение". Дополнительные сведения см. в статье [Название "приложения для Office и SharePoint" изменилось на "надстройки Office и SharePoint"](new-name-for-apps-for-sharepoint#bk_newname).
 

Удаленные компоненты в надстройке SharePoint (или внешнем приложении) могут получить авторизацию для ресурсов SharePoint, передавая маркер доступа в SharePoint с каждым HTTP-запросом. Удаленные компоненты получают маркер доступа от учетной записи службы контроля доступа Microsoft Azure (ACS), связанной с областью клиентов Office 365 клиента. Azure ACS действует как сервер авторизации в транзакции [OAuth 2.0](http://oauth.net/), называемой потоком. При этом SharePoint служит сервером ресурсов, а удаленные компоненты клиентом. Спецификации протокола см. на веб-странице [Протокол веб-авторизации (oauth)](http://datatracker.ietf.org/doc/active/#oauth). 
 

Надстройки для SharePoint с размещением у поставщика, которые используют систему авторизации с низким уровнем доверия, можно продавать в Магазин Office и устанавливать в Microsoft SharePoint Online или в локальной ферме SharePoint, настроенной для использования области клиентов Office 365 для установки доверия с использованием Azure ACS. У пользователя должна быть область клиентов Office 365 для установки надстроек для SharePoint, которые используют систему с низким уровнем доверия. Но пользователю не обязательно применять область клиентов в других целях. Инструкции по связыванию локальной фермы с областью клиентов Office 365 см. в разделе  [Использование сайта Office 365 SharePoint для авторизации размещенных у поставщика надстроек на локальном сайте SharePoint](use-an-office-365-sharepoint-site-to-authorize-provider-hosted-add-ins-on-an-on-premises-sharepoint-site).
 


## <a name="registration-with-azure-acs"></a>Регистрация в Azure ACS
<a name="Registration"> </a>

Чтобы использовать систему с низким уровнем доверия, сначала необходимо зарегистрировать надстройку для SharePoint в Azure ACS и в службе управления приложениями фермы SharePoint или области клиентов SharePoint Online. ("Служба управления приложениями" получила такое название, так как надстройки SharePoint ранее назывались "приложениями для SharePoint".) Надстройки, для продажи которых используется Магазин Office, регистрируются в ACS на Панели мониторинга продаж, при этом регистрация с помощью службы происходит во время установки надстройки. Если надстройки распространяются через каталог надстроек организации, они регистрируются в ACS и службе на странице \_Layouts\15\AppRegNew.aspx любой области клиентов SharePoint или фермы, в которой устанавливается надстройка. Кроме того, необходимо зарегистрировать внешние приложения (не для SharePoint), обращающиеся к SharePoint. К ним относятся надстройки Office, приложения Магазина Windows, веб-приложения и приложения для устройств, например для смартфонов.
 

 

 **Примечание.** Для регистрации необходимо, чтобы у приложения был интернет-домен. Для этой цели можно использовать любой существующий домен, но невозможно быть полностью уверенным в том, что домен, который вам не принадлежит, будет существовать всегда. Поэтому веб-приложение должно быть частью приложения для устройства, даже если компонент веб-приложения используется только для регистрации. Расширенный пример кода с таким подходом см. в статье [Пакетная подготовка сайтов с использованием модели надстроек](http://code.msdn.microsoft.com/Provision-sites-in-batches-fcf31bc6).
 

Дополнительные сведения о регистрации см. в статье [Регистрация надстроек SharePoint 2013](register-sharepoint-add-ins-2013).
 

 

### <a name="add-in-secret-expiration"></a>Окончание срока действия секрета надстройки

Секрет надстройки необходимо менять каждые 12 месяцев. Подробнее об этом см. в статье [Замена секрета клиента в надстройке SharePoint с истекающим сроком действия](replace-an-expiring-client-secret-in-a-sharepoint-add-in).
 

 

## <a name="authorization-policies"></a>Политики авторизации
<a name="Policies"> </a>

Надстройка SharePoint может использовать одну из двух политик авторизации:
 

 

-  **Политика для пользователя и надстройки.** Надстройки, использующие эту политику, могут выполнять только те действия, на которые и у пользователя, и у надстройки есть разрешения. Это политика по умолчанию, которая используется, если разработчик явно не назначит другую политику.
    
 
-  **Политика только для надстройки.** Надстройки, использующие эту политику, могут выполнять любые действия, для которых у них есть разрешения, даже если у пользователя нет таких разрешений. Разработчику следует запросить применение этой политики в манифесте надстройки. Пользователь, устанавливающий надстройку, должен утвердить такой запрос. Эта политика разрешена только для надстроек для SharePoint с размещением у поставщика.
    
 
Дополнительные сведения о политиках авторизации см. в статье [Типы политик авторизации надстроек в SharePoint](add-in-authorization-policy-types-in-sharepoint-2013).
 

 

## <a name="two-oauth-runtime-flows"></a>Два потока среды выполнения OAuth
<a name="Flows"> </a>

При каждом запуске надстройки для SharePoint с размещением в облаке или внешнего приложения, обращающихся к SharePoint, возникает поток (ряд операций взаимодействия между надстройкой, SharePoint, ACS и иногда конечным пользователем). В результате SharePoint получает маркер доступа, включенный в каждый запрос на создание, обновление или удаление (CRUD), который приложение отправляет в SharePoint.
 

 
Существует два основных потока OAuth, которые используются SharePoint. Один предназначен для размещенных в облаке надстроек для SharePoint, а другой, который называют "динамическим" для приложений на других платформах, получающих доступ к данным SharePoint.
 

 

-  **Поток маркеров контекста**. Удаленный компонент, входящий в надстройку для SharePoint, использует клиентскую объектную модель (CSOM) SharePoint или конечные точки REST для вызова SharePoint. SharePoint запрашивает маркер контекста у ACS, который он может отправить удаленному серверу. Удаленный сервер использует маркер контекста, чтобы запросить маркер доступа у ACS. Затем удаленный сервер использует маркер доступа для обратного вызова SharePoint. Дополнительные сведения см. в разделе  [Поток маркеров контекста OAuth для надстроек в SharePoint](context-token-oauth-flow-for-sharepoint-add-ins).
    
 
-  **Поток кода проверки подлинности.** Во время своей установки Надстройка SharePoint получает необходимые разрешения для ресурсов SharePoint. Но приложения, не установленные в SharePoint, должны запрашивать разрешения динамически, т. е. при каждом запуске. В этом потоке маркер контекста SharePoint отсутствует. Вместо этого, когда приложение запускается и пытается получить доступ к SharePoint, SharePoint запрашивает у пользователя разрешения для приложения. Когда пользователь предоставляет разрешения, SharePoint получает код авторизации от ACS, который затем передает приложению. Приложение использует этот код, чтобы получить маркер доступа у ACS, который затем использует для связи с SharePoint. Дополнительные сведения об этом потоке см. в разделе [Поток кода аутентификации OAuth для надстроек в SharePoint](authorization-code-oauth-flow-for-sharepoint-add-ins).
    
 

## <a name="troubleshooting-low-trust-sharepoint-add-ins"></a>Устранение неполадок надстроек SharePoint с низким уровнем доверия
<a name="Trouble"> </a>

Эта статья содержит некоторые общие рекомендации по устранению неполадок и сведения об определенных проблемах с надстройками SharePoint, которые используют систему авторизации с низким уровнем доверия.
 

 

### <a name="use-the-fiddler-tool"></a>Использование средства Fiddler

С помощью бесплатного  [средства Fiddler](http://www.telerik.com/fiddler) можно захватывать HTTP-запросы, отправленные удаленным компонентом вашей надстройки в SharePoint. Для этого [средства есть бесплатное расширение](https://github.com/andrewconnell/SPOAuthFiddlerExt), автоматически декодирующее маркеры доступа в запросах.
 

 

### <a name="turn-off-the-https-requirement-for-oauth-during-development"></a>Отключение требования использовать протокол HTTPS для OAuth во время разработки
<a name="TurnOffHTTPRequirement"> </a>

Для применения OAuth требуется, чтобы служба SharePoint и SharePoint использовали протокол HTTPS. Это мешает при разработке надстройки. Например, вы можете получить сообщение об ошибке 403 ("Запрещено") при попытке вызова SharePoint во время отладки надстройки, так как на компьютере localhost, на котором запущена ваша надстройка, нет поддержки SSL.
 

 
Вы можете отключить обязательное использование HTTPS при разработке с помощью указанных ниже командлетов Windows PowerShell.
 

 



```
$serviceConfig = Get-SPSecurityTokenServiceConfig
$serviceConfig.AllowOAuthOverHttp = $true
$serviceConfig.Update()

```

Чтобы позже снова включить обязательное использование HTTPS, воспользуйтесь указанными ниже командлетами Windows PowerShell.
 

 



```
$serviceConfig = Get-SPSecurityTokenServiceConfig
$serviceConfig.AllowOAuthOverHttp = $false
$serviceConfig.Update()

```


### <a name="miscellaneous-ssl-and-domain-related-authorization-errors"></a>Прочие ошибки авторизации, связанные с протоколом SSL и доменами
<a name="DomainRelatedErrors"> </a>

Авторизации может препятствовать несовпадение доменных имен в файлах конфигурации и регистрационных формах. Следующие четыре значения должны полностью совпадать:
 

 

- **Домен надстройки**, указываемый при регистрации надстройки SharePoint на странице AppRegNew.aspx или на Панели мониторинга продаж.
    
 
- Домен, на котором зарегистрирован сертификат безопасности удаленного веб-приложения.
    
 
- Доменная часть значения **StartPage** в файле AppManifest.xml.
    
 
- Доменная часть URL-адресов всех приемников событий, указанных в файле AppManifest.xml.
    
 
В связи с этим учтите указанные ниже особенности.
 

 

- Если удаленный компонент вашей надстройки для SharePoint использует какой-либо другой порт, а не порт 443, необходимо явно включить этот порт в качестве части домена во всех четырех местах. Пример:  `contoso.com:3333`. (Необходимо использовать протокол HTTPS, для которого по умолчанию используется порт 443.)
    
 
- Если для своего удаленного веб-приложения вы создаете псевдоним DNS CNAME, укажите псевдоним CNAME для значения домена во всех четырех случаях. Например, если приложение размещено в contoso.cloudapp.net и вы создали для него CNAME contososoftware.com, используйте contososoftware.com в качестве домена.
    
 
- До создания пакета надстройки необходимо задать домен в значении **StartPage** (а также URL-адресе каждого приемника событий) файла AppManifest.xml. Если для создания такого пакета вы используете мастер **публикации** в Visual Studio, то он подскажет вам домен, а Инструменты разработчика Office для Visual Studio автоматически вставят его в значение **StartPage**. То есть маркер `~remoteWebUrl`, который используется при отладке, будет заменен. Но если вы не используете мастер **публикации** (или используете его, но ваше удаленное веб-приложение развернуто в Azure), необходимо вручную заменить маркер на домен (и протокол). Например, на `https://contososoftware.com` или `https://MyCloudVM:3333`).
    
 

### <a name="error-the-underlying-connection-was-closed-could-not-establish-trust-relationship-for-the-ssltls-secure-channel"></a>Ошибка "Базовое соединение закрыто: не удалось установить доверительные отношения для защищенного канала SSL/TLS".
<a name="ErrorConnectionClosed"> </a>

Такое сообщение возникает из-за проблемы со связью SSL, а не с OAuth. Убедитесь, что SharePoint доверяет сертификату, который вы используете, и что этот сертификат соответствует имени конечной точки.
 

 

### <a name="errors-using-http-dav-method-to-read-files-from-sharepoint"></a>Ошибки при использовании метода HTTP DAV для чтения файлов из SharePoint
<a name="ErrorConnectionClosed"> </a>

HTTP DAV не работает с OAuth. Если вы используете клиентскую объектную модель (CSOM) SharePoint, то для чтения файла используйте указанный ниже код.
 

 

```C#
File f = clientContext.Web.GetFileByServerRelativeUrl( url);
ClientResult<Stream> r = f.OpenBinaryStream();
clientContext.ExecuteQuery();

```


## <a name="in-this-section"></a>В этом разделе:
<a name="Trouble"> </a>

 [Использование сайта SharePoint Office 365 для авторизации размещенных у поставщика надстроек на локальном сайте SharePoint](use-an-office-365-sharepoint-site-to-authorize-provider-hosted-add-ins-on-an-on-premises-sharepoint-site)
 

 
 [Поток OAuth токена контекста для надстроек SharePoint](context-token-oauth-flow-for-sharepoint-add-ins)
 

 
 [Поток кода авторизации OAuth для надстроек SharePoint](authorization-code-oauth-flow-for-sharepoint-add-ins)
 

 
 [Замена секрета клиента с истекающим сроком действия в надстройке SharePoint](replace-an-expiring-client-secret-in-a-sharepoint-add-in)
 

 

## <a name="additional-resources"></a>Дополнительные ресурсы
<a name="FileName_AdditionalResources"> </a>


-  [Регистрация надстроек SharePoint 2013](register-sharepoint-add-ins-2013)
    
 

