
# <a name="handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins"></a>Обработка маркеров безопасности в надстройках SharePoint с низким уровнем доверия, размещенных у поставщика
Узнайте о маркерах контекста, доступа и обновления, используемых для авторизации в Надстройки SharePoint с низким уровнем доверия и размещением у поставщика, а также о принципах работы с ними в коде.
 

 **Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint#bk_newname).
 


 **Важно!**   **Эта статья полностью посвящена использованию токенов безопасности в системах авторизации с низким уровнем доверия.** Сведения об использовании маркеров в системах с высоким уровнем доверия см. в статье [Создание и использование маркеров доступа в надстройках с высоким уровнем доверия для SharePoint, размещаемых у поставщика](create-and-use-access-tokens-in-provider-hosted-high-trust-sharepoint-add-ins).
 


 **Надстройки SharePoint, которые для получения доступа к данным SharePoint используют  [систему авторизации с низким уровнем доверия](creating-sharepoint-add-ins-that-use-low-trust-authorization). Они участвуют в потоке OAuth, связанном с прохождением токенов безопасности (в формате [JSON Web Token](http://datatracker.ietf.org/doc/draft-ietf-oauth-json-web-token/)) в SharePoint, Служба контроля доступа Microsoft Azure (ACS), удаленных компонентах Надстройка SharePoint и, в некоторых случаях, браузере пользователя.** Потоки отличаются в зависимости от дизайна надстройки, но все они связаны по крайней мере с такими двумя типами маркеров:
 


-  **Маркер доступа.** Входит в каждый запрос на создание, считывание, обновление или удаление, который удаленные компоненты надстройки отправляют в SharePoint. SharePoint проверяет маркер и обрабатывает запрос.
    
 
-  **Маркер обновления.** Служит для получения первого маркера доступа в [потоке маркера контекста](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows) и замены маркеров доступа в нем и [потоке кода авторизации](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows) системы авторизации с низким уровнем доверия после истечения срока их действия.
    
 
В зависимости от того, какой поток OAuth использует надстройка, в процесс включается один из указанных ниже элементов.
 

-  **Маркер контекста.** С его помощью в потоке маркера контекста удаленный компонент получает маркер обновления и сведения, необходимые для запроса маркера доступа из Azure ACS.
    
 
-  **Код авторизации.** Он уникален для каждой пары пользователя и приложения. Используется в потоке кода авторизации для получения первого маркера доступа и маркера обновления.
    
 

## <a name="understand-the-handling-of-access-tokens"></a>Общие сведения об обработке маркеров доступа
<a name="AccessTokens"> </a>

В системах авторизации с низким уровнем доверия Azure ACS создает маркеры доступа и отправляет их удаленным компонентам надстройки SharePoint. (На момент написания этой статьи продолжительность существования маркера доступа для SharePoint, выпущенного службой контроля доступа, составляла 12 часов, но это могло измениться.) Ниже указаны основные **функции кода в надстройке SharePoint**.
 

 

-  **Запрос маркера доступа** из Azure ACS. В зависимости от используемого потока OAuth для отправки запроса надстройка использует код авторизации или сведения, извлеченные из маркера контекста.
    
 
-  **Включение маркера в каждый HTTP-запрос в SharePoint.** Маркер добавляется в запрос в качестве заголовка **Authorization** со значением в таком виде: слово Bearer, пробел, маркер доступа с кодировкой Base64.
    
 
- **Кэширование маркера доступа** для повторного использования в последующих запросах (необязательно, но рекомендуется).
    
 
- Пересылка маркера доступа в серверные системы, чтобы они могли получать прямой доступ к SharePoint (необязательно).
    
 
Эти задачи необходимо выполнять с помощью серверного кода. Если вы используете управляемый код, пример кода для некоторых задач находится в файлах SharePointContext и TokenHelper (с расширением CS или VB), которые входят в Инструменты разработчика Microsoft Office для Visual Studio. Пример кода PHP, который выполняет часть этих задач, см. в статье  [Знакомство с REST-интерфейсом SharePoint и его использование](http://msdn.microsoft.com/en-us/magazine/dn198245.aspx).
 

 

### <a name="cache-the-access-token"></a>Кэширование маркера доступа
<a name="CacheAccessToken"> </a>

В зависимости от архитектуры надстройки SharePoint и платформы размещения существует несколько **способов кэширования маркеров доступа** на сервере.
 

 

- В состоянии сеанса.
    
 
- В состоянии приложения.
    
 
- В [службе кэширования Windows Server AppFabric](http://msdn.microsoft.com/library/8aef3f5d-2a77-46d9-b951-0768fedd31a1%28Office.15%29.aspx) или ее эквиваленте в ОС, отличных от ОС Майкрософт.
    
 
- В [службе кэширования Microsoft Azure](http://msdn.microsoft.com/library/7c679300-07cc-4ba1-b8fa-39421b570d56%28Office.15%29.aspx) или ее эквиваленте в облачных службах, отличных от облачных служб Майкрософт.
    
 
- В базе данных.
    
 
- В системе [memcached](http://www.memcached.org/).
    
 

 **Примечание.** В большинстве сценариев вы не сможете использовать простые термины, например AccessToken, в качестве ключа кэширования, так как надстройке необходимо хранить уникальные маркеры для каждого пользователя и фермы либо тенантности клиента SharePoint. Если надстройка использует [поток маркера контекста](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows), SharePoint предоставляет специальный ключ **CacheKey**, который можно использовать, чтобы различать кэшированные маркеры. В этом разделе описаны проблемы, возникающие, если надстройка не использует поток маркера контекста, и способы их решения.
 

Кэширование маркера доступа в состоянии сеанса подходит для большинства сценариев. Если удаленное веб-приложение получает доступ к другим службам, использующим протокол OAuth (в дополнение к SharePoint), и кэширует различные маркеры доступа в состоянии сеанса, используйте различные ключи кэша для маркеров. Например, вместо AccessToken используйте SharePoint_AccessToken, Facebook_AccessToken, SAP_Gateway_AccessToken. (Если вы не используете состояние сеанса или другой способ кэширования, который автоматически разделяет кэши всех пользователей, понадобится также соотнести ключи с каждым пользователем.)
 

 
Если приложение получает доступ к нескольким фермам SharePoint или тенантностям в Интернете, вы можете использовать домен SharePoint в первичном ключе кэширования приложения (SharePoint_*<mydomain>*.sharepoint.com_AccessToken") либо использовать ферму или область тенантности ("SharePoint_*<realmGUID>*_AccessToken"). И одно, и другое можно считать из маркера доступа. (Чтобы прочитать маркер, ваш код должен выполнить обратное кодирование Base 64 для маркера. В управляемом коде в файле TokenHelper.cs или VB-файле есть пример кода для этой цели. В нем используются классы из пространств имен **Microsoft.IdentityModel.S2S.Tokens** и **System.IdentityModel.Tokens**.) Доступен еще один вариант, когда приложение использует поток маркера контекста, как описано в следующем абзаце.
 

 
В некоторых сценариях приложению может потребоваться кэшировать маркер доступа в расположении, доступном этому приложению во время сеансов или после их завершения. Например, в приложении может быть доступна возможность планировать действия, выполняющиеся после его закрытия. Если такие действия связаны с доступом к SharePoint, надстройке нужно получить маркер доступа. В таких сценариях **приложение должно хранить уникальные маркеры для каждого пользователя**. Для этого в маркере контекста (если используется поток маркера контекста), который SharePoint передает удаленному компоненту надстройки SharePoint при запуске надстройки, указывается строка ключа кэша. Подробнее об этом **специальном ключе кэша** и его использовании можно узнать в разделе [Общие сведения о ключе кэша](#CacheKey). Эту строку можно также использовать в сценарии, описанном в предыдущем абзаце. В системе планирования предусмотрены некоторые средства для хранения необходимых данных конфигурации, например о времени выполнения запланированной работы и ее сути. Держите ключ кэша для маркера доступа в этом хранилище.
 

 
Если межсеансовый кэш, который используете вы, также используют несколько приложений, ключи кэша нужно соотнести с приложениями, пользователями и областями SharePoint. Ключ кэша, предоставленный в маркере контекста, уникален для каждого приложения, пользователя и области SharePoint.
 

 
 **Если приложение использует поток кода авторизации**, маркера контекста нет, и потому нет и специально созданного ключа кэша. В таком сценарии **вам нужно создать собственную систему ключей для кэшированных данных**. Такие ключи соотносятся с одним или несколькими пользователями, областями SharePoint и приложениями в зависимости от потенциальных конфликтов имен, которые могут возникнуть при использовании приложения. Чтобы создать такую систему, используйте утверждения из маркера доступа (например, **nameId** и **aud**, как показано в таблицах ниже). Ваш код может просто собирать строки или использовать их для создания уникального хэша, выполняющего роль ключа кэша.
 

 
Наконец, если ваша надстройка выполняет вызовы SharePoint как с проверкой разрешений приложения, так и с проверкой разрешений пользователя и надстройки, у него будет два разных маркера доступа. Потому понадобятся разные ключи кэша. Определив основной ключ кэша, просто добавьте к нему "_add-in-only" (только надстройка) или "_add-in+user" (надстройка и пользователь).
 

 

 **Внимание!**   **Хранить маркер доступа в файле cookie небезопасно.** Лучше избегать передачи маркера доступа через браузер.
 


### <a name="forward-the-access-token-to-backend-systems"></a>Пересылка маркера доступа в серверные системы
<a name="ForwardTokenToBackend"> </a>

Внутренние серверы Надстройка SharePoint и удаленное веб-приложение могут быть размещены на разных доменах. Если внутреннему серверу необходимо выполнить операции CRUD (создание, считывание, обновление или удаление) в SharePoint, надстройка работает быстрее, если эти операции поступают напрямую из серверной системы в SharePoint. Домен важен, только если приложение получает маркер доступа из службы контроля доступа. После этого оно может передать такой маркер внутренним службам, которые с его помощью выполнят вызов SharePoint. Код в этих системах нужен для обработки маркеров доступа с истекшим сроком действия и отправки запросов на получение новых родительскому веб-приложению, зарегистрированному с помощью службы контроля доступа. См. раздел  [Обработка маркеров доступа с истекшим сроком действия](#Expired). Этот способ подходит для собственных внутренних серверов приложения, а не для внешних веб-служб. Используя его, подумайте о создании внутренних служб, чтобы по возможности выполнялись вызовы с проверкой разрешений только надстроек.
 

 

### <a name="handle-expired-access-tokens"></a>Обработка маркеров доступа с истекшим сроком действия
<a name="Expired"> </a>

Срок действия маркера доступа истекает через несколько часов с момента выпуска маркера (на момент написания данной статьи срок действия был равен 12 часам, но это могло измениться). Если после этого приложение пытается получить доступ к SharePoint, первый запрос к SharePoint возвращает ошибку **401 Unauthorized**. Ваш код должен обработать этот ответ или проверить срок действия маркера доступа перед его использованием. **Код получает другой маркер доступа от службы контроля доступа, используя маркер обновления.** Если используется поток маркера контекста, маркер обновления будет включен в маркер контекста, который надстройка получает из SharePoint в начале первого сеанса с SharePoint. Если используется поток кода авторизации, маркер обновления будет передан приложению вместе с первым маркером доступа. Чтобы маркер обновления был доступен при необходимости, код должен кэшировать его. Этот маркер активен в течение нескольких месяцев. Его можно хранить в файле cookie или серверном хранилище. Дополнительные сведения см. в разделе [Общие сведения об обработке и кэшировании маркеров обновления](#RefreshToken).
 

 

### <a name="see-examples-of-access-tokens"></a>Примеры маркеров доступа
<a name="ExampleAccessTokens"> </a>

В этом разделе описаны (с примерами) маркеры доступа и показано, как они отличаются в зависимости от используемой политики авторизации.
 

 

#### <a name="see-access-tokens-for-the-low-trust-authorization-system"></a>Маркеры доступа для систем авторизации с низким уровнем доверия

 **Политика "Пользователь и надстройка"**
 

 
Ниже представлен расшифрованный **пример маркера доступа для пользователя и надстройки, созданного службой контроля доступа**. Этот маркер предназначен для выполнения вызовов SharePoint с помощью [политики "Пользователь и надстройка"](add-in-authorization-policy-types-in-sharepoint-2013). Пробел добавлен для удобства чтения. Маркер соответствует протоколу [JWT (JSON Web Token)](http://datatracker.ietf.org/doc/draft-ietf-oauth-json-web-token/?include_text=1). Объект JSON в маркере представляет собой набор утверждений. Его свойства описаны в табл. 1. Обратите внимание, что во всех значениях необходимо использовать только строчные буквы. (Маркеры доступа "Пользователь и надстройка" одинаковые в [потоке маркера контекста](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows) и [потоке кода авторизации](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows).)
 

 



```
{
 "aud": "00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss": "00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf": 1377549246,
 "exp": 1377592446,
 "nameid": "2303000085ff9abc",
 "actor": "964de6ad-6d28-4dc7-8e05-3acd8006e5c9@040f2415-e6e3-4480-96ce-26ef73275f73",
 "identityprovider": "urn:federation:microsoftonline"
}
```


**Табл. 1. Требования маркеров доступа "Пользователь и надстройка", изданные службой контроля доступа**


|**Утверждение**|**Описание**|**Соответствующее значение в примере маркера доступа**|
|:-----|:-----|:-----|
| `aud`|Сокращение для слова "аудитория". Обозначает субъект, для которого предназначен маркер. Используемый формат: _идентификатор субъекта аудитории_/ _домен SharePoint_@ _область SharePoint_, где _идентификатор субъекта аудитории_ — постоянный код субъекта безопасности для SharePoint. (См. статью [Константы субъектов приложения продукта Майкрософт](http://msdn.microsoft.com/en-us/library/hh629982%28v=office.12%29.aspx).) _Область SharePoint_ — это GUID тенантности SharePoint Online или локальной фермы SharePoint, для доступа к которым создан маркер доступа. Этот GUID функционирует как идентификатор области для издателя маркера (в этом случае Azure ACS).|00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73|
| `iss`|Сокращение для слова "издатель". Представляет субъект, создавший маркер. Используется следующий формат: _GUID издателя_@ _GUID области SharePoint_. В системах авторизации с низким уровнем доверия издателем является Azure ACS с GUID **00000001-0000-0000-c000-000000000000**.|00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73|
| `nbf`|Сокращение от "not before" (не ранее). Представляет время  *начала*  действия маркера (указывается в секундах, отсчет ведется с полуночи 1 января 1970 г.). По умолчанию это момент создания маркера. Дополнительные сведения см. в разделе [Работа со значениями времени JWT](#JWTtimes).  |1377549246|
| `exp`|Сокращение для слова "истечение срока действия". Представляет время истечения срока действия маркера. По умолчанию срок действия равен 12 часам после времени **nbf**. Дополнительные сведения см. в статье [Работа со значениями времени JWT](#JWTtimes).|1377592446|
| `nameid`|Уникальный идентификатор пользователя, для которого выпущен маркер. Формат зависит от поставщика удостоверений. В этом примере поставщик Microsoft Online. Если бы это была служба Active Directory, ИД выглядел бы так: "s-1-5-21-2127521184-1604012920-1887927527-415149".|2303000085ff9abc|
| `actor`|Субъект, который ищет доступ к ферме или тенантности SharePoint. Он имеет следующую форму: _Идентификатор клиента приложения_@ _Область SharePoint_.|964de6ad-6d28-4dc7-8e05-3acd8006e5c9@040f2415-e6e3-4480-96ce-26ef73275f73|
| `identityprovider`|Уникальное имя поставщика удостоверений, зарегистрированное в Internet Assigned Numbers Authority (IANA). Для надстройки, установленной в SharePoint Online, это значение обычно такое же, как в примере. Для надстройки, установленной в локальной ферме, обычно используется локальный поставщик удостоверений, например urn:office:idp:activedirectory.|urn:federation:microsoftonline|
 **Политика "Только надстройка"**
 

 
Ниже представлен расшифрованный **пример маркера доступа только для надстройки, изданного службой контроля доступа**. Этот маркер предназначен для выполнения вызовов SharePoint с помощью [политики "Только надстройка"](add-in-authorization-policy-types-in-sharepoint-2013). Пробел добавлен для удобства чтения. Маркер соответствует протоколу [JWT (JSON Web Token)](http://datatracker.ietf.org/doc/draft-ietf-oauth-json-web-token/?include_text=1). Свойства в наборе требований описаны в табл. 2. Политика "Только надстройка" недоступна для надстроек, в которых используется [поток кода авторизации](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows). Это объясняется тем, что у них нет файла манифеста надстройки, и они не могут запрашивать разрешение на использованием вызовов "Только надстройка".
 

 



```
{
 "aud":"00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf":1403304705,
 "exp":1403347905,
 "nameid":"c76da14e-07fd-4638-a723-1ff60ce70d63@040f2415-e6e3-4480-96ce-26ef73275f73",
 "sub":"1d47ac31-498b-4988-8aac-85fc9bd2e1ce",
 "oid":"1d47ac31-498b-4988-8aac-85fc9bd2e1ce",
 "trustedfordelegation":"false",
 "identityprovider":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73"
}
```


**Табл. 2. Требования маркеров доступа "Только надстройка", изданные службой контроля доступа**


|**Утверждение**|**Описание**|**Соответствующее значение в примере маркера доступа**|
|:-----|:-----|:-----|
| `aud`|То же, что и для описанного выше маркера "Пользователь и надстройка".|00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73|
| `iss`|См. маркер для пользователя и надстройки выше.|00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73|
| `nbf`|См. маркер для пользователя и надстройки выше.|1403304705|
| `exp`|См. маркер для пользователя и надстройки выше.|1403347905|
| `nameid`|Уникальный идентификатор надстройки, а не пользователя, так как идентификатор пользователя не важен в политике только для надстройки. Формат:  _ИД клиента_@ _область SharePoint_.  |c76da14e-07fd-4638-a723-1ff60ce70d63@040f2415-e6e3-4480-96ce-26ef73275f73|
| `sub`|Сокращение для слова "субъект". Это субъект маркера, который пытается получить доступ к SharePoint (в данном случае он представляет собой удаленное веб-приложение). В качестве значения используется идентификатор объекта. См. требование **oid** ниже.|1d47ac31-498b-4988-8aac-85fc9bd2e1ce|
| `oid`|Сокращение от "object ID" (ИД объекта). Это ИД объекта в службе Azure Active Directory для удаленного веб-приложения. В маркере доступа только для надстройки субъект (с утверждением "sub") и ИД объекта имеют одинаковое значение.|1d47ac31-498b-4988-8aac-85fc9bd2e1ce|
| `trustedfordelegation`|Логическое значение, которое указывает, должна ли служба SharePoint доверять Надстройка SharePoint при аутентификации и авторизации пользователя. В вызовах с проверкой разрешений только для надстройки имеет значение false, так как идентификатор пользователя не важен.|false|
| `identityprovider`|Уникальное имя поставщика удостоверений. Так как предоставляется удостоверение надстройки, а не пользователя, поставщиком выступает служба контроля доступа. Формат:  _GUID службы контроля доступа_@ _область SharePoint_.  |00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73|

## <a name="understand-the-structure-and-handling-of-context-tokens"></a>Общие сведения о структуре и обработке маркеров контекста
<a name="ContextTokens"> </a>

Маркер контекста используется только в  [потоке маркера контекста](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows) системы авторизации с низким уровнем доверия. **Когда выполняется запуск Надстройка SharePoint в SharePoint, служба SharePoint отправляет службе Azure ACS запрос на создание маркера контекста. Затем SharePoint передает этот маркер удаленному компоненту Надстройка SharePoint.** Маркер контекста передается в виде скрытого параметра формы ( **SPAppToken**) в запросе от SharePoint для начальной страницы удаленного компонента. Этот маркер подписан с использованием секрета клиента, который знают только служба контроля доступа и Надстройка SharePoint. **Маркер контекста содержит маркер обновления, который надстройка использует** вместе с другими данными из маркера контекста, чтобы **запросить маркер доступа** у службы контроля доступа. (Во время написания этой статьи продолжительность существования маркера доступа, выпущенного службой контроля доступа для SharePoint, составляла 12 часов, но это могло измениться.) **Основные задачи кода в Надстройка SharePoint**:
 

 

- **Проверка маркера контекста** с помощью секрета клиента надстройки.
    
 
-  **Кэширование маркера контекста** или извлечение и отдельное кэширование маркера обновления и некоторых других элементов из него.
    
 
- Использование маркера обновления и других сведений для **запроса маркера доступа** в службе контроля доступа и последующего его кэширования.
    
 
-  **Кэширование CacheKey** на основе маркера контекста.
    
 

 **Важно!** Первые две задачи необходимо выполнить, прежде чем пользователь перейдет на другую страницу или обновит текущую, иначе маркер будет потерян. Например, в приложении веб-форм ASP.NET эти задачи следует выполнять с помощью метода **Page_Load** (в коде условия он представлен блоком, который выполняется, если запрос не передается обратно). В приложении MVC ASP.NET эти задачи следует выполнять с помощью метода контроллера, используемого по умолчанию.
 

Если вы используете управляемый код, пример кода для некоторых задач представлен в файлах SharePointContext и TokenHelper (с расширением CS или VB), которые входят в Инструменты разработчика Microsoft Office для Visual Studio. Вам нужно только выполнить простые вызовы членов класса TokenHelper. Например, ваш код может справиться с первой задачей с помощью такой одной строки:
 

 



```C#
SharePointContextToken contextToken =
    TokenHelper.ReadAndValidateContextToken(contextTokenString, 
    Request.Url.Authority);
```

Примеры выполнения некоторых задач с помощью PHP см. в статье  [SharePoint: выполнение операций в библиотеке документов SharePoint на сайте, созданном с использованием PHP](https://code.msdn.microsoft.com/SharePoint-2013-Perform-8a78b8ef).
 

 

### <a name="cache-the-context-token-or-parts-of-it"></a>Кэширование маркера контекста или его частей
<a name="CacheContextToken"> </a>

Вы можете **кэшировать** весь маркер контекста либо только маркер обновления и ряд других элементов в нем, которые ваш код использует для получения маркеров доступа **в серверном или клиентском хранилище**. Для простоты в этой статье подразумевается, что вы кэшируете весь маркер контекста.
 

 

 **Важно!** Напомним еще раз, так как это очень важно: не используйте кэширование на стороне клиента для маркера *доступа*. Его можно безопасно использовать только для маркера контекста.
 

[Варианты кэширования на стороне сервера](#CacheAccessToken) такие же, как и перечисленные выше для маркера доступа. Варианты на стороне клиента также включают файл cookie и скрытое поле формы на HTML-странице. Кроме того, можно хранить маркер контекста в кэше сеанса, а ключ **CacheKey**, полученный из него, на стороне клиента.
 

 
Если ваша надстройка получает доступ к SharePoint после завершения сеанса, вам не удастся использовать ни кэширование сеанса, ни кэширование на стороне клиента. Это объясняется тем, что у надстройки должен быть доступ к маркеру обновления на случай если истечет срок действия исходного маркера доступа при выполнении работы после сеанса. В этом сценарии нужен устойчивый (межсеансовый) кэш, который совместно используют несколько пользователей, областей SharePoint или надстроек. Потому код должен использовать ключи кэша, в которых различаются пользователи, области SharePoint и надстройки, как описано выше в разделе [Кэширование маркера доступа](#CacheAccessToken). Для этого можно **использовать специальный ключ кэша** из маркера контекста так же, как и для маркера доступа. (См. раздел [Общие сведения о ключе кэша](#CacheKey) ниже.)
 

 

#### <a name="understand-the-cache-key"></a>Общие сведения о ключе кэша
<a name="CacheKey"> </a>

 **Ключ кэша непрозрачная строка, которая уникальна для комбинации пользователя, издателя имени пользователя, надстройки и фермы SharePoint или клиента SharePoint Online.** Ниже приведена его форма до шифрования, где _область_ это GUID локальной фермы SharePoint или области клиента SharePoint Online.
 

 
 _UserNameId_ + "," + _UserNameIdIssuer_ + "," + _ApplicationId_ + "," + _Realm_
 

 
Ключ кэша не содержит сведений об URL-адресе сайта. У каждого клиента SharePoint Online (или локальной фермы SharePoint) есть уникальная область, и потому ключ кэша уникален для каждой комбинации имени пользователя, его издателя, приложения и фермы. В приведенном ниже примере маркера контекста значение зашифрованного ключа кэша выглядит так:
 

 
 `KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=`
 

 
Так как с помощью одного ключа кэша надстройка может кэшировать несколько элементов в одном кэше, например маркер доступа и маркер контекста, **ключ кэша следует использовать в качестве основы**. При необходимости в его начало или конец можно добавить определенную строку, например AccessToken или ContextToken, чтобы сформировать полный ключ кэша. **Еще один вариант — создать класс** со свойствами для различных элементов, которые необходимо кэшировать, а затем кэшировать объект такого типа. Есть и **третий вариант** на случай если вы **используете базу данных** в качестве кэша. Он подразумевает использование таблицы со столбцом CacheKey и дополнительными столбцами для кэшированных элементов (AccessToken, ContextToken и т. д.).
 

 
Конечно, приложение не должно использовать один кэш для всех операций кэширования. Обычно маркер доступа кэшируют в кэше сеанса, маркер контекста (или маркер обновления из него) в базе данных, а ключ CacheKey в файле cookie.
 

 

### <a name="use-the-context-token-to-get-an-access-token"></a>Получение маркера доступа с помощью маркера контекста
<a name="UseContextTokenToGetAccessToken"> </a>

 **Чтобы получить маркер доступа, приложение отправляет запрос напрямую в службу контроля доступа.** Запрос включает три части данных, извлеченные из маркера контекста, а также другую информацию:
 

 

- Маркер обновления
    
 
- GUID субъекта приложения в SharePoint.
    
 
- GUID области фермы SharePoint или тенантности SharePoint Online, доступ к которой ищет надстройка.
    
 
Файл TokenHelper (с расширением CS или VB) содержит код, который создает этот запрос. Пример такого кода PHP см. в статье  [SharePoint: выполнение операций в библиотеке документов SharePoint на сайте, созданном с использованием PHP](http://code.msdn.microsoft.com/office/SharePoint-2013-Perform-8a78b8ef/sourcecode?fileId=117521&amp;pathId=1932320454).
 

 
Приложение может получить область клиента или фермы SharePoint в среде выполнения вместо ее извлечения из маркера контекста. Если вы используете управляемый код, для получения области существует метод  `TokenHelper.GetRealmFromTargetUrl`. Значение необходимо кэшировать, чтобы код не выполнял повторный вызов по сети для его получения.
 

 

### <a name="get-a-new-context-token"></a>Получение нового маркера контекста
<a name="GetNewContextToken"> </a>

 **Если нужен новый маркер контекста** (обычно это происходит из-за истечения срока действия маркера обновления, который он содержит), **код может получить его, переадресовав браузер на специальную страницу на любом веб-сайте SharePoint** AppRedirect.aspx. К URL-адресу этой страницы необходимо добавить два параметра запроса:
 

 

-  `client_id`: идентификатор клиента надстройки SharePoint.
    
 
-  `redirect_uri`. URI, на который необходимо перенаправить браузер после получения нового маркера контекста. Служба SharePoint передаст по методу POST маркер контекста в этот URI. Обычно это страница, метод контроллера или веб-службы, запросившие новый маркер контекста. Значение должно быть закодировано как URL-адрес.
    
 
Ниже показана структура URL-адреса.
 

 



```
https://<SharePointDomain> /_layouts/15/appredirect.aspx?client_id=<app_client_GUID> &amp;redirect_uri=<URL-encoded_redirect_URI>
```

Пример запроса в ASP.NET с помощью файла TokenHelper:
 

 



```
Response.Redirect(TokenHelper.GetAppContextTokenRequestUrl(sharePointUrl, Server.UrlEncode(Request.Url.ToString())));
```


### <a name="see-an-example-of-a-context-token"></a>Пример маркера контекста
<a name="ExampleContextToken"> </a>

Ниже показан пример маркера контекста. Маленький объект JSON в начале содержит метаданные о маркере. Эти свойства такие же, как и в маркерах доступа (см. выше). Значение свойства **alg** — это имя алгоритма, используемого для создания подписи, которую служба контроля доступа добавляет к маркеру. Сведения о свойствах в данных маркера см. в табл. 3. Обратите внимание, что все значения должны быть написаны строчными буквами. (Пробел добавлен для удобства чтения.)
 

 

```
{"typ":"JWT","alg":"HS256"}
.
{
 "aud":"a044e184-7de2-4d05-aacf-52118008c44e/fabrikam.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf":"1335822895",
 "exp":"1335866095",
 "appctxsender":"00000003-0000-0ff1-ce00-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "appctx":"{
            \"CacheKey\":\"KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=\",
            \"SecurityTokenServiceUri\":\"https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2\"
           }",
 "refreshtoken":"IAAAAC1Lv5w0OrcFAmJx0xk6aaBdhgsw3VPnPzNEDAWypTHtCYytZ2/dBBUKj+HLK8YB3IUCUfDxYpAque
NHKtgs4rYJJ5AegQpNMOJR1yYK8ngivQx0oetj7aSPuGVb+k6at6G0Kx5LZ5vhxkAq8iUSwu8p4L2cvNMzDF1mDKfMivqxgrIZkr2nbf9as0SJFL6VG5hZnDE4HKq
xJnejSW3umatKM4fsfY1MClVCxrkXb2EQ8H/TmwaJc388YW063GEVUS/3BTSgSIRBKQUmXJuJ6BZY7WTm84LaGrx3mIjnUTM/jnqPoPG55JbCC9sS/MeGNPtzPPCDg
6Vv7dVhQ1Dq5Y3fQ65e9LpJ580jCgzYYvpIFT+Wx5V+17mjY2T8wug04K2ts87Znsr+GfFCorf7NS/lj5HjoxRAQ2tva/8dwguSLwxcUwi/Q9MbpR0NNtlpwVazqi9O
hJ4Df7gVhUDdJ0Dtc6aFCPbl5ZLDDRs42xK2", 
 "isbrowserhostedapp": "true"
}
```

Требования **aud**, **iss**, **nbf** и **exp** такие же, как и в маркере доступа, как описано выше. Требования **appctxsender**, **appctx**, **CacheKey**, **SecurityTokenServiceUri**, **refreshtoken** и **isbrowserhostedapp** описаны в таблице ниже.
 

 

**Табл. 3. Требования и сведения маркера контекста**


|** **Требование****|** **Описание****|** **Соответствующее значение в примере маркера контекста****|
|:-----|:-----|:-----|
|aud||a044e184-7de2-4d05-aacf-52118008c44e/fabrikam.com@040f2415-e6e3-4480-96ce-26ef73275f73|
|iss||00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73|
|nbf||1335822895|
|exp||1335866095|
|appctxsender|Сокращение для выражения "отправитель контекста приложения". Представляет приложение, отправившее маркер контекста в надстройку SharePoint. Оно имеет следующую форму: _GUID субъекта_@ _Область SharePoint_, где _GUID субъекта_ — это постоянный идентификатор субъекта приложения (SharePoint, Exchange 2013, Lync 2013 или рабочий процесс).|00000003-0000-0ff1-ce00-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73|
|appctx|Сокращение для выражения "контекст надстройки". Это объект JSON, который содержит элементы **CacheKey** и **SecurityTokenServiceURI**. |\"CacheKey\":\"KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=\", \"SecurityTokenServiceUri\":\"https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2\"|
|CacheKey|Уникальное значение, которое можно использовать в качестве ключа в кэше со структурой "ключ-значение" для хранения и получения маркера контекста. Его также можно использовать как значение столбца ключа в строке базы данных.|KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=|
|SecurityTokenServiceURI|URI службы, издавшей маркер.|https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2|
|refreshtoken|Маркер обновления для надстройки.|IAAAAC1Lv5w0OrcFAmJx0xk6???|
|isbrowserhostedapp|Поле типа **Boolean**, которое указывает, откуда поступил запрос в надстройку с маркером контекста: из браузера (true) или из удаленного приемника событий (false).|true|

### <a name="use-the-context-token-to-limit-access-to-only-sharepoint-users"></a>Использование маркера контекста для предоставления доступа только пользователям SharePoint
<a name="UseContextTokenToLimitAccess"> </a>

Если вам нужно ограничить доступ к удаленному компоненту (например, к службе WCF) для пользователей SharePoint, код может просто проверить маркер контекста в HTTP-запросе. (Если вы используете управляемый код, достаточно вызова **TokenHelper.ReadAndValidateContextToken()**.) Код может проверить, начинается ли утверждение субъекта маркера с **00000003-0000-0ff1-ce00-000000000000**. Так вы убедитесь, что это SharePoint (а не Exchange 2013, Lync 2013 или рабочий процесс, например). Чтобы выполнить дополнительную проверку, для которой нужен обратный вызов SharePoint, например в случае ограничения доступа для пользователей с определенной ролью в SharePoint, вы можете кэшировать сведения о выполнении такой проверки для определенного пользователя. Для этого используется ключ **CacheKey** маркера контекста. Такой способ позволяет выполнять проверку только один раз.
 

 

## <a name="understand-the-handling-and-caching-of-refresh-tokens"></a>Общие сведения об обработке и кэшировании маркеров обновления
<a name="RefreshTokens"> </a>

 **Маркер обновления включен в маркер контекста, который служба SharePoint публикует в веб-приложении при его запуске.** Маркер обновления зашифрован, и Надстройка SharePoint не может его расшифровать. **Код использует его** и другие данные **для получения нового маркера доступа после истечения срока действия текущего**. С его помощью также можно получить *первый*  маркер доступа в [потоке маркера контекста](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows). (Во время написания этой статьи продолжительность существования маркера обновления, выпущенного службой контроля доступа для SharePoint, составляла 6 месяцев, но это могло измениться.)
 

 
Так как маркер доступа действует только несколько часов (сейчас 12) и пользователь получает новый при каждом запуске Надстройка SharePoint в SharePoint, маркер обновления нужен только в таких сценариях:
 

 

- Пользователи открыли продолжительные сеансы надстройки, в которых она выполняет вызовы SharePoint в течение нескольких часов (более 12) после запуска.
    
 
- Конструкция надстройки дает пользователям возможность планировать доступ надстройки к SharePoint после окончания сеанса.
    
 
В обоих **сценариях надстройка должна кэшировать маркер обновления**, а во втором также нужен кэш на стороне сервера, устойчивый на протяжении всех сеансов. Варианты кэширования такие же, как и для [маркера доступа](#CacheAccessToken), а в потоке маркера контекста можно использовать [ключ кэша в маркере контекста](#CacheKey). В потоке маркера контекста вы обычно кэшируете маркер контекста. Он содержит маркер обновления и другие данные, необходимые для получения нового маркера доступа. В [потоке кода авторизации](creating-sharepoint-add-ins-that-use-low-trust-authorization#Flows) маркера контекста нет, потому вы кэшируете сам маркер обновления.
 

 
Если вы кэшируете маркер обновления в хранилище, которое существует во всех сеансах надстройки, открытых определенным пользователем, замените его самым новым маркером обновления. Пользователь получает новый маркер обновления при каждом запуске надстройки как в случае потока с облачным размещением, так и потока кода авторизации.
 

 
Если истек срок действия маркера обновления, запрос на получение нового маркера доступа в службу контроля доступа возвращает ошибку **401 Unauthorized**. В ответ на нее надстройка должна получить новый маркер обновления, а с его помощью новый маркер доступа. (Так как маркер обновления зашифрован, код не может проверить срок его действия перед использованием.) В потоке маркера контекста надстройка получает новый маркер обновления, [получив новый маркер контекста](#GetNewContextToken). Чтобы получить маркер обновления в потоке кода авторизации, надстройка перезапускает поток. В частности, в ответ на ошибку код должен перенаправить пользователя на страницу OAuthAuthorize.aspx в SharePoint (см. раздел [Общие сведения о потоке OAuth для надстроек, запрашивающих разрешение в динамическом режиме](authorization-code-oauth-flow-for-sharepoint-add-ins#Flow)).
 

 

## <a name="understanding-the-handling-authorization-codes"></a>Общие сведения об обработке кодов авторизации
<a name="Authcodes"> </a>

 **Процесс авторизации в потоке кода авторизации начинается с того, что служба контроля доступа при получении запроса из службы SharePoint выпускает код авторизации. После этого SharePoint передает его удаленному приложению** в качестве параметра запроса. Код авторизации уникален для каждой пары пользователя и удаленного приложения. (Во время написания этой статьи код авторизации, выпущенный службой контроля доступа для SharePoint, действовал в течение 5 минут, но это могло измениться.) Код **приложения должен получить код авторизации из параметра запроса и с его помощью запросить маркер доступа из службы контроля доступа**. Если вы используете управляемый код, пример кода для создания маркера находится в файле TokenHelper (с расширением CS или VB). Пример кода для чтения параметра запроса можно найти в разделе [Пример кода программной части страницы, обращающейся к SharePoint](authorization-code-oauth-flow-for-sharepoint-add-ins#Default). Служба контроля доступа делает код авторизации недействительным сразу после выпуска маркера доступа, потому его можно использовать только один раз. Кэшировать его бессмысленно.
 

 

## <a name="work-with-jwt-time-values"></a>Работа со значениями времени JWT
<a name="JWTtimes"> </a>

Формат требований **nbf** и **exp** определен в [спецификации JWT](http://self-issued.info/docs/draft-goland-json-web-token-00l). Это количество секунд, отсчет которых ведется с 1 января 1970 г. На языке C# эти значения можно преобразовать с помощью приведенного ниже кода, где _jWTTimeStamp_ — это значение из маркера, например 1335822895.
 

 

```C#
DateTime exp = new DateTime(1970,1,1).AddSeconds(jWTTimeStamp);

```


## <a name="troubleshooting-token-handling"></a>Устранение неполадок при обработке маркеров
<a name="Troubleshooting"> </a>

HTTP-запросы, которые удаленный компонент надстройки отправляет в SharePoint, можно перехватывать с помощью бесплатного  [средства Fiddler](http://www.telerik.com/fiddler). Для него также есть  [бесплатное расширение](https://github.com/andrewconnell/SPOAuthFiddlerExt), которое автоматически декодирует маркеры в запросах.
 

 

## <a name="additional-resources"></a>Дополнительные ресурсы
<a name="bk_addresources"> </a>


-  [Создание надстроек SharePoint, использующих авторизацию с низким уровнем доверия](creating-sharepoint-add-ins-that-use-low-trust-authorization)
    
 
- Примеры кода, в которых используются управляемый код и TokenHelper, см. в статьях [SharePoint: удаленная надстройка Hello World, использующая CSOM](http://code.msdn.microsoft.com/SharePoint-2013-Hello-0fd15fbf) и [Пакет примеров надстроек SharePoint](http://code.msdn.microsoft.com/office/Apps-for-SharePoint-sample-64c80184).
    
 
- Пример кода, в котором используются вызовы REST из надстройки PHP: [SharePoint: выполнение операций над библиотекой документов SharePoint с сайта PHP](https://code.msdn.microsoft.com/SharePoint-2013-Perform-8a78b8ef)
    
 

