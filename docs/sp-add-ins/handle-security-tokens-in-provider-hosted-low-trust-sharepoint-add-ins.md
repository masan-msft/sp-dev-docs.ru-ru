---
title: Обработка маркеров безопасности в надстройках SharePoint с низким уровнем доверия, размещенных у поставщика
description: Узнайте о маркерах контекста, доступа и обновления, используемых для авторизации в надстройках SharePoint с низким уровнем доверия и размещением у поставщика, а также о принципах работы с ними в коде.
ms.date: 12/28/2017
ms.prod: sharepoint
ms.openlocfilehash: aed3e924120548744f816c8f274089efd20732d4
ms.sourcegitcommit: 469ce248552201a47ebea1b6c85bc5c90a97c7ac
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/02/2018
---
# <a name="handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins"></a><span data-ttu-id="15ebc-103">Обработка маркеров безопасности в надстройках SharePoint с низким уровнем доверия, размещенных у поставщика</span><span class="sxs-lookup"><span data-stu-id="15ebc-103">Handle security tokens in provider-hosted low-trust SharePoint Add-ins</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="15ebc-104">Эта статья целиком посвящена использованию маркеров безопасности в системе авторизации с низким (а не высоким) уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="15ebc-104">This article is entirely about the use of security tokens in the low-trust authorization system, not the high-trust system. For information about the use of tokens in the high-trust system, see Create and use access tokens in high-trust SharePoint Add-ins 2013.</span></span> <span data-ttu-id="15ebc-105">Сведения об использовании маркеров в системе с высоким уровнем доверия см. в статье [Создание и использование маркеров доступа в надстройках SharePoint с высоким уровнем доверия, размещенных у поставщика](create-and-use-access-tokens-in-provider-hosted-high-trust-sharepoint-add-ins.md).</span><span class="sxs-lookup"><span data-stu-id="15ebc-105">ImportantThis article is entirely about the use of security tokens in the low-trust authorization system, not the high-trust system. For information about the use of tokens in the high-trust system, see [Create and use access tokens in provider-hosted high-trust SharePoint Add-ins](create-and-use-access-tokens-in-provider-hosted-high-trust-sharepoint-add-ins.md).</span></span>
 
<span data-ttu-id="15ebc-106">Надстройки SharePoint, которые для получения доступа к данным SharePoint используют [систему авторизации с низким уровнем доверия](creating-sharepoint-add-ins-that-use-low-trust-authorization.md), участвуют в потоке OAuth, связанном с прохождением токенов безопасности (в формате [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/)) в SharePoint, службе контроля доступа Microsoft Azure (ACS), удаленных компонентах надстройки SharePoint и, в некоторых случаях, браузере пользователя.</span><span class="sxs-lookup"><span data-stu-id="15ebc-106">SharePoint Add-ins that use the  [low-trust authorization system](creating-sharepoint-add-ins-that-use-low-trust-authorization.md) to gain access to SharePoint data participate in an OAuthflow that involves the passing of security tokens (in [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/) format) among SharePoint, Microsoft Azure Access Control Service (ACS), the remote components of the SharePoint Add-in, and, in some cases, the user's browser. There are different flows depending on the design of the add-in, but all of them involve at least the following two types of tokens:</span></span> 

<span data-ttu-id="15ebc-107">В зависимости от структуры надстройки используются разные потоки, но все они включают по крайней мере следующие два типа маркеров:</span><span class="sxs-lookup"><span data-stu-id="15ebc-107">There are different flows depending on the design of the add-in, but all of them involve at least the following two types of tokens:</span></span>

- <span data-ttu-id="15ebc-108">**Маркер доступа**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-108">Access Token</span></span> <span data-ttu-id="15ebc-109">Входит в каждый запрос на создание, считывание, обновление или удаление, который удаленные компоненты надстройки отправляют в SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-109">Access token: Included in each create, read, update, or delete (CRUD) request from the remote components of the add-in to SharePoint. SharePoint validates the token and serves the request.</span></span> <span data-ttu-id="15ebc-110">SharePoint проверяет маркер и обслуживает запрос.</span><span class="sxs-lookup"><span data-stu-id="15ebc-110">SharePoint validates the token and serves the request.</span></span>

- <span data-ttu-id="15ebc-111">**Маркер обновления**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-111">**Refresh token**.</span></span> <span data-ttu-id="15ebc-112">Служит для получения первого маркера доступа в [потоке маркера контекста](context-token-oauth-flow-for-sharepoint-add-ins.md) и замены маркеров доступа в нем и [потоке кода авторизации](authorization-code-oauth-flow-for-sharepoint-add-ins.md) для системы авторизации с низким уровнем доверия после истечения срока их действия.</span><span class="sxs-lookup"><span data-stu-id="15ebc-112">Refresh token: Used to obtain a first access token in the [Context Token flow](context-token-oauth-flow-for-sharepoint-add-ins.md), and to replace expiring access tokens in both the Context Token flow and the  [Authorization Code flow](authorization-code-oauth-flow-for-sharepoint-add-ins.md) of the low-trust authorization system.</span></span>

<span data-ttu-id="15ebc-113">В зависимости от того, какой поток OAuth использует надстройка, в процесс включается один из указанных ниже элементов.</span><span class="sxs-lookup"><span data-stu-id="15ebc-113">Depending on which OAuth flow the add-in is using, one or the other of the following is also part of the process:</span></span>

- <span data-ttu-id="15ebc-114">**Маркер контекста**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-114">**Context token**.</span></span> <span data-ttu-id="15ebc-115">С его помощью в потоке токена контекста удаленный компонент получает маркер обновления и сведения, необходимые для запроса маркера доступа из Azure ACS.</span><span class="sxs-lookup"><span data-stu-id="15ebc-115">Context token: Used, in the Context Token flow, to provide the remote component with a refresh token and with information that it needs to request an access token from Azure ACS.</span></span>

- <span data-ttu-id="15ebc-p105">**Код авторизации**. Это не токен, а код, уникальный для каждой пары пользователя и приложения. Используется в потоке кода авторизации для получения первого маркера доступа и маркера обновления.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p105">**Authorizaton code:** Not a token, but an authorization code, unique to each pair of user and application. It is used in the Authorization Code flow to obtain a first access token, and a refresh token.</span></span>
    
<span data-ttu-id="15ebc-119"><a name="AccessTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-119"><a name="AccessTokens"> </a></span></span> 

## <a name="access-tokens"></a><span data-ttu-id="15ebc-120">Маркеры доступа</span><span class="sxs-lookup"><span data-stu-id="15ebc-120">Access tokens</span></span>

<span data-ttu-id="15ebc-121">В системе авторизации с низким уровнем доверия маркеры доступа создаются в службе Azure ACS и отправляются удаленному компоненту надстройки SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-121">In the low-trust authorization system, the access tokens are created by Azure ACS and sent to the remote component of your SharePoint Add-in.</span></span> <span data-ttu-id="15ebc-122">На момент написания этой статьи срок действия маркеров доступа для SharePoint, выдаваемых службой ACS, составляет 12 часов, но он может измениться. Код надстройки SharePoint должен выполнять следующие основные действия:</span><span class="sxs-lookup"><span data-stu-id="15ebc-122">In the low-trust authorization system, the access tokens are created by Azure ACS and sent to the remote component of your SharePoint Add-in. (When this article was written, ACS-issued access tokens for SharePoint had a life span of 12 hours, but that could change.) The main  things that the code in your SharePoint Add-in needs to do are:</span></span>

- <span data-ttu-id="15ebc-123">**Запрос маркера доступа из Azure ACS**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-123">**Request an access token from Azure ACS**.</span></span> <span data-ttu-id="15ebc-124">В зависимости от используемого потока OAuth для отправки запроса надстройка использует код авторизации или сведения, извлеченные из маркера контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-124">Request an access token from winazureacsshort. Depending on which OAuth flow is being used, the add-in uses either an authorization code or information it extracts from a context token to make the request.</span></span>

- <span data-ttu-id="15ebc-125">**Включение маркера доступа к каждый HTTP-запрос к SharePoint**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-125">**Include the token in every HTTP request to SharePoint**.</span></span> <span data-ttu-id="15ebc-126">Маркер добавляется в качестве заголовка **Authorization** для запроса.</span><span class="sxs-lookup"><span data-stu-id="15ebc-126">The token is added as an **Authorization** header to the request.</span></span> <span data-ttu-id="15ebc-127">Значением заголовка является слово Bearer, за которым следует пробел, а затем — маркер доступа в кодировке Base 64.</span><span class="sxs-lookup"><span data-stu-id="15ebc-127">Include the access token in every HTTP request to SharePoint. The token is added as an Authorization header to the request. The value of the header is the word "Bearer", followed by a space, followed by the base 64-encoded access token.</span></span>

- <span data-ttu-id="15ebc-128">**Кэширование маркера доступа** для повторного использования в последующих запросах (необязательно, но рекомендовано).</span><span class="sxs-lookup"><span data-stu-id="15ebc-128">Optionally (but recommended), **cache the access token** for reuse on subsequent requests.</span></span>

- <span data-ttu-id="15ebc-129">**Пересылка маркера доступа в серверные системы**, чтобы они могли получать прямой доступ к SharePoint (необязательно).</span><span class="sxs-lookup"><span data-stu-id="15ebc-129">Optionally, forward the access token to back end systems so they can directly access SharePoint.</span></span>
    
<span data-ttu-id="15ebc-130">Эти задачи должен выполнять код на стороне сервера.</span><span class="sxs-lookup"><span data-stu-id="15ebc-130">These tasks must be done with server-side code.</span></span> <span data-ttu-id="15ebc-131">Если вы используете управляемый код, то пример кода для некоторых из этих задач вы найдете в файлах SharePointContext и TokenHelper (с расширением CS или VB), генерируемых Инструментами разработчика Microsoft Office для Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="15ebc-131">These tasks must be done with server-side code. If you are using managed code, sample code for some of these tasks is in the SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) files that the Microsoft Office Developer Tools for Visual Studio generate.</span></span> <span data-ttu-id="15ebc-132">Пример кода PHP, выполняющего некоторые из этих задач, см. в статье [Знакомство с REST-интерфейсом SharePoint 2013 и его использование](https://msdn.microsoft.com/ru-RU/magazine/dn198245.aspx).</span><span class="sxs-lookup"><span data-stu-id="15ebc-132">For an example of PHP code that carries out some of these tasks, see [Understanding and Using the SharePoint REST Interface](https://msdn.microsoft.com/ru-RU/magazine/dn198245.aspx).</span></span>
 

<span data-ttu-id="15ebc-133"><a name="CacheAccessToken"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-133"><a name="CacheAccessToken"> </a></span></span> 

### <a name="cache-the-access-token"></a><span data-ttu-id="15ebc-134">Кэширование маркера доступа</span><span class="sxs-lookup"><span data-stu-id="15ebc-134">Cache the access token</span></span>

<span data-ttu-id="15ebc-135">В зависимости от архитектуры надстройки SharePoint и платформы размещения существует несколько способов кэширования маркеров доступа на сервере:</span><span class="sxs-lookup"><span data-stu-id="15ebc-135">Depending on your SharePoint Add-in's architecture and the hosting platform, there are several  ways to cache the access token on the server.</span></span>

- <span data-ttu-id="15ebc-136">в состоянии сеанса;</span><span class="sxs-lookup"><span data-stu-id="15ebc-136">In session state</span></span>
- <span data-ttu-id="15ebc-137">в состоянии приложения;</span><span class="sxs-lookup"><span data-stu-id="15ebc-137">In application state</span></span>
- <span data-ttu-id="15ebc-138">в [службе кэширования Windows Server AppFabric](http://msdn.microsoft.com/library/8aef3f5d-2a77-46d9-b951-0768fedd31a1%28Office.15%29.aspx) или ее эквиваленте в операционных системах сторонних разработчиков (не Майкрософт);</span><span class="sxs-lookup"><span data-stu-id="15ebc-138">In  [Windows Server AppFabric Caching](http://msdn.microsoft.com/library/8aef3f5d-2a77-46d9-b951-0768fedd31a1%28Office.15%29.aspx) or its equivalent in a non-Microsoft OS.</span></span>
- <span data-ttu-id="15ebc-139">в [службе кэширования Microsoft Azure](https://docs.microsoft.com/ru-RU/azure/redis-cache/cache-faq) или ее эквиваленте в облачных службах, отличных от облачных служб Майкрософт;</span><span class="sxs-lookup"><span data-stu-id="15ebc-139">In the  [Microsoft Azure Caching Service](https://docs.microsoft.com/ru-RU/azure/redis-cache/cache-faq) or its equivalent in a non-Microsoft cloud service.</span></span>
- <span data-ttu-id="15ebc-140">в базе данных;</span><span class="sxs-lookup"><span data-stu-id="15ebc-140">In a database</span></span>
- <span data-ttu-id="15ebc-141">в системе [memcached](http://www.memcached.org/).</span><span class="sxs-lookup"><span data-stu-id="15ebc-141">In a  [memcached](http://www.memcached.org/) system</span></span>
    
> [!NOTE] 
> <span data-ttu-id="15ebc-142">В большинстве случаев невозможно использовать в качестве ключа кэширования такие простые термины, как AccessToken, потому что надстройка должна разделять маркеры для разных пользователей и ферм или клиентов SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-142">In most scenarios, you won't be able to use terms as simple as "AccessToken" as the caching key because your add-in must keep the tokens for different users and SharePoint farms/tenancies distinct. If your add-in uses the Context Token flow, there is special CacheKey provided by SharePoint that can be used to distinguish cached tokens. This section explains what the issues are and what to do when your application is not using the Context Token flow.</span></span> <span data-ttu-id="15ebc-143">Если надстройка использует [поток маркера контекста](context-token-oauth-flow-for-sharepoint-add-ins.md), то SharePoint предоставляет специальный ключ **CacheKey**, с помощью которого можно различать кэшированные маркеры.</span><span class="sxs-lookup"><span data-stu-id="15ebc-143">If your add-in uses the [Context Token flow](context-token-oauth-flow-for-sharepoint-add-ins.md), there is special **CacheKey** provided by SharePoint that can be used to distinguish cached tokens.</span></span> <span data-ttu-id="15ebc-144">В этом разделе описываются проблемы, возникающие, если приложение не использует поток маркера контекста, и представлены указания на этот случай.</span><span class="sxs-lookup"><span data-stu-id="15ebc-144">This section explains what the issues are and what to do when your application is not using the Context Token flow.</span></span>

<span data-ttu-id="15ebc-145">В большинстве случаев достаточно кэшировать маркер доступа в **состоянии сеанса**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-145">Caching the access token in **session state** is fine for most scenarios.</span></span> <span data-ttu-id="15ebc-146">Если удаленное веб-приложение получает доступ к другим службам, использующим OAuth (помимо SharePoint) и кэширует различные маркеры доступа в состоянии службы, обязательно используйте для маркеров разные ключи кэша. Например, вместо "AccessToken" используйте "SharePoint\_AccessToken", "Facebook\_AccessToken", "SAP\_Gateway\_AccessToken" и т. д.</span><span class="sxs-lookup"><span data-stu-id="15ebc-146">If the remote web application is accessing other services that use OAuth (in addition to SharePoint) and it is caching the various access tokens in session state, be sure to use distinct cache keys for the tokens; for example, instead of "AccessToken", use "SharePoint\_AccessToken", "Facebook\_AccessToken", "SAP\_Gateway\_AccessToken", and so on.</span></span> <span data-ttu-id="15ebc-147">Если вы не используете состояние сеанса или другой способ кэширования с автоматическим разделением кэша разных пользователей, то необходимо связать ключи с пользователями.</span><span class="sxs-lookup"><span data-stu-id="15ebc-147">(If you are not using session state or some other caching that automatically separates each user's cache, you need to relativize your keys for users.)</span></span>

<span data-ttu-id="15ebc-148">Если приложение получает доступ к нескольким фермам или веб-клиентам SharePoint, то вы можете использовать домен SharePoint в составе основного ключа кэширования приложения (`SharePoint<mydomain>.sharepoint.com_AccessToken`) или область фермы или клиента (`SharePoint<realmGUID>_AccessToken`). Оба эти значения можно считывать из маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-148">If the application accesses more than one SharePoint farm or online tenancy, you can use the SharePoint domain as part of the application's primary caching key (`SharePoint<mydomain>.sharepoint.com_AccessToken`) or use the farm/tenancy's realm (`SharePoint<realmGUID>_AccessToken`), both of which can be read from the access token.</span></span> <span data-ttu-id="15ebc-149">Для считывания маркера код должен раскодировать его из Base 64.</span><span class="sxs-lookup"><span data-stu-id="15ebc-149">(Your code needs to reverse the Base 64-encoding of the token to read it.</span></span> <span data-ttu-id="15ebc-150">В управляемом коде файл TokenHelper.cs или TokenHelper.vb содержит пример кода для этой цели с использованием классов из пространств имен **Microsoft.IdentityModel.S2S.Tokens** и **System.IdentityModel.Tokens**. Доступен другой вариант, если приложение использует поток маркера контекста, описанный в следующем абзаце.</span><span class="sxs-lookup"><span data-stu-id="15ebc-150">If the application accesses more than one SharePoint farm or online tenancy, you can use the SharePoint domain as part of the application's primary caching key ("SharePoint_   .sharepoint.com_AccessToken") or use the farm/tenancy's realm ("SharePoint_   _AccessToken"), both of which can be read from the access token. (Your code needs to reverse the Base 64 encoding of the token to read it. In managed code, the TokenHelper.cs, or .vb, file has sample code for this purpose that uses classes from the **Microsoft.IdentityModel.S2S.Tokens** and **System.IdentityModel.Tokens** namespaces.) There is another option available when the application is using the Context Token flow as described in the next paragraph.</span></span>

<span data-ttu-id="15ebc-151">Возможны случаи, когда приложению потребуется кэшировать маркер доступа в месте, доступном приложению в разных сеансах или по их завершении.</span><span class="sxs-lookup"><span data-stu-id="15ebc-151">Scenarios may exist in which your application needs to cache the access token someplace that is available to the application across sessions or after a session ends.</span></span> <span data-ttu-id="15ebc-152">Например, в приложении может быть предусмотрена возможность планировать действия, выполняемые после его закрытия.</span><span class="sxs-lookup"><span data-stu-id="15ebc-152">For example, the application may be designed to enable users to schedule actions to occur after the user has closed the application.</span></span> <span data-ttu-id="15ebc-153">Если эти действия включают доступ к SharePoint, то надстройке необходимо получить маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-153">If those actions include accessing SharePoint, the add-in needs to retrieve the access token.</span></span> <span data-ttu-id="15ebc-154">В таком случае приложение должно различать маркеры доступа разных пользователей.</span><span class="sxs-lookup"><span data-stu-id="15ebc-154">In this kind of scenario, your application must keep the access tokens of different users distinct.</span></span> 

<span data-ttu-id="15ebc-155">Если вы используете поток маркера контекста, то строка ключа кэша предоставляется для этой цели в маркере контекста, который SharePoint передает удаленному компоненту надстройки SharePoint при ее запуске.</span><span class="sxs-lookup"><span data-stu-id="15ebc-155">If you are using the Context Token flow, a cache key string is provided for this purpose in the context token that SharePoint passes to the remote component of your SharePoint Add-in when the add-in is launched.</span></span> <span data-ttu-id="15ebc-156">Дополнительные сведения об этом **специальном ключе кэша** и его применении см. в разделе [Общие сведения о ключе кэша](#CacheKey).</span><span class="sxs-lookup"><span data-stu-id="15ebc-156">For more information about this **special cache key** and how to use it, see [Understand the cache key](#CacheKey).</span></span> <span data-ttu-id="15ebc-157">Вы также можете использовать эту строку для вышеописанного сценария.</span><span class="sxs-lookup"><span data-stu-id="15ebc-157">You can also use this string for the scenario described earlier.</span></span> <span data-ttu-id="15ebc-158">В системе планирования предусмотрены некоторые способы хранения необходимых ей данных конфигурации, например времени выполнения и назначении запланированной задачи.</span><span class="sxs-lookup"><span data-stu-id="15ebc-158">The scheduling system has some means of storing configuration data that it needs, such as when the scheduled work executes and what it should do.</span></span> <span data-ttu-id="15ebc-159">В этом хранилище следует держать ключ кэша для маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-159">Use this storage to hold the cache key for the access token.</span></span>

<span data-ttu-id="15ebc-160">Если межсеансовый кэш также используется несколькими приложениями, то ключи кэша необходимо связать не только с пользователями и областями SharePoint, но и с приложениями.</span><span class="sxs-lookup"><span data-stu-id="15ebc-160">If the cross-session cache you use is also shared by multiple applications, then the cache keys will have to be relativized to applications as well as to users and to SharePoint realms. The cache key that is provided in the context token is unique to applications as well as users and SharePoint realm.</span></span> <span data-ttu-id="15ebc-161">Ключ кэша, предоставляемый в маркере контекста, уникален не только для пользователей и областей SharePoint, но и для приложений.</span><span class="sxs-lookup"><span data-stu-id="15ebc-161">The cache key that is provided in the context token is unique to applications as well as to users and SharePoint realms.</span></span>
 
<span data-ttu-id="15ebc-162">**Если в приложении используется поток кода авторизации**, то маркер контекста не используется. Следовательно, специальный ключ кэша также отсутствует.</span><span class="sxs-lookup"><span data-stu-id="15ebc-162">**If your application is using the Authorization Code flow**, there is no context token and, hence, no specially made cache key.</span></span> <span data-ttu-id="15ebc-163">В этом случае необходимо создать собственную систему ключей для кэшированных данных, связанных с одним или несколькими из следующих объектов (в зависимости от того, какие конфликты имен могут возникнуть с учетом вариантов моделирования приложения): пользователя, области SharePoint и приложения.</span><span class="sxs-lookup"><span data-stu-id="15ebc-163">In that scenario, you need to create your own system of keys for cached data that are relativized to one or more of the following depending on what potential name clashes might occur given the use cases of your application: the user, the SharePoint realm, and the application.</span></span> <span data-ttu-id="15ebc-164">Вы можете использовать для этой цели утверждения в маркере доступа, например `nameId` и `aud` (см. приведенные ниже таблицы).</span><span class="sxs-lookup"><span data-stu-id="15ebc-164">You can use the claims inside the access token for this purpose; for example, the `nameId` and the `aud` (see the following tables).</span></span> <span data-ttu-id="15ebc-165">Код может просто сцеплять строки или использовать их в качестве начальных значений для создания уникального хэша, который может послужить в качестве ключа кэша.</span><span class="sxs-lookup"><span data-stu-id="15ebc-165">Your code can simply concatenate the strings or use them as seeds to create a unique hash that can serve as the cache key.</span></span>

<span data-ttu-id="15ebc-166">Наконец, если приложение отправляет среде SharePoint как вызовы только для надстроек, так и вызовы для пользователей и надстроек, то у него будет два разных маркера доступа, поэтому потребуются отдельные ключи кэша.</span><span class="sxs-lookup"><span data-stu-id="15ebc-166">Finally, if your application makes both add-in-only and user+add-in calls to SharePoint, then it will have two different access tokens. So, you will need distinct cache keys. Once you have decided on a basic cache key, just append "_add-in-only" or "_add-in+user" to it.</span></span> <span data-ttu-id="15ebc-167">Выбрав базовый ключ кэша, просто добавьте к нему строку "\_add-in-only" или "\_add-in+user".</span><span class="sxs-lookup"><span data-stu-id="15ebc-167">After you have decided on a basic cache key, just append "\_add-in-only" or "\_add-in+user" to it.</span></span>
 

> [!WARNING] 
> <span data-ttu-id="15ebc-168">Из соображений безопасности не рекомендуем хранить маркер доступа в файле cookie.</span><span class="sxs-lookup"><span data-stu-id="15ebc-168">It is not a secure practice to store the access token in a cookie. It is usually a good practice to avoid having the access token pass through the browser.</span></span> <span data-ttu-id="15ebc-169">Как правило, следует не допускать, чтобы маркер доступа проходил через браузер.</span><span class="sxs-lookup"><span data-stu-id="15ebc-169">CautionIt is not a secure practice to store the access token in a cookie. It is usually a good practice to avoid having the access token pass through the browser.</span></span>
 
<span data-ttu-id="15ebc-170"><a name="ForwardTokenToBackend"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-170"></span></span>

### <a name="forward-the-access-token-to-backend-systems"></a><span data-ttu-id="15ebc-171">Пересылка маркера доступа во внутренние системы</span><span class="sxs-lookup"><span data-stu-id="15ebc-171">Forward the access token to backend systems</span></span>

<span data-ttu-id="15ebc-172">У надстройки SharePoint могут быть внутренние серверы, размещенные не на том же домене, что и удаленное веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="15ebc-172">A SharePoint Add-in may have backend servers that are not hosted in the same domain as the remote web application.</span></span> <span data-ttu-id="15ebc-173">Когда внутреннему серверу требуется выполнять операции CRUD в SharePoint, надстройка будет работать быстрее, если эти операции могут передаваться из внутренней системы непосредственно в SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-173">When a backend server needs to perform CRUD operations on SharePoint, the add-in performs faster if these operations can go directly from the backend system to SharePoint.</span></span> <span data-ttu-id="15ebc-174">К счастью, домен имеет значение, только когда приложение получает маркер доступа из ACS.</span><span class="sxs-lookup"><span data-stu-id="15ebc-174">Fortunately, domain is only important when your application is getting an access token from ACS.</span></span> <span data-ttu-id="15ebc-175">Получив маркер, оно может пересылать его во внутренние службы, которые будут вызывать SharePoint с его помощью.</span><span class="sxs-lookup"><span data-stu-id="15ebc-175">After it has the token, it can forward it to the backend services, and they can call SharePoint by using it.</span></span> 

<span data-ttu-id="15ebc-176">Код в этих системах должен обрабатывать просроченные маркеры доступа и отправлять запрос нового маркера родительскому веб-приложению, фактически зарегистрированному в ACS (см. раздел [Обработка просроченных маркеров доступа](#Expired)).</span><span class="sxs-lookup"><span data-stu-id="15ebc-176">Code in these systems needs to handle expired access tokens and send a request for a new one back to the parent web application that is actually registered with ACS (see [Handle expired access tokens](#Expired)).</span></span> <span data-ttu-id="15ebc-177">Эту методику следует использовать только для собственных внутренних серверов приложения, а не для внешних веб-служб.</span><span class="sxs-lookup"><span data-stu-id="15ebc-177">This technique should only be used for your application's own backend servers, not to external web services.</span></span> <span data-ttu-id="15ebc-178">Кроме того, при ее применении лучше, чтобы внутренние службы по мере возможности использовали вызовы только для надстроек.</span><span class="sxs-lookup"><span data-stu-id="15ebc-178">Also, if you are using this technique, consider designing the backend services to use add-in-only calls whenever possible.</span></span>
 

<span data-ttu-id="15ebc-179"><a name="Expired"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-179"></span></span> 

### <a name="handle-expired-access-tokens"></a><span data-ttu-id="15ebc-180">Обработка просроченных маркеров доступа</span><span class="sxs-lookup"><span data-stu-id="15ebc-180">Handle expired access tokens</span></span>

<span data-ttu-id="15ebc-181">Срок действия маркера доступа истекает спустя несколько часов (на момент написания данной статьи срок составляет 12 часов, но он может измениться).</span><span class="sxs-lookup"><span data-stu-id="15ebc-181">An access token expires after a few hours (twelve hours as of the time this article was written, but that can change).</span></span> <span data-ttu-id="15ebc-182">Если приложение продолжает получать доступ к SharePoint после того, как срок действия маркера доступа истечет, то первый запрос к SharePoint после истечения срока действия приведет к ошибке **401 Unauthorized**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-182">If the application is still accessing SharePoint after the access token expires, the first request to SharePoint after the expiration results in a **401 Unauthorized** error.</span></span> <span data-ttu-id="15ebc-183">Код должен обработать этот отклик.</span><span class="sxs-lookup"><span data-stu-id="15ebc-183">Your code has to handle this response.</span></span> 

<span data-ttu-id="15ebc-184">Кроме того, код может проверять срок действия маркера доступа перед его использованием.</span><span class="sxs-lookup"><span data-stu-id="15ebc-184">Alternatively, the code can test the expiration time of the access token before it is used.</span></span> <span data-ttu-id="15ebc-185">Код использует маркер обновления, чтобы получить другой маркер доступа из ACS.</span><span class="sxs-lookup"><span data-stu-id="15ebc-185">Your code uses the refresh token to obtain another access token from ACS.</span></span> <span data-ttu-id="15ebc-186">В потоке токена контекста маркер обновления включается в токен контекста, полученный надстройкой из SharePoint в начале ее первого сеанса работы с SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-186">In the Context Token flow, the refresh token is included in the context token that your add-in receives from SharePoint at the start of its first session with SharePoint.</span></span> <span data-ttu-id="15ebc-187">В потоке кода авторизации он передается приложению вместе с первым маркером доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-187">In the Authorization Code flow, it is passed to the application along with the first access token.</span></span> <span data-ttu-id="15ebc-188">Код должен кэшировать его, чтобы он был доступен при необходимости.</span><span class="sxs-lookup"><span data-stu-id="15ebc-188">Your code must cache it so it is available when needed.</span></span> <span data-ttu-id="15ebc-189">Маркер обновления действителен в течение нескольких месяцев и может храниться в файле cookie или серверном хранилище.</span><span class="sxs-lookup"><span data-stu-id="15ebc-189">The refresh token lasts a few months and can be persisted in a cookie or in server-side storage.</span></span> <span data-ttu-id="15ebc-190">Дополнительные сведения см. в статье [Общие сведения об обработке и кэшировании маркеров обновления](#RefreshTokens).</span><span class="sxs-lookup"><span data-stu-id="15ebc-190">For more information, see [Understand the handling and caching of refresh tokens](#RefreshTokens).</span></span>
 

<span data-ttu-id="15ebc-191"><a name="ExampleAccessTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-191"></span></span> 

### <a name="examples-of-access-tokens-for-the-low-trust-authorization-system"></a><span data-ttu-id="15ebc-192">Примеры маркеров доступа для систем авторизации с низким уровнем доверия</span><span class="sxs-lookup"><span data-stu-id="15ebc-192">See access tokens for the low-trust authorization system</span></span>

<span data-ttu-id="15ebc-193">В этом разделе описываются (с примерами) маркеры доступа и показано, как они отличаются в зависимости от используемой политики авторизации.</span><span class="sxs-lookup"><span data-stu-id="15ebc-193">This section describes, with examples, access tokens and shows how they differ depending on the authorization policy that is being used.</span></span>

#### <a name="useradd-in-policy"></a><span data-ttu-id="15ebc-194">Политика для пользователей и надстроек</span><span class="sxs-lookup"><span data-stu-id="15ebc-194">User+add-in Policy</span></span>

<span data-ttu-id="15ebc-195">Ниже приведен раскодированный пример маркера доступа для пользователя и надстройки, созданного службой контроля доступа для отправки вызовов среде SharePoint с помощью [политики для пользователей и надстроек](add-in-authorization-policy-types-in-sharepoint.md).</span><span class="sxs-lookup"><span data-stu-id="15ebc-195">The following is a decoded example of a user+add-in access token generated by ACS to be used for calls to SharePoint by using the [user+add-in policy](add-in-authorization-policy-types-in-sharepoint.md).</span></span> <span data-ttu-id="15ebc-196">Пробел добавлен для удобочитаемости.</span><span class="sxs-lookup"><span data-stu-id="15ebc-196">White space has been added for readability.</span></span> <span data-ttu-id="15ebc-197">Маркер соответствует протоколу [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/).</span><span class="sxs-lookup"><span data-stu-id="15ebc-197">The token complies with the [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/) protocol.</span></span> <span data-ttu-id="15ebc-198">Объект, представленный нотацией объектов JavaScript (JSON), в маркере называется **набором утверждений** (в таблице 1 вы найдете подробные сведения о свойствах набора утверждений).</span><span class="sxs-lookup"><span data-stu-id="15ebc-198">The JavaScript Object Notation (JSON) object in the token is called the **claim set** (see Table 1 for details about the properties in the claim set).</span></span> 

<span data-ttu-id="15ebc-199">Обратите внимание, что все значения должны быть представлены в нижнем регистре.</span><span class="sxs-lookup"><span data-stu-id="15ebc-199">Note that all the values must be lowercase.</span></span> <span data-ttu-id="15ebc-200">В [потоке токена контекста](context-token-oauth-flow-for-sharepoint-add-ins.md) и [потоке кода авторизации](authorization-code-oauth-flow-for-sharepoint-add-ins.md) используются одни и те же маркеры доступа для пользователей и надстроек.</span><span class="sxs-lookup"><span data-stu-id="15ebc-200">(User+add-in access tokens are the same in the [Context Token flow](context-token-oauth-flow-for-sharepoint-add-ins.md) and the [Authorization Code flow](authorization-code-oauth-flow-for-sharepoint-add-ins.md).)</span></span>

```json
{
 "aud": "00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss": "00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf": 1377549246,
 "exp": 1377592446,
 "nameid": "2303000085ff9abc",
 "actor": "964de6ad-6d28-4dc7-8e05-3acd8006e5c9@040f2415-e6e3-4480-96ce-26ef73275f73",
 "identityprovider": "urn:federation:microsoftonline"
}
```

<br/>

<span data-ttu-id="15ebc-201">**Таблица 1. Утверждения маркера доступа для пользователя и надстройки, выданного службой контроля доступа**</span><span class="sxs-lookup"><span data-stu-id="15ebc-201">**Table 1: ACS-issued user+add-in access token claims**</span></span>

|<span data-ttu-id="15ebc-202">**Утверждение**</span><span class="sxs-lookup"><span data-stu-id="15ebc-202">**Claim**</span></span>|<span data-ttu-id="15ebc-203">**Описание**</span><span class="sxs-lookup"><span data-stu-id="15ebc-203">**Description**</span></span>|<span data-ttu-id="15ebc-204">**Соответствующее значение в примере маркера доступа**</span><span class="sxs-lookup"><span data-stu-id="15ebc-204">**Corresponding value in the sample access token**</span></span>|
|:-----|:-----|:-----|
| `aud`|<span data-ttu-id="15ebc-205">Сокращение от "audience" (аудитория, то есть субъект, для которого предназначен маркер).</span><span class="sxs-lookup"><span data-stu-id="15ebc-205">Short for "audience", meaning the principal for which the token is intended. The format is  audience principal IDfully qualified SharePoint domainSharePoint realm.</span></span><br/><br/><span data-ttu-id="15ebc-206">Используется формат `audience principal ID/SharePoint domain@SharePoint realm`, где _ИД субъекта аудитории_ — это постоянный ИД субъекта безопасности для SharePoint (см. [константы субъектов для приложений в продуктах корпорации Майкрософт](https://msdn.microsoft.com/ru-RU/library/hh629982(v=office.12).aspx)).</span><span class="sxs-lookup"><span data-stu-id="15ebc-206">Short for "audience", meaning the principal for which the token is intended. The format is  audience principal IDSharePoint domainSharePoint realm`audience principal ID/SharePoint domain@SharePoint realm`, where  _audience principal ID_ is a permanent security principal ID for SharePoint. (See [Microsoft Product Application Principal Constants](https://msdn.microsoft.com/en-us/library/hh629982(v=office.12).aspx).)</span></span><br/><br/><span data-ttu-id="15ebc-207">_Область SharePoint_ — это GUID клиента SharePoint Online или локальной фермы SharePoint, для доступа к которым используется маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-207">. _SharePoint realm_ is the GUID of the SharePoint Online tenancy, or the on-premise SharePoint farm, that the access token is used to access. This GUID functions as the realm's ID for the token issuer, in this case Azure ACS.</span></span> <span data-ttu-id="15ebc-208">Этот GUID служит в качестве ИД области для издателя маркера (в данном случае — Azure ACS).</span><span class="sxs-lookup"><span data-stu-id="15ebc-208">This GUID functions as the realm's ID for the token issuer, in this case Azure ACS.</span></span>|`00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `iss`|<span data-ttu-id="15ebc-209">Сокращение от слова "issuer" (издатель).</span><span class="sxs-lookup"><span data-stu-id="15ebc-209">Short for "issuer".</span></span> <span data-ttu-id="15ebc-210">Представляет субъекта, создавшего маркер.</span><span class="sxs-lookup"><span data-stu-id="15ebc-210">Short for "issuer". It represents the principal that created the token. The format is  Issuer GUIDSharePoint realm GUID.</span></span> <span data-ttu-id="15ebc-211">Используется формат `Issuer GUID@SharePoint realm GUID`. В системе авторизации с низким уровнем доверия издателем является служба Azure ACS со следующим GUID: `00000001-0000-0000-c000-000000000000`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-211">In the low-trust authorization system, the issuer is Azure ACS and it's GUID is 00000001-0000-0000-c000-000000000000`00000001-0000-0000-c000-000000000000`.</span></span>|`00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `nbf`|<span data-ttu-id="15ebc-212">Сокращение от "not before" (не ранее).</span><span class="sxs-lookup"><span data-stu-id="15ebc-212">Short for "not before".</span></span> <span data-ttu-id="15ebc-213">Представляет время, с которого *начинается* срок действия маркера (в секундах, начиная с 1 января 1970 г).</span><span class="sxs-lookup"><span data-stu-id="15ebc-213">Short for "not before". It represents the time at which the token  *starts*  being valid, in seconds since midnight, January 1, 1970. Your code should set this to the moment the token is created.</span></span> <span data-ttu-id="15ebc-214">По умолчанию оно соответствует моменту создания маркера (см. раздел [Значения времени в формате JWT](#JWTtimes)).</span><span class="sxs-lookup"><span data-stu-id="15ebc-214">By default, it is set to the moment the token is created (see [JWT time values](#JWTtimes)).</span></span>|`1377549246`|
| `exp`|<span data-ttu-id="15ebc-215">Сокращение от "expiration" (истечение срока действия).</span><span class="sxs-lookup"><span data-stu-id="15ebc-215">Short for "expiration".</span></span> <span data-ttu-id="15ebc-216">Представляет время окончания срока действия для маркера.</span><span class="sxs-lookup"><span data-stu-id="15ebc-216">It represents the time the token expires.</span></span> <span data-ttu-id="15ebc-217">Значение по умолчанию составляет 12 часов после времени **nbf** (см. раздел [Значения времени в формате JWT](#JWTtimes)).</span><span class="sxs-lookup"><span data-stu-id="15ebc-217">By default, this is 12 hours after the **nbf** time (see [JWT time values](#JWTtimes)).</span></span>|`1377592446`|
| `nameid`|<span data-ttu-id="15ebc-218">Уникальный идентификатор пользователя, которому выдан маркер.</span><span class="sxs-lookup"><span data-stu-id="15ebc-218">A unique identifier for the user for whom the token is issued. The format varies depending on the identity provider. In this example, the provider is Active Directory.</span></span> <span data-ttu-id="15ebc-219">Формат зависит от поставщика удостоверения.</span><span class="sxs-lookup"><span data-stu-id="15ebc-219">The format varies depending on the identity provider.</span></span> <span data-ttu-id="15ebc-220">В этом примере поставщиком является Microsoft Online, но если бы это была служба Active Directory, ИД выглядел бы так: `s-1-5-21-2127521184-1604012920-1887927527-415149`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-220">A unique identifier for the user for whom the token is issued. The format varies depending on the identity provider. In this example, the provider is Microsoft Online, but if it was Active Directory, the ID would look like "s-1-5-21-2127521184-1604012920-1887927527-415149".</span></span>|`2303000085ff9abc`|
| `actor`|<span data-ttu-id="15ebc-221">Субъект, запрашивающий доступ к ферме или клиенту SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-221">The principal that seeks access to the SharePoint farm or tenancy. It has the form  Client ID of ApplicationSharePoint realm.</span></span> <span data-ttu-id="15ebc-222">Представлен в формате `Client ID of Application@SharePoint realm`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-222">It has the form `Client ID of Application@SharePoint realm`.</span></span>|`964de6ad-6d28-4dc7-8e05-3acd8006e5c9@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `identityprovider`|<span data-ttu-id="15ebc-223">Уникальное имя поставщика удостоверений, зарегистрированное в Администрации адресного пространства Интернет (IANA). Как правило, для надстроек, установленных в SharePoint Online, используется такое же значение, как в этом примере.</span><span class="sxs-lookup"><span data-stu-id="15ebc-223">The unique name of the identity provider as registered with the Internet Assigned Numbers Authority (IANA).For an add-in that is installed to SharePoint Online, the value is usually the same as in this example. For an add-in that is installed to an on-premise farm, it would typically be an on-premise identity provider, such as "urn:office:idp:activedirectory".</span></span> <span data-ttu-id="15ebc-224">Как правило, для надстроек, установленных на локальной ферме, это локальный поставщик удостоверений, например `urn:office:idp:activedirectory`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-224">For an add-in that is installed to an on-premise farm, it would typically be an on-premise identity provider, such as "urn:office:idp:activedirectory".</span></span>|`urn:federation:microsoftonline`|
 
<br/>

#### <a name="add-in-only-policy"></a><span data-ttu-id="15ebc-225">Политика только для надстроек</span><span class="sxs-lookup"><span data-stu-id="15ebc-225">add-in-only Policy</span></span>

<span data-ttu-id="15ebc-226">Ниже приведен раскодированный пример маркера доступа только для надстройки, созданного службой контроля доступа для отправки вызовов среде SharePoint с помощью [политики только для надстроек](add-in-authorization-policy-types-in-sharepoint.md).</span><span class="sxs-lookup"><span data-stu-id="15ebc-226">The following is a decoded example of an add-in-only access token generated by ACS to be used for calls to SharePoint using the [add-in-only policy](add-in-authorization-policy-types-in-sharepoint.md).</span></span> <span data-ttu-id="15ebc-227">Пробел добавлен для удобочитаемости.</span><span class="sxs-lookup"><span data-stu-id="15ebc-227">White space has been added for readability.</span></span> <span data-ttu-id="15ebc-228">Маркер соответствует протоколу [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/).</span><span class="sxs-lookup"><span data-stu-id="15ebc-228">The token complies with the [JSON Web Token](https://datatracker.ietf.org/doc/rfc7519/) protocol.</span></span> <span data-ttu-id="15ebc-229">В таблице 2 вы найдете подробные сведения о свойствах набора утверждений.</span><span class="sxs-lookup"><span data-stu-id="15ebc-229">See Table 2 for details about the properties in the claim set.</span></span> <span data-ttu-id="15ebc-230">Политика только для надстроек недоступна приложениям, использующим [поток кода авторизации](authorization-code-oauth-flow-for-sharepoint-add-ins.md), так как у них нет файла манифеста и, следовательно, они не могут запрашивать разрешение на использование вызовов только для надстроек.</span><span class="sxs-lookup"><span data-stu-id="15ebc-230">(The add-in-only policy is not available for applications that use the [Authorization Code flow](authorization-code-oauth-flow-for-sharepoint-add-ins.md), because they do not have an add-in manifest file and, thus, cannot request permission to use add-in-only calls.)</span></span>

```json
{
 "aud":"00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf":1403304705,
 "exp":1403347905,
 "nameid":"c76da14e-07fd-4638-a723-1ff60ce70d63@040f2415-e6e3-4480-96ce-26ef73275f73",
 "sub":"1d47ac31-498b-4988-8aac-85fc9bd2e1ce",
 "oid":"1d47ac31-498b-4988-8aac-85fc9bd2e1ce",
 "trustedfordelegation":"false",
 "identityprovider":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73"
}
```

<br/>

<span data-ttu-id="15ebc-231">**Таблица 2. Утверждения маркера доступа только для надстроек, выданного службой контроля доступа**</span><span class="sxs-lookup"><span data-stu-id="15ebc-231">**Table 2: ACS-issued add-in-only access token claims**</span></span>

|<span data-ttu-id="15ebc-232">**Утверждение**</span><span class="sxs-lookup"><span data-stu-id="15ebc-232">**Claim**</span></span>|<span data-ttu-id="15ebc-233">**Описание**</span><span class="sxs-lookup"><span data-stu-id="15ebc-233">**Description**</span></span>|<span data-ttu-id="15ebc-234">**Соответствующее значение в примере маркера доступа**</span><span class="sxs-lookup"><span data-stu-id="15ebc-234">**Corresponding value in the sample access token**</span></span>|
|:-----|:-----|:-----|
| `aud`|<span data-ttu-id="15ebc-235">См. маркер для пользователя и надстройки в таблице 1.</span><span class="sxs-lookup"><span data-stu-id="15ebc-235">Same as the user+add-in token in Table 1.</span></span>|`00000003-0000-0ff1-ce00-000000000000/company.sharepoint.com@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `iss`|<span data-ttu-id="15ebc-236">См. маркер для пользователя и надстройки в таблице 1.</span><span class="sxs-lookup"><span data-stu-id="15ebc-236">Same as the user+add-in token in Table 1.</span></span>|`00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `nbf`|<span data-ttu-id="15ebc-237">См. маркер для пользователя и надстройки в таблице 1.</span><span class="sxs-lookup"><span data-stu-id="15ebc-237">Same as the user+add-in token in Table 1.</span></span>|`1403304705`|
| `exp`|<span data-ttu-id="15ebc-238">См. маркер для пользователя и надстройки в таблице 1.</span><span class="sxs-lookup"><span data-stu-id="15ebc-238">Same as the user+add-in token in Table 1.</span></span>|`1403347905`|
| `nameid`|<span data-ttu-id="15ebc-239">Уникальный идентификатор надстройки, а не пользователя, так как идентификатор пользователя не имеет значения в политике только для надстройки.</span><span class="sxs-lookup"><span data-stu-id="15ebc-239">A unique identifier for the add-in, instead of the user, since the user's identity doesn't matter with the add-in-only policy. The format is  client IDSharePoint realm.</span></span> <span data-ttu-id="15ebc-240">Представлен в формате `client ID@SharePoint realm`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-240">The format is `client ID@SharePoint realm`.</span></span>|`c76da14e-07fd-4638-a723-1ff60ce70d63@040f2415-e6e3-4480-96ce-26ef73275f73`|
| `sub`|<span data-ttu-id="15ebc-241">Сокращение от "subject" (субъект).</span><span class="sxs-lookup"><span data-stu-id="15ebc-241">Short for "subject".</span></span> <span data-ttu-id="15ebc-242">Это субъект маркера, запрашивающий доступ к SharePoint. В данном случае это удаленное веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="15ebc-242">Short for "subject". It is the subject of the token, which is the principal that is seeking access to SharePoint; in this case, the remote web application. The object ID is used for the value. See the  oid claim below.</span></span> <span data-ttu-id="15ebc-243">В качестве значения используется ИД объекта.</span><span class="sxs-lookup"><span data-stu-id="15ebc-243">The object ID is used for the value.</span></span> <span data-ttu-id="15ebc-244">См. утверждение `oid`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-244">See the `oid` claim.</span></span>|`1d47ac31-498b-4988-8aac-85fc9bd2e1ce`|
| `oid`|<span data-ttu-id="15ebc-p135">Сокращение от "object ID" (ИД объекта). Это ИД объекта в службе Azure Active Directory для удаленного веб-приложения. В маркере доступа только для надстройки субъект (с утверждением "sub") и ИД объекта имеют одинаковое значение.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p135">Short for "object ID". It is the object ID in Azure Active Directory for the remote web application. In an add-in-only access token, the subject and object ID are the same value.</span></span>|`1d47ac31-498b-4988-8aac-85fc9bd2e1ce`|
| `trustedfordelegation`|<span data-ttu-id="15ebc-p136">Логическое значение, которое указывает, должна ли служба SharePoint доверять Надстройка SharePoint при аутентификации и авторизации пользователя. В вызовах с проверкой разрешений только для надстройки имеет значение false, так как идентификатор пользователя не важен.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p136">A Boolean value that specifies whether SharePoint should trust the SharePoint Add-in to authenticate and authorize the user. It is false in add-in-only calls because the user identity doesn't matter.</span></span>|`false`|
| `identityprovider`|<span data-ttu-id="15ebc-250">Уникальное имя поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="15ebc-250">The unique name of the identity provider as registered with the Internet Assigned Numbers Authority (IANA).</span></span> <span data-ttu-id="15ebc-251">Так как предоставляется идентификатор надстройки, а не пользователя, поставщиком удостоверений является ACS.</span><span class="sxs-lookup"><span data-stu-id="15ebc-251">The unique name of the identity provider. Since it is the add-in, rather than a user, whose identity is being provided, ACS is the identity provider. The format is  ACS GUIDSharePoint realm.</span></span> <span data-ttu-id="15ebc-252">Представлено в формате `ACS GUID@SharePoint realm`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-252">The format is `ACS GUID@SharePoint realm`.</span></span>|`00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73`|

<br/>

<span data-ttu-id="15ebc-253"><a name="ContextTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-253"></span></span>

## <a name="context-tokens"></a><span data-ttu-id="15ebc-254">Токены контекста</span><span class="sxs-lookup"><span data-stu-id="15ebc-254">Context tokens</span></span>

<span data-ttu-id="15ebc-255">Токен контекста используется только в [потоке токена контекста](context-token-oauth-flow-for-sharepoint-add-ins.md) для систем авторизации с низким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="15ebc-255">A context token is used only in the [Context Token flow](context-token-oauth-flow-for-sharepoint-add-ins.md) of the low-trust authorization system.</span></span> <span data-ttu-id="15ebc-256">При запуске надстройки SharePoint отправляет службе контроля доступа Azure запрос на создание токена контекста, который SharePoint затем передает удаленному компоненту надстройки SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-256">When the SharePoint Add-in is launched in SharePoint, SharePoint requests that Azure ACS create a context token that SharePoint then passes on to the remote component of the SharePoint Add-in.</span></span> <span data-ttu-id="15ebc-257">Токен передается в виде скрытого параметра формы **SPAppToken** в запросе от SharePoint на получение начальной страницы удаленного компонента.</span><span class="sxs-lookup"><span data-stu-id="15ebc-257">The token is passed as a hidden form parameter called **SPAppToken** in a request from SharePoint for the start page of the remote component.</span></span> <span data-ttu-id="15ebc-258">Токен подписывается секретом клиента, известным только службе контроля доступа и надстройке SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-258">The token is signed with a client secret known only to ACS and the SharePoint Add-in.</span></span> 

<span data-ttu-id="15ebc-259">Токен контекста включает маркер обновления, который надстройка использует (вместе с другими сведениями от токена контекста), чтобы запросить маркер доступа из ACS.</span><span class="sxs-lookup"><span data-stu-id="15ebc-259">The context token includes a refresh token that the add-in uses, along with other information from the context token, to request an access token from ACS.</span></span> <span data-ttu-id="15ebc-260">На момент написания этой статьи срок действия токенов контекста для SharePoint, выданных службой контроля доступа, составляет 12 часов, но он может измениться.</span><span class="sxs-lookup"><span data-stu-id="15ebc-260">(When this article was written, ACS-issued context tokens for SharePoint had a life span of 12 hours, but that could change.)</span></span> 

<span data-ttu-id="15ebc-261">Ниже перечислены основные задачи для кода надстройки SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-261">The main tasks for the code in the SharePoint Add-in are the following:</span></span>

- <span data-ttu-id="15ebc-262">Проверка маркера контекста с помощью секрета клиента надстройки.</span><span class="sxs-lookup"><span data-stu-id="15ebc-262">Use the client secret of the add-in to  validate the context token.</span></span>

- <span data-ttu-id="15ebc-263">Кэширование маркера контекста или извлечение и отдельное кэширование маркера обновления и некоторых других элементов из него.</span><span class="sxs-lookup"><span data-stu-id="15ebc-263">Cache the context token or extract, and separately cache, the refresh token and certain other items from inside it.</span></span>

- <span data-ttu-id="15ebc-264">Использование маркера обновления и других сведений для запроса маркера доступа в службе контроля доступа и последующего его кэширования.</span><span class="sxs-lookup"><span data-stu-id="15ebc-264">Use the refresh token and other information to  request an access token from ACS (which is itself then cached).</span></span>

- <span data-ttu-id="15ebc-265">Кэширование CacheKey на основе маркера контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-265">Cache the CacheKey from the context token.</span></span>
    
> [!IMPORTANT] 
> <span data-ttu-id="15ebc-266">Первые две задачи должны выполняться до того, как пользователь перейдет на другую страницу или обновит текущую. В противном случае токен будет потерян.</span><span class="sxs-lookup"><span data-stu-id="15ebc-266">The first two tasks must occur before the user goes to another page or refreshes the page, or the token is lost.</span></span> <span data-ttu-id="15ebc-267">Например, в приложении веб-форм ASP.NET рекомендуем выполнять эти задачи в методе **Page_Load** (в условном блоке кода, выполняемом только в том случае, если запрос не отправлен обратно).</span><span class="sxs-lookup"><span data-stu-id="15ebc-267">Important  The first two tasks must occur before the user navigates to another page or refreshes the page or the token is lost. For example, in an ASP.NET web forms application, consider doing those tasks in the  **Page_Load** method (in a conditional code block that runs only when the request is not a postback). In an ASP.NET MVC application, consider doing these tasks in the default controller method.</span></span> <span data-ttu-id="15ebc-268">В приложении ASP.NET MVC рекомендуем выполнять эти задачи в методе контроллера по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="15ebc-268">In an ASP.NET MVC application, consider doing these tasks in the default controller method.</span></span>

<span data-ttu-id="15ebc-p141">Если вы используете управляемый код, пример кода для некоторых задач представлен в файлах SharePointContext и TokenHelper (с расширением CS или VB), которые входят в Инструменты разработчика Microsoft Office для Visual Studio. Вам нужно только выполнить простые вызовы членов класса TokenHelper. Например, ваш код может справиться с первой задачей с помощью такой одной строки:</span><span class="sxs-lookup"><span data-stu-id="15ebc-p141">If you are using managed code, sample code for some of these tasks is in the SharePointContext.cs (or .vb) and TokenHelper.cs (or .vb) files that are included in Microsoft Office Developer Tools for Visual Studio. You just need to make simple calls to the members of the TokenHelper class. For example, your code can do the first task with the following single line of code:</span></span>

```C#
SharePointContextToken contextToken =
    TokenHelper.ReadAndValidateContextToken(contextTokenString, 
    Request.Url.Authority);
```

<span data-ttu-id="15ebc-272">Примеры выполнения некоторых задач с помощью PHP см. в статье [SharePoint: выполнение операций в библиотеке документов SharePoint на сайте, созданном с использованием PHP](https://code.msdn.microsoft.com/office/SharePoint-2013-Perform-8a78b8ef).</span><span class="sxs-lookup"><span data-stu-id="15ebc-272">For an example of how to do some of these tasks with PHP, see the sample  [SharePoint: Perform operations on SharePoint Document Library from PHP site](https://code.msdn.microsoft.com/office/SharePoint-2013-Perform-8a78b8ef).</span></span>
 

<span data-ttu-id="15ebc-273"><a name="CacheContextToken"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-273"></span></span> 

### <a name="cache-the-context-token-or-parts-of-it"></a><span data-ttu-id="15ebc-274">Кэширование маркера контекста или его частей</span><span class="sxs-lookup"><span data-stu-id="15ebc-274">Cache the context token or parts of it</span></span>

<span data-ttu-id="15ebc-275">Вы можете кэшировать весь токен контекста либо только маркер обновления и ряд других элементов в нем, которые ваш код использует для получения маркеров доступа в серверном или клиентском хранилище.</span><span class="sxs-lookup"><span data-stu-id="15ebc-275">You can cache whole context token, or just the refresh token and certain other items that are inside it that your code uses to get access tokens, in either server-side or client-side storage. For simplicity, this article assumes that you cache the context token as a unit.</span></span> <span data-ttu-id="15ebc-276">Для простоты в этой статье предполагается, что вы кэшируете весь маркер контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-276">For simplicity, this article assumes that you cache the context token as a unit.</span></span>
 
> [!IMPORTANT] 
> <span data-ttu-id="15ebc-277">Напомним еще раз, так как это очень важно: не используйте кэширование на стороне клиента для маркера *доступа*.</span><span class="sxs-lookup"><span data-stu-id="15ebc-277">Important  We remind you one more time because it's really important: do not use client-side caching for the  access  token. It is safe to use it only for the context token.</span></span> <span data-ttu-id="15ebc-278">Его можно безопасно использовать только для токена контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-278">It is safe to use it only for the context token.</span></span>

<span data-ttu-id="15ebc-279">Вам доступны те же [варианты кэширования на стороне сервера](#CacheAccessToken), что и для маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-279">You have the same [server-side caching options](#CacheAccessToken) as are listed earlier for the access token.</span></span> <span data-ttu-id="15ebc-280">На стороне клиента это может быть cookie-файл или скрытое поле формы на HTML-странице.</span><span class="sxs-lookup"><span data-stu-id="15ebc-280">Client-side options include a cookie and a hidden form field on an HTML page.</span></span> <span data-ttu-id="15ebc-281">Еще один вариант — хранить токен контекста в кэше сеанса, а полученный из него CacheKey — в клиенте.</span><span class="sxs-lookup"><span data-stu-id="15ebc-281">You have the same  server-side caching options for as are listed above for the access token. Client-side options include a cookie and a hidden form field on an HTML page. Another option is to store the context token in the session cache, but store the CacheKey obtained from inside it on the client.</span></span>

<span data-ttu-id="15ebc-282">Если приложение получает доступ к SharePoint после окончания сеанса, то кэширование невозможно ни в сеансе, ни на стороне клиента, так как маркер обновления должен быть доступен приложению на тот случай, если срок действия исходного маркера доступа истечет при работе после сеанса.</span><span class="sxs-lookup"><span data-stu-id="15ebc-282">If your application accesses SharePoint after a session is ended, neither session-caching nor client-side caching is an option, because the refresh token must be available to the application in case the original access token has expired when the post-session work executes.</span></span> <span data-ttu-id="15ebc-283">В этом случае необходим надежный (межсеансовый) кэш, совместно используемый несколькими пользователями и/или областями SharePoint и/или приложениями.</span><span class="sxs-lookup"><span data-stu-id="15ebc-283">In this scenario, you need a durable (cross-session) cache that is shared by multiple users and/or SharePoint realms and/or applications.</span></span> <span data-ttu-id="15ebc-284">Таким образом, в коде следует использовать ключи кэша, однозначно определяющие пользователя, область SharePoint и/или приложение, как упоминалось ранее в разделе [Кэширование маркера доступа](#CacheAccessToken).</span><span class="sxs-lookup"><span data-stu-id="15ebc-284">So your code has to use cache keys that distinguish user, SharePoint realm, and/or application as explained earlier in [Cache the access token](#CacheAccessToken).</span></span> 

<span data-ttu-id="15ebc-285">Для этой цели вы можете использовать специальный ключ кэша, указанный в токене контекста, как и для маркера доступа (см. следующий раздел — [Общие сведения о ключе кэша](#CacheKey)).</span><span class="sxs-lookup"><span data-stu-id="15ebc-285">You can use the special cache key that is inside the context token for this purpose, just as you used it for the access token (see the next section [Understand the cache key](#CacheKey)).</span></span>
 

<span data-ttu-id="15ebc-286"><a name="CacheKey"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-286"></span></span> 

#### <a name="understand-the-cache-key"></a><span data-ttu-id="15ebc-287">Общие сведения о ключе кэша</span><span class="sxs-lookup"><span data-stu-id="15ebc-287">Understand the cache key</span></span>

<span data-ttu-id="15ebc-288">Ключ кэша — это непрозрачная строка, уникальная для определенного сочетания пользователя, поставщика имен, надстройки и фермы SharePoint или клиента SharePoint Online.</span><span class="sxs-lookup"><span data-stu-id="15ebc-288">The cache key is an opaque string that is unique to the combination of user, user name issuer, add-in, and SharePoint farm or SharePoint Online tenant. Before it is encrypted, it has the following form, where Realm is the GUID of the on-premise SharePoint farm or the SharePoint Online tenancy.</span></span> <span data-ttu-id="15ebc-289">Перед шифрованием он представлен в приведенном ниже формате, где _Realm_ — это GUID локальной фермы SharePoint или клиента SharePoint Online.</span><span class="sxs-lookup"><span data-stu-id="15ebc-289">The cache key is an opaque string that is unique to the combination of user, user name issuer, add-in, and SharePoint farm or SharePoint Online tenant. Before it is encrypted, it has the following form, where _Realm_ is the GUID of the on-premise SharePoint farm or the SharePoint Online tenancy.</span></span>
 
 <span data-ttu-id="15ebc-290">_UserNameId_ + "," + _UserNameIdIssuer_ + "," + _ApplicationId_ + "," + _Realm_</span><span class="sxs-lookup"><span data-stu-id="15ebc-290">_UserNameId_ + "," + _UserNameIdIssuer_ + "," + _ApplicationId_ + "," + _Realm_</span></span>
 
<span data-ttu-id="15ebc-291">Ключ кэша не содержит сведения об URL-адресе сайта.</span><span class="sxs-lookup"><span data-stu-id="15ebc-291">The cache key does not contain site URL information.</span></span> <span data-ttu-id="15ebc-292">Каждому клиенту SharePoint Online (или локальной ферме SharePoint) соответствует уникальная область, поэтому ключ кэша уникален для каждого сочетания имени пользователя, его поставщика, приложения и фермы.</span><span class="sxs-lookup"><span data-stu-id="15ebc-292">The cache key does not contain site URL information. Each SharePoint Online tenant (or on-premise SharePoint farm) has a unique realm, so, the cache key is unique for each combination of user name, user name issuer, application, and farm. In the example context token below, the encrypted cache key value is:</span></span> <span data-ttu-id="15ebc-293">В примере токена контекста используется следующее зашифрованное значение ключа кэша:</span><span class="sxs-lookup"><span data-stu-id="15ebc-293">In the example context token, the encrypted cache key value is:</span></span>
 
`KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=`
 
<span data-ttu-id="15ebc-294">Приложение может кэшировать несколько элементов, например маркер доступа и токен контекста, в одном кэше с одним ключом, поэтому рекомендуем использовать ключ кэша в качестве основы и добавить к нему (в начале или в конце) определенную строку, например "AccessToken" или "ContextToken", чтобы образовать полный ключ кэша.</span><span class="sxs-lookup"><span data-stu-id="15ebc-294">Since your application may be caching multiple items, such as both the access token and the context token in the same cache with the same cache key,  consider using the cache key as a stem and either appending or prepending a specific string such as "AccessToken" or "ContextToken" to it as needed to form a complete cache key. Another option is to create a class with properties for the various things you want to cache and then cache an object of that type. A third option, if you are using a database as a cache, is to use a table with a CacheKey column and additional columns for the cached items (AccessToken, ContextToken, etc.).</span></span> 

<span data-ttu-id="15ebc-295">Еще один вариант — создать класс со свойствами для различных кэшируемых данных, а затем кэшировать объект соответствующего типа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-295">Another option is to create a class with properties for the various things you want to cache, and then cache an object of that type.</span></span> 

<span data-ttu-id="15ebc-296">Третий вариант (если вы используете в качестве кэша базу данных) — использовать таблицу со столбцом CacheKey и дополнительными столбцами для кэшированных элементов (AccessToken, ContextToken и т. д.).</span><span class="sxs-lookup"><span data-stu-id="15ebc-296">A third option, if you are using a database as a cache, is to use a table with a CacheKey column and additional columns for the cached items (AccessToken, ContextToken, etc.).</span></span>

<span data-ttu-id="15ebc-p148">Конечно, приложение не должно использовать один кэш для всех операций кэширования. Обычно маркер доступа кэшируют в кэше сеанса, маркер контекста (или маркер обновления из него) в базе данных, а ключ CacheKey в файле cookie.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p148">Your application does not have to use the same cache for everything it is caching, of course. A common pattern is to cache the access token in session cache, the context token (or the refresh token from inside it) in a database, and the CacheKey in a cookie.</span></span>
 

<span data-ttu-id="15ebc-299"><a name="UseContextTokenToGetAccessToken"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-299"></span></span> 

### <a name="use-the-context-token-to-get-an-access-token"></a><span data-ttu-id="15ebc-300">Получение маркера доступа с помощью токена контекста</span><span class="sxs-lookup"><span data-stu-id="15ebc-300">Use the context token to get an access token</span></span>

<span data-ttu-id="15ebc-301">Чтобы получить маркер доступа, приложение отправляет запрос непосредственно в службу контроля доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-301">To get an access token, your application sends a request directly to ACS. The request includes three pieces of information that are extracted from the context token (and other information):</span></span> <span data-ttu-id="15ebc-302">Запрос включает три элемента данных, извлеченные из маркера контекста (и другие сведения):</span><span class="sxs-lookup"><span data-stu-id="15ebc-302">To get an access token, your application sends a request directly to ACS. The request includes three pieces of information that are extracted from the context token (and other information):</span></span>

- <span data-ttu-id="15ebc-303">маркер обновления;</span><span class="sxs-lookup"><span data-stu-id="15ebc-303">The refresh token</span></span>
- <span data-ttu-id="15ebc-304">GUID субъекта приложения в SharePoint;</span><span class="sxs-lookup"><span data-stu-id="15ebc-304">The application principal GUID of SharePoint.</span></span>
- <span data-ttu-id="15ebc-305">GUID области фермы SharePoint или клиента SharePoint Online, доступ к которым запрашивает надстройка.</span><span class="sxs-lookup"><span data-stu-id="15ebc-305">The realm GUID of the SharePoint farm or SharePoint Online tenancy to which the add-in is seeking access.</span></span>
    
 
<span data-ttu-id="15ebc-p150">Файл TokenHelper (с расширением CS или VB) содержит код, который создает этот запрос. Пример такого кода PHP см. в статье  [SharePoint: выполнение операций в библиотеке документов SharePoint на сайте, созданном с использованием PHP](https://code.msdn.microsoft.com/office/SharePoint-2013-Perform-8a78b8ef).</span><span class="sxs-lookup"><span data-stu-id="15ebc-p150">The TokenHelper.cs (or .vb) file has code that creates this request. For an example of PHP code that does this, see  [SharePoint: Perform operations on SharePoint Document Library from PHP site](https://code.msdn.microsoft.com/office/SharePoint-2013-Perform-8a78b8ef).</span></span>
 
<span data-ttu-id="15ebc-308">Приложение может получить область клиента или фермы SharePoint во время выполнения вместо того, чтобы определять ее путем синтаксического анализа токена контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-308">The application can get the realm of the SharePoint tenancy or farm at runtime as an alternative to parsing it from the context token.</span></span> <span data-ttu-id="15ebc-309">Если вы используете управляемый код, то получить область можно с помощью метода `TokenHelper.GetRealmFromTargetUrl`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-309">If you are using managed code, there is a `TokenHelper.GetRealmFromTargetUrl` method to get the realm.</span></span> <span data-ttu-id="15ebc-310">Обязательно кэшируйте значение, чтобы код не получал его заново, совершая еще один сетевой вызов.</span><span class="sxs-lookup"><span data-stu-id="15ebc-310">Be sure to cache the value so that your code does not make another network call to get it again.</span></span>
 

<span data-ttu-id="15ebc-311"><a name="GetNewContextToken"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-311"></span></span> 

### <a name="get-a-new-context-token"></a><span data-ttu-id="15ebc-312">Получение нового токена контекста</span><span class="sxs-lookup"><span data-stu-id="15ebc-312">Get a new context token</span></span>

<span data-ttu-id="15ebc-313">Если вам нужен новый токен контекста (как правило, это вызвано тем, что истек срок действия включенного в него маркера обновления), код может получить его, перенаправив браузер на специальную страницу (AppRedirect.aspx) любого веб-сайта SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-313">If you need a new context token, typically because the refresh token (which are contained in context tokens) has expired, your code can get a new one by redirecting the browser to a special page in every SharePoint website -- AppRedirect.aspx. Two query parameters have to be attached to the URL of this page:</span></span> <span data-ttu-id="15ebc-314">К URL-адресу этой страницы необходимо добавить два параметра запроса:</span><span class="sxs-lookup"><span data-stu-id="15ebc-314">Two query parameters have to be attached to the URL of this page:</span></span>

- <span data-ttu-id="15ebc-315">`client_id`. Идентификатор клиента надстройки SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-315">`client_id`: The client ID of your SharePoint Add-in.</span></span>

- <span data-ttu-id="15ebc-p153">`redirect_uri`. URI, на который необходимо перенаправить браузер после получения нового маркера контекста. Служба SharePoint передаст по методу POST маркер контекста в этот URI. Обычно это страница, метод контроллера или веб-службы, запросившие новый маркер контекста. Значение должно быть закодировано как URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p153">`redirect_uri`: The URI to which you want the browser redirected after the new context token is obtained. SharePoint will POST the context token to this URI. Typically, this is the same page, controller method, or web service method that requested the new context token. The value must be URL-encoded.</span></span>
    
<span data-ttu-id="15ebc-320">Ниже показана структура URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="15ebc-320">The following shows the structure of the URL:</span></span>

```
https://<SharePointDomain> /_layouts/15/appredirect.aspx?client_id=<app_client_GUID> &amp;redirect_uri=<URL-encoded_redirect_URI>
```

<span data-ttu-id="15ebc-321">Пример запроса в ASP.NET с использованием файла TokenHelper:</span><span class="sxs-lookup"><span data-stu-id="15ebc-321">The following is an example of making the request in ASP.NET that uses the TokenHelper file:</span></span>

```
Response.Redirect(TokenHelper.GetAppContextTokenRequestUrl(sharePointUrl, Server.UrlEncode(Request.Url.ToString())));
```

<span data-ttu-id="15ebc-322"><a name="ExampleContextToken"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-322"></span></span>

### <a name="example-of-a-context-token"></a><span data-ttu-id="15ebc-323">Пример токена контекста</span><span class="sxs-lookup"><span data-stu-id="15ebc-323">Example of a context token</span></span>

<span data-ttu-id="15ebc-324">Далее приводится пример токена контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-324">The following is an example of a context token.</span></span> <span data-ttu-id="15ebc-325">Небольшой объект в нотации JavaScript (JSON) в начале файла содержит метаданные токена.</span><span class="sxs-lookup"><span data-stu-id="15ebc-325">The small JavaScript Object Notation (JSON) object at the top contains metadata about the token.</span></span> <span data-ttu-id="15ebc-326">Эти свойства аналогичны свойствам маркеров доступа (см. выше).</span><span class="sxs-lookup"><span data-stu-id="15ebc-326">These properties are the same as in access tokens (see earlier).</span></span> <span data-ttu-id="15ebc-327">Значение свойства **alg** — это название алгоритма, используемого для создания подписи, которую ACS добавляет к токену.</span><span class="sxs-lookup"><span data-stu-id="15ebc-327">The value of the **alg** property is the name of the algorithm that is used to generate the signature that ACS appends to the token.</span></span> <span data-ttu-id="15ebc-328">В таблице 3 вы найдете подробные сведения о свойствах полезных данных токена.</span><span class="sxs-lookup"><span data-stu-id="15ebc-328">See Table 3 for details about the properties in the payload of the token.</span></span> <span data-ttu-id="15ebc-329">Обратите внимание, что все значения должны быть представлены в нижнем регистре.</span><span class="sxs-lookup"><span data-stu-id="15ebc-329">Note that all the values must be lowercase.</span></span> <span data-ttu-id="15ebc-330">Пробел добавлен для удобочитаемости.</span><span class="sxs-lookup"><span data-stu-id="15ebc-330">(White space has been added for readability.)</span></span>

```json
{"typ":"JWT","alg":"HS256"}
.
{
 "aud":"a044e184-7de2-4d05-aacf-52118008c44e/fabrikam.com@040f2415-e6e3-4480-96ce-26ef73275f73",
 "iss":"00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "nbf":"1335822895",
 "exp":"1335866095",
 "appctxsender":"00000003-0000-0ff1-ce00-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73",
 "appctx":"{
            \"CacheKey\":\"KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=\",
            \"SecurityTokenServiceUri\":\"https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2\"
           }",
 "refreshtoken":"IAAAAC1Lv5w0OrcFAmJx0xk6aaBdhgsw3VPnPzNEDAWypTHtCYytZ2/dBBUKj+HLK8YB3IUCUfDxYpAque
NHKtgs4rYJJ5AegQpNMOJR1yYK8ngivQx0oetj7aSPuGVb+k6at6G0Kx5LZ5vhxkAq8iUSwu8p4L2cvNMzDF1mDKfMivqxgrIZkr2nbf9as0SJFL6VG5hZnDE4HKq
xJnejSW3umatKM4fsfY1MClVCxrkXb2EQ8H/TmwaJc388YW063GEVUS/3BTSgSIRBKQUmXJuJ6BZY7WTm84LaGrx3mIjnUTM/jnqPoPG55JbCC9sS/MeGNPtzPPCDg
6Vv7dVhQ1Dq5Y3fQ65e9LpJ580jCgzYYvpIFT+Wx5V+17mjY2T8wug04K2ts87Znsr+GfFCorf7NS/lj5HjoxRAQ2tva/8dwguSLwxcUwi/Q9MbpR0NNtlpwVazqi9O
hJ4Df7gVhUDdJ0Dtc6aFCPbl5ZLDDRs42xK2", 
 "isbrowserhostedapp": "true"
}
```

<br/>

<span data-ttu-id="15ebc-331">Утверждения `aud`, `iss`, `nbf` и `exp` полностью идентичны соответствующим утверждениям в маркере доступа, описанным в таблице 1.</span><span class="sxs-lookup"><span data-stu-id="15ebc-331">The `aud`, `iss`, `nbf`, and `exp` claims are exactly the same as in an access token described in Table 1.</span></span> 

<span data-ttu-id="15ebc-332">Утверждения `appctxsender`, `appctx`, `CacheKey`, `SecurityTokenServiceUri`, `refreshtoken` и `isbrowserhostedapp` описываются в приведенной ниже таблице.</span><span class="sxs-lookup"><span data-stu-id="15ebc-332">The `appctxsender`, `appctx`, `CacheKey`, `SecurityTokenServiceUri`, `refreshtoken`, and `isbrowserhostedapp` claims are described in the following table.</span></span>

<br/>

<span data-ttu-id="15ebc-333">**Таблица 3. Утверждения и данные в токене контекста**</span><span class="sxs-lookup"><span data-stu-id="15ebc-333">**Table 3. Context token claims and information**</span></span>

|<span data-ttu-id="15ebc-334">Утверждение</span><span class="sxs-lookup"><span data-stu-id="15ebc-334">Claim</span></span> |<span data-ttu-id="15ebc-335">Описание</span><span class="sxs-lookup"><span data-stu-id="15ebc-335">Description</span></span> |<span data-ttu-id="15ebc-336">Соответствующее значение в примере токена контекста</span><span class="sxs-lookup"><span data-stu-id="15ebc-336">****Corresponding value in sample context token****</span></span> |
|:-----|:-----|:-----|
|`aud`||`a044e184-7de2-4d05-aacf-52118008c44e/fabrikam.com@040f2415-e6e3-4480-96ce-26ef73275f73`|
|`iss`||`00000001-0000-0000-c000-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73`|
|`nbf`||`1335822895`|
|`exp`||`1335866095`|
|`appctxsender`|<span data-ttu-id="15ebc-337">Сокращение от "application context sender" (отправитель контекста приложения).</span><span class="sxs-lookup"><span data-stu-id="15ebc-337">Short for "application context sender".</span></span> <span data-ttu-id="15ebc-338">Представляет приложение, которое отправило токен контекста надстройке SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-338">Short for "application context sender". It represents the application that sent the context token to the SharePoint Add-in.</span></span> <span data-ttu-id="15ebc-339">Представлено в формате `GUID of principal@SharePoint realm`, где _GUID of principal_ — это постоянный ИД субъекта приложения (SharePoint, Exchange, Lync или Workflow).</span><span class="sxs-lookup"><span data-stu-id="15ebc-339">It has the form  GUID of principalSharePoint realm`GUID of principal@SharePoint realm`, where  _GUID of principal_ is the constant ID of the application principal; either SharePoint, Exchange 2013, Lync 2013, or Workflow.</span></span>|`00000003-0000-0ff1-ce00-000000000000@040f2415-e6e3-4480-96ce-26ef73275f73`|
|`appctx`|<span data-ttu-id="15ebc-p156">Сокращение от "app context" (контекст надстройки). Это объект JSON, который содержит элементы **CacheKey** и **SecurityTokenServiceURI**. </span><span class="sxs-lookup"><span data-stu-id="15ebc-p156">Short for "add-in context". It is a JSON object that contains the **CacheKey** and **SecurityTokenServiceURI**.</span></span>|<span data-ttu-id="15ebc-342">`CacheKey:"KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=\"`, `SecurityTokenServiceUri:"https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2\"`</span><span class="sxs-lookup"><span data-stu-id="15ebc-342"></span></span>|
|`CacheKey`|<span data-ttu-id="15ebc-p157">Уникальное значение, которое можно использовать в качестве ключа в кэше со структурой "ключ-значение" для хранения и получения маркера контекста. Его также можно использовать как значение столбца ключа в строке базы данных.</span><span class="sxs-lookup"><span data-stu-id="15ebc-p157">A unique value that can be used as the key in any key/value structured cache to store and retrieve the context token. It could also be used as the value of a key column in a row of a database.</span></span>|`KQAIUpDUD0sm5Tr83U+jZGYVuPPCPu8BGwoWiAACqNw=`|
|`SecurityTokenServiceURI`|<span data-ttu-id="15ebc-345">URI службы, издавшей маркер.</span><span class="sxs-lookup"><span data-stu-id="15ebc-345">The URI of the token issuing service.</span></span>|`https://accounts.accesscontrol.windows-int-sn1-004.accesscontrol.aadint.windows-int.net/tokens/OAuth/2`|
|`refreshtoken`|<span data-ttu-id="15ebc-346">Маркер обновления для надстройки.</span><span class="sxs-lookup"><span data-stu-id="15ebc-346">The refresh token for the add-in.</span></span>|`IAAAAC1Lv5w0OrcFAmJx0xk6???`|
|`isbrowserhostedapp`|<span data-ttu-id="15ebc-347">Поле **Boolean**, которое определяет, откуда поступил запрос в надстройку с маркером контекста: из браузера (true) или из удаленного приемника событий (false).</span><span class="sxs-lookup"><span data-stu-id="15ebc-347">A **Boolean** field that specifies whether the request to the add-in that contains the context token is coming from a browser (true) or from a remote event receiver (false).</span></span>|`true`|

<br/>

<span data-ttu-id="15ebc-348"><a name="UseContextTokenToLimitAccess"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-348"></span></span>

### <a name="use-the-context-token-to-limit-access-to-only-sharepoint-users"></a><span data-ttu-id="15ebc-349">Использование токена контекста для предоставления доступа только пользователям SharePoint</span><span class="sxs-lookup"><span data-stu-id="15ebc-349">Use the context token to limit access to only SharePoint users</span></span>

<span data-ttu-id="15ebc-350">Если вы хотите, чтобы ваш удаленный компонент (например, служба WCF), был доступен только пользователям SharePoint, код может просто проверять токен контекста в HTTP-запросе.</span><span class="sxs-lookup"><span data-stu-id="15ebc-350">If you want to limit access to your remote component, such as a WCF service, to SharePoint users, your code can simply validate the context token in the HTTP Request.</span></span> <span data-ttu-id="15ebc-351">Если вы используете управляемый код, можете просто вызвать метод `TokenHelper.ReadAndValidateContextToken()`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-351">(If you are using managed code, you can just call `TokenHelper.ReadAndValidateContextToken()`).</span></span> 

<span data-ttu-id="15ebc-352">Если требуется убедиться, что субъектом является SharePoint (а не Exchange, Lync или Workflow), то в коде можно проверять, начинается ли соответствующее утверждение в токене со строки `00000003-0000-0ff1-ce00-000000000000`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-352">Your code can verify that the actor claim of the token starts with `00000003-0000-0ff1-ce00-000000000000`, if you want to make sure that it is SharePoint (and not, for example, Exchange, Lync, or Workflow).</span></span> <span data-ttu-id="15ebc-353">Если вы хотите выполнять дополнительные проверки, требующие обратного вызова SharePoint, например разрешать доступ только пользователям с определенной ролью в SharePoint, вы можете кэшировать значение, указывающее, что определенный пользователь уже прошел такую проверку (с помощью ключа **CacheKey** токена контекста), чтобы не делать это несколько раз.</span><span class="sxs-lookup"><span data-stu-id="15ebc-353">If you want to limit access to your remote component, such as a WCF service, to SharePoint users, your code can simply validate the context token in the HTTP Request. (If you are using managed code, you can just call  TokenHelper.ReadAndValidateContextToken()). Your code can verify that the actor claim of the token starts with  00000003-0000-0ff1-ce00-000000000000, if you want to make sure that it is SharePoint (and not, for example, Exchange 2013, Lync 2013, or Workflow). If you want to do additional validation that requires a call back to SharePoint, such as limiting access to users with a certain role in SharePoint, you can cache the fact that you have done this validation for a particular user (by using the context token's **CacheKey**) so that you have to do this only once.</span></span>
 

<span data-ttu-id="15ebc-354"><a name="RefreshTokens"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-354"></span></span> 

## <a name="refresh-tokens"></a><span data-ttu-id="15ebc-355">Маркеры обновления</span><span class="sxs-lookup"><span data-stu-id="15ebc-355">Refresh tokens</span></span>

<span data-ttu-id="15ebc-356">Маркер обновления включен в токен контекста, который SharePoint отправляет веб-приложению при его запуске.</span><span class="sxs-lookup"><span data-stu-id="15ebc-356">A refresh token is included in the context token that SharePoint posts to your web application when it is launched.</span></span> <span data-ttu-id="15ebc-357">Маркер обновления — это зашифрованный токен, который надстройка SharePoint не может расшифровать.</span><span class="sxs-lookup"><span data-stu-id="15ebc-357">The refresh token is an encrypted token that your SharePoint Add-in cannot unencrypt.</span></span> <span data-ttu-id="15ebc-358">Код использует его (наряду с другими сведениями), чтобы получить новый маркер доступа по истечении срока действия текущего.</span><span class="sxs-lookup"><span data-stu-id="15ebc-358">Your code uses it, along with other information, to get a new access token when the current access token expires.</span></span> <span data-ttu-id="15ebc-359">Он также используется для получения *первого* маркера доступа в [потоке токена контекста](context-token-oauth-flow-for-sharepoint-add-ins.md).</span><span class="sxs-lookup"><span data-stu-id="15ebc-359">It is also used to get the *first* access token in the [Context Token flow](context-token-oauth-flow-for-sharepoint-add-ins.md).</span></span> <span data-ttu-id="15ebc-360">На момент написания этой статьи срок действия маркеров обновления для SharePoint, выданных службой контроля доступа, составляет 6 месяцев, но он может измениться.</span><span class="sxs-lookup"><span data-stu-id="15ebc-360">(When this article was written, ACS-issued refresh tokens for SharePoint had a life span of 6 months, but that could change.)</span></span>

<span data-ttu-id="15ebc-361">Так как маркер доступа действует только несколько часов (на данный момент — 12), а пользователь получает новый при каждом запуске надстройки SharePoint, маркер обновления нужен только в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="15ebc-361">Since an access token lasts hours (currently 12) and an end user gets a new one each time he launches your SharePoint Add-in from SharePoint, you only need the refresh token in one of these scenarios:</span></span>

- <span data-ttu-id="15ebc-362">Пользователи открыли продолжительные сеансы надстройки, в которых она выполняет вызовы SharePoint в течение нескольких часов (более 12) после запуска.</span><span class="sxs-lookup"><span data-stu-id="15ebc-362">Users have long running sessions with your add-in in which the add-in makes calls to SharePoint many hours (currently more than 12) after it is launched.</span></span>

- <span data-ttu-id="15ebc-363">Структура надстройки дает пользователям возможность планировать доступ надстройки к SharePoint после окончания сеанса.</span><span class="sxs-lookup"><span data-stu-id="15ebc-363">The add-in's design enables users to schedule the add-in to access SharePoint sometime after the session ends.</span></span>
    
<span data-ttu-id="15ebc-364">В обоих случаях надстройке необходимо кэшировать токен обновления, а во втором требуется серверный кэш, сохраняемый между сеансами.</span><span class="sxs-lookup"><span data-stu-id="15ebc-364">Both scenarios require your add-in to cache the refresh token, and the second scenario requires a server-side cache that is durable across sessions.</span></span> <span data-ttu-id="15ebc-365">Вам доступны те же варианты кэширования, что и для [маркера доступа](#CacheAccessToken), а в потоке токена контекста можно использовать [ключ кэша в токене контекста](#CacheKey).</span><span class="sxs-lookup"><span data-stu-id="15ebc-365">Your caching options are the same as those for the [access token](#CacheAccessToken) and, in the Context Token flow, you can use [the cache key in the context token](#CacheKey).</span></span> <span data-ttu-id="15ebc-366">Как правило, в последнем случае кэшируется только токен контекста.</span><span class="sxs-lookup"><span data-stu-id="15ebc-366">(In the Context Token flow, you usually just cache the context token.</span></span> <span data-ttu-id="15ebc-367">Он содержит маркер обновления и другие сведения, необходимые для получения нового маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-367">It contains the refresh token and other information that you need to get a new access token.</span></span> <span data-ttu-id="15ebc-368">В [потоке кода авторизации](authorization-code-oauth-flow-for-sharepoint-add-ins.md) токен контекста не используется, поэтому кэшируется сам маркер обновления.</span><span class="sxs-lookup"><span data-stu-id="15ebc-368">In the [Authorization Code flow](authorization-code-oauth-flow-for-sharepoint-add-ins.md), there is no context token, so you cache the refresh token itself.)</span></span>

<span data-ttu-id="15ebc-369">Если вы кэшируете маркер обновления в хранилище, сохраняемом между сеансами определенного пользователя в надстройке, обязательно замените его новейшим маркером обновления.</span><span class="sxs-lookup"><span data-stu-id="15ebc-369">If you are caching the refresh token in a storage that persists across a specific user's sessions with your add-in, be sure to replace it with the newest refresh token. In both the Cloud-hosted and Authorization Code flows, the user gets a new refresh token each time he or she launches the add-in.</span></span> <span data-ttu-id="15ebc-370">Как при размещении в облаке, так и в потоке кода авторизации пользователь получает новый маркер обновления при каждом запуске надстройки.</span><span class="sxs-lookup"><span data-stu-id="15ebc-370">In both the cloud-hosted and Authorization Code flows, the user gets a new refresh token each time he or she launches the add-in.</span></span>

<span data-ttu-id="15ebc-371">Если срок действия маркера обновления истек, то запрос к ACS на получение нового маркера доступа приведет к ошибке **401 Unauthorized**.</span><span class="sxs-lookup"><span data-stu-id="15ebc-371">If the refresh token is expired, a request to ACS for a new access token results in a **401 Unauthorized** error.</span></span> <span data-ttu-id="15ebc-372">Надстройка должна реагировать на эту ошибку, получая новый маркер обновления и используя его для получения нового маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-372">Your add-in should respond to this error by getting a new refresh token and using it to get a new access token.</span></span> <span data-ttu-id="15ebc-373">Так как маркер обновления шифруется, код не может проверять срок его действия перед использованием маркера.</span><span class="sxs-lookup"><span data-stu-id="15ebc-373">(Because the refresh token is encrypted, your code cannot check its expiration before using it.)</span></span> 

<span data-ttu-id="15ebc-374">В потоке токена контекста надстройка получает новый маркер обновления, [получая новый токен контекста](#GetNewContextToken).</span><span class="sxs-lookup"><span data-stu-id="15ebc-374">In the Context Token flow, your add-in gets a new refresh token by [getting a new context token](#GetNewContextToken).</span></span> <span data-ttu-id="15ebc-375">В потоке кода авторизации надстройка получает новый маркер обновления, перезапуская поток.</span><span class="sxs-lookup"><span data-stu-id="15ebc-375">In the Authorization Code flow, your add-in gets a new refresh token by restarting the flow.</span></span> <span data-ttu-id="15ebc-376">В частности, при возникновении этой ошибки код должен перенаправлять пользователя на страницу SharePoint OAuthAuthorize.aspx, как описано в статье [Общие сведения о потоке OAuth для надстроек, запрашивающих разрешения во время выполнения](authorization-code-oauth-flow-for-sharepoint-add-ins.md#Flow).</span><span class="sxs-lookup"><span data-stu-id="15ebc-376">Specifically, your code should respond to the error by redirecting the user to the SharePoint OAuthAuthorize.aspx page as explained in [Understand the OAuth flow for add-ins that request permissions on the fly](authorization-code-oauth-flow-for-sharepoint-add-ins.md#Flow).</span></span>
 

<span data-ttu-id="15ebc-377"><a name="Authcodes"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-377"></span></span> 

## <a name="authorization-codes"></a><span data-ttu-id="15ebc-378">Коды авторизации</span><span class="sxs-lookup"><span data-stu-id="15ebc-378">Authorization codes</span></span>

<span data-ttu-id="15ebc-379">В потоке кода авторизации процесс начинается с кода, выдаваемого службой контроля доступа по запросу SharePoint. Затем SharePoint передает этот код удаленному приложению в качестве параметра запроса.</span><span class="sxs-lookup"><span data-stu-id="15ebc-379">In the Authorization Code flow, the authorization process begins with an authorization code that ACS issues, at the request of SharePoint, and which SharePoint then passes to the remote application as a query parameter.</span></span> <span data-ttu-id="15ebc-380">Код авторизации уникален для каждой пары пользователя и удаленного приложения.</span><span class="sxs-lookup"><span data-stu-id="15ebc-380">The authorization code is unique to each pair of user and remote application.</span></span> <span data-ttu-id="15ebc-381">На момент написания этой статьи срок действия кодов авторизации для SharePoint, выданных службой контроля доступа, составляет 5 минут, но он может измениться.</span><span class="sxs-lookup"><span data-stu-id="15ebc-381">(When this article was written, ACS-issued authorization codes for SharePoint had a life span of 5 minutes, but that could change.)</span></span> 

<span data-ttu-id="15ebc-382">Логика приложения должна получать код авторизации из параметра запроса и использовать его в запросе к ACS на получение маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="15ebc-382">The logic in your application must get the authorization code from the query parameter and use it in a request to ACS for an access token.</span></span> <span data-ttu-id="15ebc-383">Если вы используете управляемый код, то пример кода для создания токена находится в файле TokenHelper.cs (и TokenHelper.vb).</span><span class="sxs-lookup"><span data-stu-id="15ebc-383">If you are using managed code, sample code for creating the token is in the TokenHelper.cs (and .vb) file.</span></span> <span data-ttu-id="15ebc-384">Образец кода, считывающего параметр запроса, см. в разделе [Пример кода страницы, получающей доступ к SharePoint](authorization-code-oauth-flow-for-sharepoint-add-ins.md#Default).</span><span class="sxs-lookup"><span data-stu-id="15ebc-384">Sample code for reading the query parameter is in [Get sample code-behind for a page that accesses SharePoint](authorization-code-oauth-flow-for-sharepoint-add-ins.md#Default).</span></span> <span data-ttu-id="15ebc-385">ACS делает код авторизации недействительным сразу после выдачи маркера доступа, поэтому его можно использовать только один раз и нет смысла кэшировать.</span><span class="sxs-lookup"><span data-stu-id="15ebc-385">ACS invalidates the authorization code immediately after issuing the access token, so it can only be used once, and there is no point in caching it.</span></span>
 

<span data-ttu-id="15ebc-386"><a name="JWTtimes"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-386"></span></span> 

## <a name="jwt-time-values"></a><span data-ttu-id="15ebc-387">Значения времени в формате JWT</span><span class="sxs-lookup"><span data-stu-id="15ebc-387">Work with JWT time values</span></span>

<span data-ttu-id="15ebc-388">Утверждения `nbf` и `exp` представлены в формате, определенном [спецификацией JWT](http://self-issued.info/docs/draft-goland-json-web-token-00l).</span><span class="sxs-lookup"><span data-stu-id="15ebc-388">The `nbf` and `exp` claims are in the format specified by the [JWT specification](http://self-issued.info/docs/draft-goland-json-web-token-00l).</span></span> <span data-ttu-id="15ebc-389">Эти значения представляют собой количество секунд с 1 января 1970 г.</span><span class="sxs-lookup"><span data-stu-id="15ebc-389">They are written as the number of seconds since January 1, 1970.</span></span> <span data-ttu-id="15ebc-390">На C# эти значения можно преобразовать с помощью приведенного ниже кода, где `jWTTimeStamp` — это значение из токена, например `1335822895`.</span><span class="sxs-lookup"><span data-stu-id="15ebc-390">The  nbf and exp claims are in the format specified by the JWT specification. They are written as the number of seconds since Jan 1, 1970. In C#, you can translate these values with the following code, where  jWTTimeStamp is the value from the token, such as 1335822895.</span></span>

```C#
DateTime exp = new DateTime(1970,1,1).AddSeconds(jWTTimeStamp);

```

<span data-ttu-id="15ebc-391"><a name="Troubleshooting"> </a></span><span class="sxs-lookup"><span data-stu-id="15ebc-391"></span></span>

## <a name="troubleshooting-token-handling"></a><span data-ttu-id="15ebc-392">Устранение неполадок при обработке маркеров</span><span class="sxs-lookup"><span data-stu-id="15ebc-392">Troubleshooting token handling</span></span>

<span data-ttu-id="15ebc-393">С помощью бесплатного [средства Fiddler](http://www.telerik.com/fiddler) можно захватывать HTTP-запросы, отправляемые удаленным компонентом надстройки в среду SharePoint.</span><span class="sxs-lookup"><span data-stu-id="15ebc-393">The free  [Fiddler tool](http://www.telerik.com/fiddler) can be used to capture the HTTP Requests sent by the remote component of your add-in to SharePoint. There is a free extension to the tool that automatically decodes the tokens in the requests.</span></span> <span data-ttu-id="15ebc-394">Существует [бесплатное расширение для этого средства](https://github.com/andrewconnell/SPOAuthFiddlerExt), которое автоматически раскодирует токены в запросах.</span><span class="sxs-lookup"><span data-stu-id="15ebc-394">The free  Fiddler tool can be used to capture the HTTP Requests sent by the remote component of your add-in to SharePoint. There is a [free extension to the tool](https://github.com/andrewconnell/SPOAuthFiddlerExt) that automatically decodes the tokens in the requests.</span></span>
 
## <a name="see-also"></a><span data-ttu-id="15ebc-395">См. также</span><span class="sxs-lookup"><span data-stu-id="15ebc-395">See also</span></span>

- [<span data-ttu-id="15ebc-396">Образец кода SharePoint: удаленная надстройка Hello World с использованием CSOM</span><span class="sxs-lookup"><span data-stu-id="15ebc-396">SharePoint code sample: Hello World remote add-in using CSOM</span></span>](https://code.msdn.microsoft.com/SharePoint-2013-Hello-0fd15fbf)
- [<span data-ttu-id="15ebc-397">Пример пакета надстроек SharePoint</span><span class="sxs-lookup"><span data-stu-id="15ebc-397">SharePoint Add-ins sample pack</span></span>](https://code.msdn.microsoft.com/office/Apps-for-SharePoint-sample-64c80184)
- [<span data-ttu-id="15ebc-398">Создание надстроек SharePoint, использующих авторизацию с низким уровнем доверия</span><span class="sxs-lookup"><span data-stu-id="15ebc-398">Creating SharePoint Add-ins that use low-trust authorization</span></span>](creating-sharepoint-add-ins-that-use-low-trust-authorization.md)
- [<span data-ttu-id="15ebc-399">Авторизация и проверка подлинности для надстроек в SharePoint</span><span class="sxs-lookup"><span data-stu-id="15ebc-399">Authorization and authentication of SharePoint Add-ins</span></span>](authorization-and-authentication-of-sharepoint-add-ins.md)