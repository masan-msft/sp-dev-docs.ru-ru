---
title: "Создание надстроек с высоким уровнем доверия для SharePoint"
ms.date: 09/25/2017
ms.prod: sharepoint
ms.openlocfilehash: a790b6da4f32aea79a099dc76c0605e637622f9d
ms.sourcegitcommit: 1cae27d85ee691d976e2c085986466de088f526c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2017
---
# <a name="create-high-trust-sharepoint-add-ins"></a>Создание надстроек с высоким уровнем доверия для SharePoint
Узнайте, как создать надстройку для SharePoint с высоким уровнем доверия. Надстройка с высоким уровнем доверия использует цифровые сертификаты, чтобы установить доверие между удаленным веб-приложением и SharePoint. Надстройки с высоким уровнем доверия могут быть установлены только на локальную версию SharePoint, а не на Microsoft SharePoint Online, и в первую очередь предназначены для использования локально, а не для веб-приложений на базе облака.
 

 **Примечание.** В настоящее время идет процесс замены названия "приложения для SharePoint" названием "надстройки SharePoint". Во время этого процесса в документации и пользовательском интерфейсе некоторых продуктов SharePoint и средств Visual Studio может по-прежнему использоваться термин "приложения для SharePoint". Дополнительные сведения см. в статье [Новое название приложений для Office и SharePoint](new-name-for-apps-for-sharepoint.md#bk_newname).
 


## <a name="prerequisites-for-creating-high-trust-add-ins"></a>Необходимые условия для создания надстроек с высоким уровнем доверия
<a name="Prereqs"> </a>

Прежде чем выполнять процедуры, описанные в этой статье, убедитесь, что у вас есть следующее:
 

 

- Локальная среда разработки SharePoint. См. раздел [Настройка локальной среды разработки надстроек SharePoint](set-up-an-on-premises-development-environment-for-sharepoint-add-ins.md) для получения инструкций по установке. В частности, убедитесь, что вы выполнили действия в разделе [Настройка служб в SharePoint для межсерверного использования надстройки](set-up-an-on-premises-development-environment-for-sharepoint-add-ins.md#Servertoserver).
    
 
- Опыт создания надстроек SharePoint, размещаемых у поставщика. См. статью [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md).
    
 
- Среда Visual Studio, установленная удаленно или на том же компьютере, что и SharePoint.
    
 
- Инструменты разработчика Microsoft Office для Visual Studio.
    
 
- Представление о том, что такое цифровые сертификаты и как их использовать.
    
 
Ознакомьтесь с указанными ниже статьями, чтобы получить лучшее представление о надстройках SharePoint и цифровых сертификатах.
 

 

**Таблица 1. Основные понятия, связанные с настройкой SharePoint для запуска надстроек с высоким уровнем доверия**


|**Название статьи**|**Описание**|
|:-----|:-----|
| [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md)|Узнайте, как создать простейшую надстройку для SharePoint, размещаемую у поставщика, с помощью Инструменты разработчика Office для Visual Studio, как взаимодействовать с сайтами SharePoint с помощью SharePoint CSOM.|
| [Цифровые сертификаты](http://msdn.microsoft.com/library/e523b335-0156-4f47-b55c-b80495587c4f.aspx) и [Работа с сертификатами](http://msdn.microsoft.com/library/6ffb8682-8f07-4a45-afbb-8d2487e9dbc3.aspx)|Изучите основы работы с цифровыми сертификатами.|

## <a name="introduction-to-running-high-trust-add-ins"></a>Общие сведения о запуске надстроек с высоким уровнем доверия
<a name="Intro"> </a>

Надстройка с высоким уровнем доверия это Надстройка SharePoint, которая размещается у поставщика и использует сертификаты для установки высокого уровня доверия между веб-приложением и SharePoint. Высокий уровень доверия это не то же самое, что полное доверие. Надстройка с высоким уровнем доверия должна запрашивать разрешение надстройки. Высокий уровень доверия означает, что надстройка может использовать любое необходимое удостоверение пользователя, так как она ответственна за создание той части маркера доступа, которую передает SharePoint.
 

 
Надстройка SharePoint с высоким уровнем доверия в первую очередь предназначена для использования в локальной среде. Надстройки с высоким уровнем доверия не могут быть установлены в Microsoft SharePoint Online, и удаленные компоненты обычно тоже устанавливаются локально с использованием корпоративного брандмауэра. Таким образом, экземпляры надстроек SharePoint уникальны для каждой конкретной компании.
 

 
Надстройка с высоким уровнем доверия использует сертификат для установления доверия вместо маркера контекста. (Надстройку, размещаемую поставщиком для использования Служба контроля доступа Microsoft Azure (ACS) в качестве доверенного брокера, необходимо изменить, чтобы она работала как приложение с высоким уровнем доверия.) Надстройку с высоким уровнем доверия необходимо настроить на ферме SharePoint и на сервере, где размещается удаленное веб-приложение. В этом разделе указаны шаги настройки, которые необходимо предпринять для работы отладки Visual Studio ( **F5**). Настройка тестовой, промежуточной и продуктивной среды имеет свои отличия и описана в разделе  [Упаковка и публикация надстроек с высоким уровнем доверия для SharePoint](package-and-publish-high-trust-sharepoint-add-ins.md). 
 

 
В SharePoint служба маркеров безопасности S2S предоставляет маркеры доступа для проверки подлинности по протоколу S2S. Эти временные маркеры обеспечивают доступ к другим службам приложения, например Exchange 2013, Lync 2013 и надстройкам для SharePoint. Отношение доверия между службами приложения (например, SharePoint доверяет удаленной надстройке, которая, в свою очередь, доверяет SharePoint) устанавливается с помощью командлетов Windows PowerShell и сертификата.
 

 

 **Примечание.** Служба маркеров безопасности S2S не предназначена для проверки подлинности пользователей. Поэтому она не указывается на странице входа пользователя, в разделе **Служба проверки подлинности** Центра администрирования и в средстве выбора людей в SharePoint.
 

В этой статье рассматриваются инструкции по созданию надстроек с высоким уровнем доверия и их настройке для запуска в Visual Studio при нажатии клавиши **F5**. Вы научитесь выполнять следующие действия:
 

 

- конфигурация надстройки для использования в качестве надстройки с высоким уровнем доверия;
    
 
- настройка SharePoint для использования надстроек с высоким уровнем доверия;
    
 
- создание простейшей надстройки с высоким уровнем доверия;
    
 

## <a name="obtain-a-certificate-or-create-a-public-and-private-test-certificate"></a>получение сертификата или создание общедоступного и закрытого сертификатов для тестирования.
<a name="Cert2"> </a>

Для удаленного веб-приложения вашей надстройки с высоким уровнем доверия необходим цифровой сертификат X.509. Чтобы можно было полностью протестировать надстройку для SharePoint, требуется сертификат, выданный доменом, или коммерческий сертификат, выданный в центре сертификации. Тем не менее, для начальной фазы отладки можно использовать самозаверяющий сертификат. Следующая процедура описывает создание и экспорт тестового сертификата с помощью IIS. Сведения о том, как изменить самозаверяющий сертификат на сертификат, выданный доменом, или коммерческий сертификат можно найти ниже в разделе  [Полная отладка с сертификатом, выданным доменом, или коммерческим сертификатом](#NewCertificate).
 

 
Вы также можете создать тестовый сертификат X.509 с помощью тестовой программы MakeCert. Дополнительные сведения о ее использовании см. в статье  [Подпись и проверка кода с помощью технологии Authenticode](http://msdn.microsoft.com/ru-RU/library/ms537364%28VS.85%29.aspx).
 

 
Сначала необходимо создать тестовый PFX-файл сертификата, а затем соответствующий CER-файл. PFX-файл сертификата содержит закрытый ключ, который используется удаленным веб-приложением для цифровых подписей в SharePoint. CER-файл сертификата содержит открытый ключ, с помощью которого SharePoint расшифровывает подписи, проверяет, что они отправлены удаленным веб-приложением, и проверяет, что удаленное веб-приложение имеет маркер доступа от поставщика маркера, которому доверяет SharePoint. Дополнительные сведения о PFX- и CER-файлах см. в разделе  [Software Publisher Certificate](http://msdn.microsoft.com/ru-RU/library/windows/hardware/ff552299%28v=vs.85%29.aspx)
 

 

### <a name="to-create-a-self-signed-test-pfx-certificate-file"></a>Создание тестового PFX-файла самозаверяющего сертификата


1. При отладке надстройки для SharePoint с высоким уровнем доверия в Visual Studio удаленное веб-приложение размещается в IIS Express на компьютере, где установлен Visual Studio. Поэтому на компьютере с удаленным веб-приложением может быть не установлен диспетчер IIS для создания сертификатов. По этой причине для создания сертификата необходимо использовать IIS на тестовом сервере  *SharePoint*  . В диспетчере IIS выберите узел _ServerName_ в представлении в виде дерева слева.
    
 
2. Щелкните значок **Сертификаты сервера**, как показано на рис. 1.
    
    **Рисунок 1. Элемент "Сертификаты сервера" в службах IIS**

 

  ![Элемент "Сертификаты сервера" в службах IIS](../images/e38f9b7f-59a3-468c-bcde-a48272f1f217.gif)
 

 

 
3. Выберите ссылку **Создать самозаверяющий сертификат** в списке ссылок справа, как показано на рис. 2.
    
    **Рисунок 2. Ссылка "Создать самозаверяющий сертификат"**

 

  ![Ссылка "Создать самозаверяющий сертификат"](../images/3f0aae5a-e58b-4ec8-b67f-0024abfa2dab.gif)
 

 

 
4. Задайте для сертификата имя HighTrustSampleCert и нажмите кнопку **ОК**.
    
 
5. Щелкните сертификат правой кнопкой мыши и выберите команду **Экспорт**, как показано на рис. 3.
    
    **Рис. 3. Экспорт тестового сертификата**

 

  ![Экспорт тестового сертификата](../images/997021de-c60c-46b0-961f-7e1e63c0f619.gif)
 

 

 
6. В Windows или в командной строке создайте папку с именем C:\Certs.
    
 
7. В диспетчере IIS экспортируйте файл в папку C:\Certs и задайте для него пароль. В этом примере используется пароль **password**.
    
 
8. Если тестовая версия SharePoint и среда Visual Studio установлены на разных компьютерах, создайте папку C:\Certs на компьютере с Visual Studio и переместите в нее файл HighTrustSampleCert.pfx. При запуске отладки в Visual Studio удаленное веб-приложение будет работать на этом компьютере.
    
 

### <a name="to-create-a-corresponding-cer-file"></a>Создание соответствующего CER-файла


1. На сервере SharePoint убедитесь, что удостоверения следующих пулов надстроек IIS содержат права на чтение папки C:\Certs:
    
      -  **SecurityTokenServiceApplicationPool**.
    
 
  - Пул надстроек, обслуживающий веб-сайт IIS, на котором размещается родительское веб-приложение SharePoint для тестового веб-сайта SharePoint. Пул для веб-сайта IIS **SharePoint - 80** называется **OServerPortalAppPool**.
    
 
2. В диспетчере IIS выберите узел _Имя сервера_ в представлении в виде дерева слева.
    
 
3. Дважды щелкните элемент **Сертификаты сервера**.
    
 
4. В представлении **Сертификаты сервера** дважды щелкните сертификат **HighTrustSampleCert**, чтобы просмотреть сведения о нем.
    
 
5. На вкладке **Сведения** нажмите кнопку **Копировать в файл**, чтобы запустить **мастер экспорта сертификатов**, а затем нажмите кнопку **Далее**.
    
 
6. Оставьте значение по умолчанию (**Нет, не экспортировать закрытый ключ**) и нажмите кнопку **Далее**.
    
 
7. Оставьте значения по умолчанию. Нажмите кнопку **Далее**.
    
 
8. Нажмите кнопку **Обзор**, перейдите в папку C:\Certs, назовите файл сертификата **HighTrustSampleCert** и нажмите кнопку **Сохранить**. Сертификат будет сохранен как CER-файл.
    
 
9. Нажмите кнопку **Далее**.
    
 
10. Нажмите кнопку **Готово**.
    
 

## <a name="configure-sharepoint-to-use-certificates-and-configure-trust-for-your-add-in"></a>Настройка SharePoint на использование сертификатов и настройка доверия для надстройки
<a name="Configure2"> </a>

Сценарий Windows PowerShell, создание которого описывается в этом разделе, призван обеспечить поддержку использования клавиши **F5** в Visual Studio. Он *не* сможет должным образом настроить промежуточную или рабочую установку SharePoint. Сведения о настройке рабочей среды SharePoint на использование сертификатов см. в статье [Упаковка и публикация надстроек с высоким уровнем доверия для SharePoint](package-and-publish-high-trust-sharepoint-add-ins.md).
 

 

 **Примечание.** Прежде чем продолжать, [настройте службы в SharePoint для межсерверного использования надстройки](set-up-an-on-premises-development-environment-for-sharepoint-add-ins.md#Servertoserver) (если вы еще этого не сделали).
 


### <a name="to-configure-sharepoint"></a>Настройка SharePoint


1. В текстовом редакторе или в редакторе Windows PowerShell создайте новый файл и добавьте следующие строки для создания объекта сертификата.
    
```
  $publicCertPath = "C:\Certs\HighTrustSampleCert.cer"
$certificate = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($publicCertPath)

```

2. Добавьте следующую строку, чтобы гарантировать, что SharePoint будет относиться к сертификату как к корневому центру.
    
```
  New-SPTrustedRootAuthority -Name "HighTrustSampleCert" -Certificate $certificate 

```

3. Добавьте приведенную ниже строку, чтобы получить идентификатор области авторизации.
    
```
  $realm = Get-SPAuthenticationRealm

```

4. Удаленное веб-приложение будет использовать маркер доступа, чтобы получить доступ к данным SharePoint. Маркер доступа должен быть выдан поставщиком маркеров, которому SharePoint доверяет. В надстройке SharePoint с высоким уровнем доверия поставщиком маркера является сертификат. Добавьте следующие строки, чтобы создать идентификатор поставщика в том формате, который необходим среде SharePoint: **\_GUID\_конкретного\_поставщика\_@\_GUID\_области\_**.
    
```
  $specificIssuerId = "11111111-1111-1111-1111-111111111111"
$fullIssuerIdentifier = $specificIssuerId + '@' + $realm 

```


     **Note**  The  `$specificIssuerId` value must be a GUID because in a production environment each certificate must have a unique issuer. However, in this context, where you use the same certificate to debug all your high-trust add-ins, you can hard code the value. If for any reason, you use a different GUID from the one used here, * **be sure that any letters in the GUID are lower case***  . The SharePoint infrastructure currently requires lower case for certificate issuer GUIDs.
5. Добавьте следующие строки, чтобы зарегистрировать сертификат как доверенного поставщика маркеров. Параметр  `-Name` должен быть уникальным, поскольку в рабочей конфигурации GUID обычно используется как часть имени или все имя, но в этом случае можно использовать понятное имя. Переключатель `-IsTrustBroker` необходим, чтобы гарантировать, что вы можете использовать тот же сертификат для всех надстроек с высоким уровнем доверия, которые вы разрабатываете. Команда `iisreset` требуется для немедленной регистрации поставщика маркера. Без нее, возможно, придется ждать до 24 часов для регистрации поставщика.
    
```
  New-SPTrustedSecurityTokenIssuer -Name "High Trust Sample Cert" -Certificate $certificate -RegisteredIssuerName $fullIssuerIdentifier -IsTrustBroker
iisreset 

```

6. SharePoint обычно не принимает самозаверяющие сертификаты. Поэтому когда вы используете самозаверяющие сертификаты для отладки, добавьте приведенные ниже строки, чтобы отключить стандартное требование SharePoint об использовании HTTPS для вызовов SharePoint удаленными веб-приложениями. Если этого не сделать, то когда удаленное веб-приложение с самозаверяющим сертификатом вызовет SharePoint, появится сообщение **403 (запрещено)**. Позже это изменение необходимо будет отменить. Отключение требования HTTPS означает, что запросы удаленного веб-приложения в SharePoint не шифруются, но сертификат все еще является доверенным поставщиком маркеров доступа, что является его основной функцией в приложениях для SharePoint с высоким уровнем доверия.
    
```
  $serviceConfig = Get-SPSecurityTokenServiceConfig
$serviceConfig.AllowOAuthOverHttp = $true
$serviceConfig.Update()

```

7. Сохраните файл с именем HighTrustConfig-ForDebugOnly.ps1.
    
 
8. Откройте **командную консоль SharePoint** от имени администратора и запустите файл со следующей строкой:
    
```
  ./HighTrustConfig-ForDebugOnly.ps1
```


## <a name="create-a-high-trust-sharepoint-add-in"></a>Создание надстройки SharePoint с высоким уровнем доверия
<a name="Createapp2"> </a>

В этом разделе описано, как создать надстройку SharePoint с высоким уровнем доверия с помощью Visual Studio.
 

 

 **Примечание.** Как указано в разделе [Необходимые условия для создания надстроек с высоким уровнем доверия](#Prereqs), в этой статье предполагается, что вы умеете создавать надстройки SharePoint, размещаемые у поставщика. Дополнительные сведения см. в статье [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md).
 


### <a name="to-create-a-high-trust-sharepoint-add-in"></a>Создание надстройки SharePoint с высоким уровнем доверия


1. В меню Visual Studio последовательно выберите пункты **Файл**, **Создать** и **Проект**.
    
 
2. В **мастере создания проекта** разверните узел **Visual C#** или **Visual Basic**, а затем — узел **Office/SharePoint**.
    
 
3. Выберите **Надстройки**, а затем создайте проект **надстройки для SharePoint**.
    
 
4. Задайте для проекта имя HighTrustSampleApp.
    
 
5. Сохраните проект в любой папке на свой выбор и нажмите кнопку **ОК**.
    
 
6. Укажите полный URL-адрес сайта разработчика приложений для SharePoint, например http://TestServer/sites/devsite/
    
 
7. Выберите вариант **Размещено у поставщика**, а затем нажмите кнопку **Далее**.
    
 
8. Если вам будет предложено указать тип веб-проекта, выберите **Приложение веб-форм ASP.NET** для рассматриваемого в этой статье примера, а затем нажмите кнопку **Далее**.
    
 
9. Откроется страница мастера с **параметрами проверки подлинности**. Указанные в этой форме значения будут автоматически добавлены в файл web.config. В разделе **Как требуется выполнять проверку подлинности надстройки?** выберите пункт **Использовать сертификат**.
    
 
10. Нажмите кнопку **Обзор** рядом с полем **Расположение сертификата** и укажите путь к созданному вами самозаверяющему сертификату (PFX-файлу) — C:\Certs. В этом поле необходимо указать полный путь — C:\Certs\HighTrustSampleCert.pfx. 
    
 
11. Введите пароль этого сертификата в поле **Пароль**. В данном случае это "password".
    
 
12. Введите идентификатор поставщика (`11111111-1111-1111-1111-111111111111`) в поле **Идентификатор поставщика**.
    
 
13. Нажмите кнопку **Готово**. Основная часть операций по настройке совершается при открытии решения. В решении Visual Studio создаются два проекта: один для надстройки SharePoint, а другой для веб-приложения ASP.NET.
    
 

### <a name="to-run-and-debug-the-add-in"></a>Запуск и отладка надстройки


1. Инструменты разработчика Office для Visual Studio автоматически создает файлы default.aspx и default.aspx.cs при создании проекта ASP.NET. Созданный код получает название хост-сайта SharePoint и отображает его на странице по умолчанию удаленного веб-приложения. Точная пометка и код этих файлов зависит от версии средств. Для этой темы используются файлы default.aspx и default.aspx.cs без изменений.
    
 
2. Чтобы протестировать надстройку SharePoint и ее удаленное веб-приложение, нажмите клавишу **F5** в Visual Studio. Веб-приложение будет развернуто в IIS Express на *localhost*. Надстройка SharePoint будет установлена на целевом веб-сайте SharePoint. В SharePoint появится предложение предоставить разрешения, которые запрашивает надстройка SharePoint. В некоторых версиях Инструментов разработчика Office для Visual Studio надстройка запустится немедленно, а в других откроется страница целевого веб-сайта SharePoint **Содержимое сайта**, на которой вы увидите новую надстройку.
    
    Запустите надстройку, если она не запустилась автоматически. В удаленном веб-приложении откроется страница, которую вы указали в качестве **начальной страницы** в файле AppManifest.xml, — Default.aspx. Надстройка должна выглядеть так, как показано на рисунке 4.
    

    **Рис. 4. Пример надстройки вызывает SharePoint Server и получает название хост-сайта SharePoint**

 

  ![Пример приложения, получающего название веб-сайта](../images/SP15HighTrustLaunchNew.gif)
 

 

 

## <a name="complete-debugging-with-a-domain-issued-or-commercial-certificate"></a>Полная отладка с доменным или коммерческим сертификатом
<a name="NewCertificate"> </a>

Сценарий Windows PowerShell, который вы создали ранее, отключил стандартное требование SharePoint об использовании удаленным веб-приложением протокола HTTPS для доступа к SharePoint. С отключенным HTTPS вы можете пропустить некоторые проблемы во время разработки надстройки, которые появятся во время рабочего развертывания, когда потребуется HTTPS. Соответственно, не стоит считать стадии разработки и отладки завершенными до того, как вы замените тестовый сертификат сертификатом, выданным доменом, или коммерческим сертификатом и заново протестируете надстройку со включенным требованием HTTPS.
 

 
При приобретении нового сертификата необходимо назначить для него пароль, если он не назначен. В рабочей среде необходимо использовать надежный пароль. Для того чтобы отладить надстройку для SharePoint, подойдет любой. Вам понадобится сертификат в двух форматах: PFX и CER. Если вы получили файл сертификата не в формате PFX, требуется преобразовать его в формат PFX с помощью служебной программы. Когда вы получите PFX-файл, вы сможете импортировать его в IIS и экспортировать CER-файл, как описано в следующем этапе.
 

 

### <a name="to-import-the-new-certificate"></a>Импорт нового сертификата


1. Поместите PFX-файл в папку C:\Certs на сервере SharePoint. Во всех инструкциях этой статьи указан файл с именем _MyCert_.pfx. Необходимо заменить MyCert на фактическое имя вашего сертификата.
    
 
2. В диспетчере IIS выберите узел _Имя сервера_ в представлении в виде дерева слева.
    
 
3. Дважды щелкните значок **Сертификаты сервера**.
    
 
4. Выберите **Импорт** в области **Действия** справа.
    
 
5. В диалоговом окне **Импорт сертификата** нажмите кнопку "Обзор" и откройте файл C:\Certs\ _MyCert_.pfx, а затем введите пароль сертификата.
    
 
6. Убедитесь, что параметр **Разрешить экспорт этого сертификата** включен, и нажмите кнопку **ОК**.
    
 
7. В списке **Сертификаты сервера** щелкните сертификат правой кнопкой мыши и выберите пункт **Экспорт**, как показано на рис. 3 выше.
    
 
8. Экспортируйте файл в папку C:\Certs и укажите пароль для него.
    
 
9. Если тестовая версия SharePoint и среда Visual Studio установлены на разных компьютерах, переместите файл _MyCert_.pfx в папку C:\Certs на компьютере с установленной средой Visual Studio. 
    
 
10. В представлении **Сертификаты сервера** дважды щелкните элемент _MyCert_, чтобы просмотреть сведения о сертификате.
    
 
11. На вкладке **Сведения** нажмите кнопку **Копировать в файл**, чтобы запустить **мастер экспорта сертификатов**, а затем нажмите кнопку **Далее**.
    
 
12. Оставьте значение по умолчанию (**Нет, не экспортировать закрытый ключ**) и нажмите кнопку **Далее**.
    
 
13. Оставьте значения по умолчанию. Нажмите кнопку **Далее**.
    
 
14. Нажмите кнопку **Обзор**, откройте папку C:\Certs, задайте для сертификата имя _MyCert_ и нажмите кнопку **Сохранить**. Сертификат сохранится в виде CER-файла.
    
 
15. Нажмите кнопку **Далее**.
    
 
16. Нажмите кнопку **Готово**.
    
 

### <a name="to-configure-sharepoint-to-use-the-new-certificate"></a>Настройка SharePoint на использование нового сертификата


1. Откройте файл HighTrustConfig-ForDebugOnly.ps1 для редактирования и внесите следующие изменения:
    
      1. Замените оба вхождения имени `HighTrustSampleCert` на _MyCert_.
    
 
  2. Замените идентификатор конкретного поставщика — `11111111-1111-1111-1111-111111111111` — на `22222222-2222-2222-2222-222222222222`.
    
 
  3. Замените имя High Trust Sample Cert на My Cert или другое, более понятное имя.
    
 
  4. В строке `$serviceConfig.AllowOAuthOverHttp = $true` замените значение `true` на `false`. После этого использование протокола HTTPS не будет обязательным.
    
 
2. Сохраните файл.
    
 
3. Откройте **командную консоль SharePoint** от имени администратора и запустите файл со следующей строкой:
    
```
  ./HighTrustConfig-ForDebugOnly.ps1
```


### <a name="to-reconfigure-the-remote-web-application"></a>Изменение конфигурации удаленного веб-приложения


1. В Visual Studio откройте файл web.config из проекта веб-приложения и внесите следующие изменения:
    
      1. В ключе `ClientSigningCertificatePath` замените имя `C:\Certs\HighTrustSampleCert.pfx` на `C:\Certs\` _MyCert_ `.pfx`.
    
 
  2. Замените значение ключа `ClientSigningCertificatePassword` на фактический пароль сертификата.
    
 
  3. Замените значение ключа `IssuerId` на `22222222-2222-2222-2222-222222222222`.
    
 
2. Нажмите клавишу **F5**, чтобы запустить отладку надстройки.
    
 
Завершив разработку надстройки с высоким уровнем доверия, обратитесь к разделу [Упаковка и публикация надстроек с высоким уровнем доверия для SharePoint](package-and-publish-high-trust-sharepoint-add-ins.md), чтобы упаковать и опубликовать эту надстройку для SharePoint.
 

 

## <a name="what-do-the-tokenhelper-and-sharepointcontext-files-do"></a>Каково назначение файлов TokenHelper и SharePointContext?
<a name="TokenHelper"> </a>

Инструменты разработчика Office для Visual Studio включает файл TokenHelper.cs (или с расширением VB) в удаленное веб-приложение. Некоторые версии средств также содержат файл SharePointContext.cs (или с расширением VB). Код в этих файлах выполняет следующие операции.
 

 

- Настраивает .NET на доверие сертификатам при выполнении сетевых вызовов. 
    
 
- Получает маркер доступа S2S, подписанный с помощью закрытого сертификата удаленного веб-приложения от имени указанного объекта **WindowsIdentity**, который SharePoint использует для создания отношений доверия.
    
 
- Получает сертификат службы маркеров безопасности SharePoint (STS).
    
 
- В надстройках, использующих систему авторизации не с высоким, а с низким уровнем доверия, у этих файлов есть дополнительные задачи. Например, обработка маркеров OAuth для сценария, описанного в статье  [Поток маркеров контекста OAuth для надстроек в SharePoint](context-token-oauth-flow-for-sharepoint-add-ins.md). В этой статье упомянутый сценарий не рассматривается. 
    
 
Дополнительные сведения о файлах TokenHelper и SharePointContext см. в комментариях из этих файлов.
 

 
В надстройке с высоким уровнем доверия нет маркера контекста. Маркер контекста применяется в конфигурациях, использующих авторизацию с низким уровнем доверия. При этом маркер доступа все равно требуется. Если вы используете конфигурацию с высоким уровнем доверия, ваше веб-приложение должно аутентифицировать пользователя, как это делает SharePoint. Другими словами, надстройка отвечает за создание маркера доступа, включая идентификаторы пользователя и поставщика удостоверений. 
 

 
Когда вы выполняете отладку в Visual Studio с помощью клавиши **F5**, Инструменты разработчика Microsoft Office для Visual Studio используют проверку подлинности Windows. При этом в двух созданных файлах кода используется идентификатор пользователя Windows, запустившего надстройку, для создания маркера доступа. Если вы хотите использовать эти два файла без изменений, после публикации надстройки следует настроить удаленное веб-приложение в диспетчере IIS так, чтобы оно использовало проверку подлинности Windows. Если надстройка не будет использовать проверку подлинности Windows, необходимо изменить созданные файлы кода, TokenHelper и SharePointContext, для использования другой системы аутентификации. Эти файлы также потребуется изменить, если удаленное веб-приложение получает доступ к SharePoint с помощью удостоверения, не принадлежащего пользователю, который запустил надстройку SharePoint. Наконец, рассмотрим ситуацию, когда удаленное веб-приложение создано с помощью PHP, node.js, Java или другой платформы, отличной от ASP.NET. В этом случае вашему коду необходимо получить идентификатор пользователя от используемой системы аутентификации, а затем добавить этот идентификатор в создаваемый маркер доступа. Дополнительные сведения см. в статьях [Упаковка и публикация надстроек с высоким уровнем доверия для SharePoint](package-and-publish-high-trust-sharepoint-add-ins.md), [Создание и использование маркеров доступа в надстройках SharePoint с высоким уровнем доверия, размещаемых у поставщика](create-and-use-access-tokens-in-provider-hosted-high-trust-sharepoint-add-ins.md) и [Использование надстроек SharePoint на сайтах SAML и FBA в SharePoint](http://blogs.technet.com/b/speschka/archive/2012/12/07/using-sharepoint-apps-with-saml-and-fba-sites-in-sharepoint-2013.aspx).
 

 

## <a name="additional-resources"></a>Дополнительные ресурсы
<a name="bk_addresources"> </a>


-  [Упаковка и публикация надстроек SharePoint с высоким уровнем доверия](package-and-publish-high-trust-sharepoint-add-ins.md)
    
 
-  [Советы по устранению неполадок надстроек с высоким уровнем доверия в SharePoint](http://blogs.technet.com/b/speschka/archive/2012/11/01/more-troubleshooting-tips-for-high-trust-apps-on-sharepoint-2013.aspx)
    
 
-  [Регистрация надстроек SharePoint 2013](register-sharepoint-add-ins.md)
    
 
-  [Авторизация и проверка подлинности для надстроек в SharePoint](authorization-and-authentication-of-sharepoint-add-ins.md)
    
 
-  [Объявление о новом вспомогательном объекте SharePointContext в надстройках SharePoint 2013](http://blogs.msdn.com/b/officeapps/archive/2013/11/07/announcing-the-new-sharepointcontext-helper-in-apps-for-sharepoint-2013.aspx)
    
 
-  [Разрешения для надстроек в SharePoint](add-in-permissions-in-sharepoint.md)
    
 
-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md)
    
 

