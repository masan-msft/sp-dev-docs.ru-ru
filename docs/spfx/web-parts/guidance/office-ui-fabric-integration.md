# <a name="using-office-ui-fabric-core-and-fabric-react-in-spfx-client-side-web-parts"></a>Использование Office UI Fabric Core и Fabric React в клиентских веб-частях SPFx

#### **Важно!** Для использования компонентов Office UI Fabric React необходимо обновить имеющиеся проекты, чтобы они использовали *@microsoft/sp-build-web@1.0.1* или более поздней версии. Дополнительные сведения вы найдете в инструкциях в конце этой статьи.

Office UI Fabric — это официальная клиентская платформа для создания интерфейсов в Office 365 и SharePoint. SharePoint обеспечивает полную интеграцию с Fabric, благодаря которой корпорация Майкрософт может предоставлять надежный и согласованный язык дизайна в различных решениях на основе SharePoint, таких как современные сайты групп, страницы и списки. Кроме того, платформа Office UI Fabric доступна разработчикам в SharePoint Framework при создании пользовательских решений SharePoint.

> Способы интеграции и использования Office UI Fabric по-прежнему находятся в стадии разработки. Этот документ содержит сведения о текущем состоянии платформы для разработчиков SPFx. Вскоре мы опубликуем окончательный план.

## <a name="goals"></a>Цели

Office UI Fabric состоит из двух частей, доступных разработчикам:

  1. [Office UI Fabric Core](http://dev.office.com/fabric), или Fabric Core, — это набор, включающий основные стили, оформление, адаптируемую сетку, анимацию, значки и другие стандартные блоки общего языка дизайна.

  2. [Office UI Fabric React](http://dev.office.com/fabric#/components), или Fabric React, — это пакет, содержащий набор компонентов React, основанных на языке дизайна Fabric.
  
Одна из целей SharePoint Framework — предоставить корпорации Майкрософт и ее клиентам возможность создавать функциональные, привлекательные и согласованные решения на основе SharePoint. Достижению этой цели способствуют наши принципы разработки:

* Удобство и надежность для всех пользователей при использовании Fabric Core и Fabric React в решениях.
* Корпорация Майкрософт должна развертывать обновленные решения, использующие обновленные версии Fabric Core и Fabric React, в SharePoint без конфликтов с решениями клиента.
* Пользователи должны иметь возможность настраивать и переопределять стили, оформление и компоненты в соответствии с потребностями решения.
* Пользователи должны иметь возможность создавать решения на платформах, не основанных на React.

## <a name="summary"></a>Сводка

Корпорация Майкрософт использует Fabric Core и Fabric React в SharePoint. Корпорация Майкрософт регулярно выпускает обновления для SharePoint Online, а решения для SharePoint, скорее всего, продолжат обновлять используемые ими версии Fabric Core и Fabric React. Возможны конфликты этих обновлений со сторонними решениями, созданными с помощью предыдущих версий Fabric Core и Fabric React. В результате этого в модификациях могут возникать исключения. Основная причина таких сбоев — использование **глобальных стилей CSS** в обеих библиотеках Fabric. Таких конфликтов следует избегать во что бы то ни стало. 

Одно из главных препятствий для обеспечения надежности — использование **глобальных стилей CSS**. В настоящее время как Fabric Core, так и fabric.component.css используют глобальные стили.

По этим причинам пользовательские решения пока не могут безопасно использовать компоненты Office UI Fabric. Однако мы понимаем, что Fabric Core и Fabric React необходимы разработчикам для создания решений. Мы постараемся устранить эту проблему как можно скорее.

Ниже представлена сводка поддерживаемых в настоящее время вариантов использования Office UI Fabric с решением SharePoint Framework в зависимости от выбранной платформы JavaScript.

- React: безопасно использовать Office UI Fabric можно только с помощью **статических ссылок** на компоненты Fabric React.
- Другие библиотеки JS: использование Office UI Fabric с решениями SharePoint Framework **не** поддерживается.

> Пример текущих сложностей с управлением версиями: при создании веб-часть использует класс `ms-Icon--List`. Позже в Fabric меняется определение этого класса. Веб-часть, опирающаяся на предыдущую реализацию, может выйти из строя. Аналогичный случай: допустим, веб-часть использует класс `ms-Button` из Fabric React. Затем разработчики Fabric React кардинально меняют реализацию объекта Button и стилей класса `ms-Button`. Скорее всего, это выведет веб-часть из строя.

> Трудности с глобальными стилями CSS хорошо описаны в следующей презентации на примере React и JSS: [React CSS в JS](https://speakerdeck.com/vjeux/react-css-in-js).

## <a name="how-to-use-the-office-ui-fabric-react-in-a-safe-way-in-your-solution"></a>Безопасное использование Office UI Fabric React в решении

Ниже представлены рекомендации по безопасному и надежному использованию Fabric в веб-частях на основе React.

- Разработчикам веб-частей необходимо явно указывать зависимость от библиотеки Fabric React версии 2.0 в файле **package.json**: `"office-ui-fabric-react":"2.0.0"`. Обратите внимание, что Fabric React версий выше 2.x не поддерживается.
- Разработчикам веб-частей необходимо добавлять **статические ссылки** на компоненты Fabric React. При этом компонент Fabric React включается в пакет веб-части. Благодаря этому, если реализация объекта Button на уровне страницы изменится, это не окажет отрицательного влияния на веб-часть.
- **Переопределять** стили компонентов Fabric React следует осторожно и только в локальной области. Разработчик может переопределять стили с помощью пользовательских классов CSS с тегами `!important` и style. В обоих случаях специфичность этих классов будет выше, чем у классов компонентов. Обратите внимание, что при переопределении с помощью простого класса могут возникнуть проблемы с порядком загрузки. Например, если класс `ms-Button` загружается после вашего класса, предпочтение отдается классу ms-Button, так как у них одинаковая специфичность.
- **Темы** должны работать без изменений. От разработчика не требуется дополнительных усилий.

В приведенном ниже фрагменте кода показано, как создавать статические и динамические ссылки на библиотеки.

```Javascript
  // This sample demonstrates how static linking should be done for Fabric React components.
  // Remember to explicitly add a dependency on a specific version of 
  // office-ui-fabric-react in your package.json file.

  // correct - static linking.
  import { Button } from 'office-ui-fabric-react/lib/Button';

  // incorrect - dynamic linking.
  import { Button } from '@microsoft/office-ui-fabric-react';

  render() {
    ...
    <div>
      <Button>click me</Button>
    </div>
    ...
  }
```

***Общие сведения об этом подходе и его недостатках***

- Компоненты веб-части привязаны к той версии Fabric React, которая использовалась при создании веб-части. Они не будут автоматически обновляться вместе с соответствующей страницей. Чтобы адаптировать веб-часть к новым версиям Fabric React, вам потребуется обновлять ее вручную.
- Страница может работать медленнее, так как может загружаться больше стилей CSS, но она будет надежной.
- Статические ссылки увеличивают размер пакета веб-части, но динамические могут не работать в будущих версиях SharePoint Online. Статические ссылки — это единственный официально поддерживаемый подход при использовании Office UI Fabric React в решениях SharePoint Framework.

### <a name="currently-unsupported-features"></a>Неподдерживаемые в настоящее время компоненты

- **Office UI Fabric Core**: в реализации Fabric Core используются текущие глобальные стили, например `.ms-Icon--List`, поэтому не существует надежного способа использовать Fabric Core в веб-части без потенциальных проблем в будущем. Ведутся работы над устранением этой проблемы, а дополнительные сведения будут публиковаться по мере изменения ситуации.

- **fabric.components.css**: этот файл содержит глобальные классы, конфликтующие с Fabric React. Например, класс `.ms-Button` из библиотеки fabric.component.css будет переопределять стили кнопок в компоненте Button из Fabric React. Если включить файл fabric.component.css в веб-часть, соответствующая страница или другие веб-части на этой странице могут выйти из строя. Мы работаем над решением и скоро выпустим обновление.


## <a name="using-the-office-ui-fabric-with-non-react-based-web-parts"></a>Использование Office UI Fabric с веб-частями, не основанными на React

Использование Office UI Fabric с веб-частями, не основанными на React, в настоящее время не поддерживается, а с такими реализациями могут возникать непредвиденные проблемы после выпуска новой версии Office UI Fabric. Мы разрабатываем надежный механизм интеграции для **Office UI Fabric Core**, **fabric.component.css** и **веб-частей не на React**. 

## <a name="additional-details-on-the-css-challenge-with-office-ui-fabric"></a>Дополнительные сведения о трудностях с CSS в Office UI Fabric
Представленные ниже понятия и ссылки раскрывают суть проблем с использованием Office UI Fabric в контексте клиентских веб-частей. 

**Глобальные стили CSS** и как избегать их использования любой ценой: это серьезная проблема. На данный момент библиотеки Fabric Core и Fabric React содержат глобальные стили. Отсутствие встроенных в браузеры решений для управления областями стилей делает это очень трудной задачей.
  
  - [Области CSS](https://developer.mozilla.org/en-US/docs/Web/CSS/:scope) находятся на ранней стадии рассмотрения. 
  - Элементы IFrame плохо подходят для изолирования стилей.
  - [Веб-компоненты](https://developer.mozilla.org/en-US/docs/Web/Web_Components) — еще один стандарт, который включает стили с ограниченной областью действия, но пока только обсуждается.
          
    В [этом](https://speakerdeck.com/vjeux/react-css-in-js) обсуждении хорошо раскрыта суть проблемы. В Интернете есть множество другой документации, посвященной решениям проблемы с глобальными пространствами имен.
 
**[Специфичность CSS](https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity)** и как она связана с веб-интерфейсами. Стили с большей специфичностью переопределяют стили с меньшей специфичностью. Но самое важное — понять, как применяются правила специфичности. Общий порядок приоритетов (по убыванию) выглядит так:
  - Атрибут стиля (например, `style="background:red;"`)
  - Селекторы идентификаторов (например, `#myDiv { }`)
  - Селекторы классов (например, `.myCssClass{}`), селекторы атрибутов (например, `[type="radio"]`) и псевдоклассы (например, `:hover`)
  - Селекторы типов (например, `h1`)

***Порядок загрузки***: если к элементу применяются два класса с одинаковой специфичностью, предпочтение отдается классу, загруженному позже. Как показано в представленном ниже коде, кнопка будет красной. Если изменить порядок тегов стиля, она станет зеленой. Это важное понятие. При его неправильном использовании пользовательский интерфейс начинает зависеть от порядка загрузки, то есть становится несогласованным.

```HTML
<style>
  .greenButton { color: green; }
</style>
<style>
  .redButton { color: red; }
</style>
<body>
  <button class="greenButton redButton"></button>
</body>
```

## <a name="other-approaches-considered-and-discarded"></a>Другие подходы, которые были рассмотрены и отклонены
Ниже представлены дополнительные сведения о других подходах, которые были рассмотрены, но отклонены, так как они не соответствовали ключевым целям и не позволяли разработчикам безопасно использовать стили Office UI Fabric.

**Office UI Fabric Core**

Разработчику веб-части не требовалось бы выполнять никаких явных действий, чтобы определения областей работали. Мы планировали решить эту проблему с помощью специфичности CSS и селектора потомков. Разработчики Fabric Core собирались выпустить несколько копий CSS-файла Fabric Core, например `fabric-6.css`, `fabric-6-scoped.css`, `fabric-6.0.0.css` и `fabric-6.0.0-scoped.css`.

Все стили в CSS-файлах с ограниченной областью действия были бы включены в селектор потомков, например `"ms-Fabric-core--v6 ms-Icon--List"`. Во время компиляции инструменты получали бы версию Office UI Fabric Core, с помощью которой была создана веб-часть. Это могла быть версия, входящая в состав SPFx. Кроме того, разработчики веб-частей могли бы явно указывать зависимость от определенной версии Office UI Fabric Core в файле **package.json**.

Разделителю веб-части была бы назначена эта область действия, т. е. `<div data-sp-webpart class="ms-Fabric-core--v6">`. Платформа загружала бы определенную основную версию CSS-файла с областью действия на уровне Fabric Core. Если веб-часть была создана с помощью CSS-файла Fabric Core версии 6.0.0, платформа скачивала бы файл `fabric-6-scoped.css` во время загрузки веб-части.

Остальная часть страницы содержала бы стили Office UI Fabric Core с неограниченной областью действия. Таким образом, согласно правилам специфичности CSS внутри разделителя веб-части имели бы приоритет стили CSS с ограниченной областью действия. Веб-часть и ее содержимое были бы адаптированы к определенной версии Office UI Fabric Core, выбранной разработчиком.

**Переопределение** стилей Fabric Core не поддерживалось.  

```Javascript
// Sample of how the scoping would work.
import { SPComponentLoader } from '@microsoft/sp-loader';

export default class MyWebPart {
    constructor() {
        super();

        SPComponentLoader.loadCss('https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/6.0.0/css/fabric-6.0.0.scoped.css');
    }
}

protected render(): void {
  <div className={css('ms-Fabric-core--v6')}>
    { // Rest of the web part UI }
  </div>
}
```

После тщательного анализа этой стратегии было принято решение, что у подхода с использованием селектора потомков есть два серьезных недостатка, не позволяющих создать отказоустойчивую веб-часть.

**Отсутствие надежной поддержки вложения**. Этот подход работает, только если страница и веб-части Майкрософт используют версию Office UI Fabric Core (т. е. `ms-Icon--List`) с неограниченной областью действия, а сторонние веб-части — только CSS Office UI Fabric Core с ограниченной областью действия, как описано выше. Причина заключается в том, что стиль CSS с ограниченной областью действия, примененный к веб-части, переопределяет CSS с неограниченной областью действия на странице. Обратите внимание: как описывалось ранее, если специфичность двух классов CSS совпадает, то предпочтение отдается классу, загруженному позже. Следовательно, для обеспечения согласованности интерфейса важно, чтобы специфичность класса CSS с ограниченной областью действия была выше.

Более того, несколько расширений, вложенных друг в друга, не могут использовать разные версии Fabric Core. Например, в приведенном ниже примере применяется только `ms-Fabric-core--v6`.

```HTML
<div className={css('ms-Fabric-core--v6')}>
  { // Rest of the web part UI }
    { // inside of this SPExtension trying to use different Fabric core version does not work }
    <div className={css('ms-Fabric-core--v8')}>
    </div>
</div>
```

Ниже представлен более простой пример, иллюстрирующий эту проблему.

```HTML
<html>
<head>
  <title>CSS specifity test</title>
  <style>
  .myButton {
      background-color: brown;
      color: brown;
      height: 20px;
      width: 40px;
  }
  </style>
  <style>
  .scope2 .myButton {
      background-color: green;
      color: green;
  }
  </style>
  <style>
  .scope3 .myButton {
      background-color: yellow;
      color: yellow;
  }
  </style>
  <style>
  .scope1 .myButton {
      background-color: red;
      color: red;
  }
  </style>
</head>
<body>
  <div>
    <span>These tests demonstrate descendant selectors, nesting and load order problems.</span>

    <div>
      <br/>
      <span>This test depicts that a descendant selector with the same specificity does not allow nesting.
      All buttons below do not take the innermost scope (i.e. they should be different colors), but they are all red.
      Further, if you change the ordering of the style tags, the colors will change. (i.e. the UI is load order dependant.)</span> 
      <div class='scope1'>
        <button class='myButton'</button>
        <div class='scope2'>
          <button class='myButton'></button>
          <div class='scope3'>
            <button class='myButton'></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
```

**Утечки из неограниченных классов** — еще одна проблема с селекторами потомков. Обратите внимание, что в приведенном выше примере стили высоты и ширины из неограниченного класса myButton применяются ко всем кнопкам. Это означает, что изменение этого стиля может случайно сделать неработоспособным код HTML, в котором используется разметка с ограниченной областью действия. Допустим, по какой-то причине на уровне приложения мы меняем высоту в классе myButton на 0 пикселей. В результате во всех сторонних веб-частях, использующих класс myButton, будет задана высота в 0 пикселей, что отрицательно скажется на пользовательском интерфейсе.

## <a name="updating-an-existing-project"></a>Обновление существующего проекта

В файле `package.json` проекта обновите зависимость `@microsoft/sp-build-web` до версии 1.0.1 или выше, удалите каталог `node_modules` проекта и выполните команду `npm install`.

