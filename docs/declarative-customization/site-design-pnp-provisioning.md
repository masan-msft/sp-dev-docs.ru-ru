---
title: "Создание полноценного макета сайта SharePoint с помощью модуля подготовки PnP"
description: "Создание полноценного макета сайта SharePoint с помощью модуля подготовки PnP"
ms.date: 12/14/2017
ms.openlocfilehash: 303aca9f0103634e247ec75a0323321a77709113
ms.sourcegitcommit: 28690b54f1ef7c811d64393d2eaaff0a8635cc72
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2017
---
# <a name="calling-the-pnp-provisioning-engine-from-a-site-script"></a>Вызов модуля подготовки PnP из скрипта на сайте

> [!NOTE]
> Макеты и скрипты сайтов в настоящий момент пересматриваются и могут быть изменены. Сейчас они не поддерживаются для использования в рабочих средах.

Макеты сайтов — удобный способ стандартизации внешнего вида и функций семейств веб-сайтов. Но если вы захотите сделать больше (например, добавить на каждую страницу нижний колонтитул), то заметите, что макеты сайтов не предоставляют такой возможности. С помощью модуля подготовки PnP вы можете создать шаблон, позволяющий подготовить настройщик приложений для сайта. Затем этот настройщик приложений может зарегистрировать нижний колонтитул на каждой странице. Из этой статьи вы узнаете, как создать макет сайта, применяющий к сайту шаблон подготовки PnP, который добавит настройщик приложений для отрисовки нижнего колонтитула.

При настройке мы используем следующие компоненты:

1. макет и скрипт сайта;
1. поток Microsoft Flow;
1. очередь службы хранилища Azure;
1. функция Azure;
1. решение SPFX;
1. шаблон подготовки PnP;
1. скрипт PnP PowerShell;
1. AppId и AppSecret с правами администратора для клиента.

Все эти компоненты необходимы, чтобы вызвать код подготовки PnP контролируемым образом сразу после создания сайта и применения макета.

## <a name="setting-up-app-only-access-to-your-tenant"></a>Настройка доступа к клиенту только для приложений

Для этого необходимо открыть в клиенте 2 разные страницы (на обычном сайте и на сайте администрирования SharePoint).

1. Перейдите по следующему URL-адресу в клиенте: https://[ваш_клиент].sharepoint.com/_layouts/appregnew.aspx (вы можете перейти на любой сайт, но пока что выберите корневой).
1. Нажмите обе кнопки **Создать**.
1. Укажите название приложения, например "Подготовка сайта".
1. В поле "Домен приложения" введите **localhost**.
1. В поле "URI перенаправления" введите **https://localhost**.

    ![Создание приложения](images/pnpprovisioning-createapponly.png)

1. Нажмите кнопку **Создать** и скопируйте значения из полей **Идентификатор клиента** и **Секрет клиента**, так как они потребуются позже.

Теперь мы предоставим этому приложению надлежащий уровень доступа к клиенту.
1. Перейдите на страницу https://[ваш_клиент]-admin.sharepoint.com/_layouts/appinv.aspx (обратите внимание на строку "-admin" в URL-адресе).
1. Вставьте скопированный ранее идентификатор клиента в поле **Код приложения** и нажмите кнопку **Поиск**.
1. Вставьте следующий код XML в поле **XML-запрос разрешения**:

    ```xml
    <AppPermissionRequests AllowAppOnlyPolicy="true" >
        <AppPermissionRequest Scope="http://sharepoint/content/tenant" Right="FullControl" />
    </AppPermissionRequests>
    ```

1. Нажмите кнопку **Создать**.
1. Вам будет предложено доверять приложению. Дайте согласие, нажав кнопку **Доверять**.


## <a name="creating-the-azure-storage-queue"></a>Создание очереди службы хранилища Azure

В этом случае мы будем использовать очередь службы хранилища Azure, чтобы получать сообщения от Microsoft Flow. Каждый раз, когда в очереди хранилища появляется сообщение, вызывается функция Azure для выполнения скрипта PowerShell. Но для начала настроим очередь хранилища.

1. Откройте портал Azure по адресу https://portal.azure.com и войдите.
1. Нажмите кнопку **+ Создать**.
1. Выберите **Хранение** в списках Azure Marketplace, а затем выберите элемент **Учетная запись хранения — BLOB-объект, файл, таблица, очередь** в столбце "Популярные".
1. Укажите значения в обязательных полях. Установите флажок **Закрепить на панели мониторинга**, чтобы учетную запись было легко найти позже, и нажмите кнопку **Создать**. Начнется создание учетной записи хранения. Это может занять несколько минут.
1. Откройте учетную запись хранения после ее создания и перейдите к разделу **Очереди** в области навигации.
1. Нажмите кнопку **+ Очередь** в верхней части основной области экрана.
1. Введите имя **pnpprovisioningqueue** или другое имя, соответствующее действующему стандарту именования. Запишите имя очереди, так как оно потребуется позже, при создании функции Azure.
1. Перейдите к разделу **Ключи доступа** и запишите **имя учетной записи хранения** и **значение ключа key1**. Они потребуются на следующем этапе — при создании потока.


## <a name="the-flow"></a>Поток

Чтобы поместить сообщение в очередь, необходимо создать поток. 

1. Перейдите на сайт **https://flow.microsoft.com**, войдите и создайте поток, выбрав команду **Создать с нуля** в верхней части страницы.
1. Нажмите **Поиск среди сотен соединителей и триггеров**, чтобы выбрать триггер.
1. Введите слово **Запрос** и выберите **Запрос: при получении HTTP-запроса**.
1. Введите следующий код JSON в теле запроса:

    ```json
    {
        "type": "object",
        "properties": {
            "webUrl": {
                "type": "string"
            },
            "parameters": {
                "type": "object",
                "properties": {
                    "event": {
                        "type": "string"
                    },
                    "product": {
                        "type": "string"
                    }
                }
            }
        }
    }
    ``` 

1. Нажмите кнопку **+ Новый этап** и выберите **Добавить действие**.
1. Выполните поиск по запросу **Очереди Azure** и выберите **Очереди Azure: поместить сообщение в очередь**.
1. Введите имя подключения. Это может быть любое описательное название.
1. Введите имя учетной записи хранения, скопированное из предыдущего раздела.
1. Введите открытый ключ хранилища, представляющий собой **значение ключа Key1** для учетной записи хранения.
1. Нажмите кнопку **Создать**.
1. Выберите имя очереди **pnpprovisioningqueue**.
1. В тексте для этапа 4 мы указали входящий параметр с именем webUrl. Мы поместим значение этого параметра в очередь. Щелкните поле **Сообщение** и выберите **webUrl** в средстве выбора динамического контента.
1. Нажмите кнопку **Сохранить поток**. При этом будет создан URL-адрес, который мы скопируем на следующем этапе.
1. Щелкните первый этап потока ("При получении HTTP-запроса") и скопируйте URL-адрес. Он потребуется нам для тестирования потока и создания макета сайта.
1. Сохраните поток.

Он должен выглядеть примерно так:

![Поток](images/pnpprovisioning-flow-overview.png)

## <a name="testing-the-flow"></a>Тестирование потока

Чтобы тестировать поток, необходимо отправить POST-запрос. На компьютере с Windows это проще всего сделать с помощью PowerShell:

```powershell
$uri = "[the URI you copied in step 8 when creating the flow]"
$body = "{webUrl:'somesiteurl'}
Invoke-RestMethod -Uri $uri -Method Post -ContentType "application/json" -Body $body
```

Если теперь перейти на главный экран потока, отобразится журнал запусков. В случае успешного выполнения должно отображаться состояние "Успешно".
Теперь перейдите к очереди, созданной только что в Azure, и нажмите кнопку **Обновить**. Должна отображаться запись, указывающая, что вы успешно вызвали поток.

## <a name="provision-the-spfx-solution"></a>Подготовка решения SPFX

В этом пошаговом руководстве мы будем использовать имеющееся решение SPFX, доступное по адресу https://github.com/SharePoint/sp-dev-fx-extensions/tree/master/samples/react-application-regions-footer.

Выполните действия, описанные в файле README.MD из этого репозитория, чтобы собрать и подготовить решение.

# <a name="create-a-pnp-provisioning-template"></a>Создание шаблона подготовки PnP

Скопируйте приведенный ниже код XML в новый файл и сохраните его с именем FlowDemoTemplate.xml.

```xml
<?xml version="1.0"?>
<pnp:Provisioning xmlns:pnp="http://schemas.dev.office.com/PnP/2017/05/ProvisioningSchema">
  <pnp:Preferences Generator="OfficeDevPnP.Core, Version=2.20.1711.0, Culture=neutral, PublicKeyToken=3751622786b357c2" />
  <pnp:Templates ID="CONTAINER-FLOWDEMO">
    <pnp:ProvisioningTemplate ID="TEMPLATE-FLOWDEMO" Version="1" BaseSiteTemplate="GROUP#0" Scope="RootSite">
      <pnp:CustomActions>
        <pnp:WebCustomActions>
          <pnp:CustomAction Name="spfx-react-app-customizer" Description="Custom action for Application Customizer" Location="ClientSideExtension.ApplicationCustomizer" Title="spfx-react-app-customizer" Sequence="0" Rights="" RegistrationType="None" ClientSideComponentId="67fd1d01-84e8-4fbf-85bd-4b80768c6080" ClientSideComponentProperties="{&quot;SourceTermSetName&quot;:&quot;Regions&quot;}" />
        </pnp:WebCustomActions>
      </pnp:CustomActions>
    </pnp:ProvisioningTemplate>
</pnp:Provisioning>
```

> [!NOTE]
> Шаблон добавляет дополнительное действие на сайт, к которому он применяется. Он ссылается на свойство ClientSideComponentId, поступающее из подготовленного ранее решения SPFX. Чтобы запустить эту демонстрацию с собственным решением SPFX, необходимо изменить значения атрибутов ClientSideComponentId и (необязательно) ClientSideComponentProperties в XML-файле.

## <a name="create-the-azure-function"></a>Создание функции Azure

1. Перейдите на портал Azure по адресу https://portal.azure.com.
1. Выполните поиск по запросу "Приложение-функция" и создайте приложение-функцию. В поле **Хранилище** выберите **Использовать имеющееся**, а затем укажите созданную ранее учетную запись хранения. При необходимости задайте другие значения.
1. После создания приложения-функции откройте его и выберите **Функции**, а затем нажмите **Создать функцию**.

  ![Создание функции](images/pnpprovisioning-create-function.png)

1. В раскрывающемся списке "Язык" выберите **PowerShell**.
1. Выберите **QueueTrigger — PowerShell**.
1. Назовите функцию **ApplyPnPProvisioningTemplate**. 
1. Введите имя очереди, созданной на предыдущих этапах.
1. Нажмите кнопку **Создать**.
1. Откроется редактор, где можно вводить командлеты PowerShell. Теперь мы отправим модуль PnP для PowerShell, чтобы использовать его в функции Azure.

## <a name="uploading-pnp-powershell-for-your-azure-function"></a>Отправка модуля PowerShell PnP для функции Azure

Для начала необходимо скачать модуль PnP для PowerShell, чтобы позже его было легко отправить.

1. Создайте временную папку в любом расположении на компьютере.
1. Запустите PowerShell и введите следующую команду:
    ```powershell
    Save-Module -Name SharePointPnPPowerShellOnline -Path [pathtoyourfolder]
    ```
1. Файлы модуля PowerShell будут загружены в папку, вложенную в только что выбранную папку. 

Теперь следует отправить эти файлы, чтобы функция Azure могла использовать модуль:

1. Перейдите на главную страницу приложения-функции и выберите **Функции платформы**.

    ![Перейдите к разделу "Функции платформы".](images/pnpprovisioning-platform-features.png)

1. Выберите **Дополнительные инструменты (Kudu)**.

    ![Выберите "Дополнительные инструменты (Kudu)".](images/pnpprovisioning-select-kudu.png)

1. На главной странице Kudu нажмите **Консоль отладки** и выберите **CMD** или **PowerShell**.
1. В верхней части страницы откроется проводник. Перейдите к папке **site\wwwroot\\[имя_функции_azure]**.
1. Создайте папку и назовите ее **modules**.
    
    ![Создание папки](images/pnpprovisioning-kudu-create-folder.png)

1. В этой папке создайте еще одну папку с именем **SharePointPnPPowerShellOnline** и перейдите к ней.
1. В проводнике на компьютере перейдите к папке, в которую вы скачали все файлы модуля PnP для PowerShell. Откройте папку **SharePointPnPPowerShellOnline\2.20.1711.0** (обратите внимание на то, что в настоящее время номер версии может быть другим).
1. Отправьте все файлы из этой папки, перетащив их в папку в Kudu.

   ![Создание папки](images/pnpprovisioning-module-files-uploaded.png)

## <a name="finishing-the-azure-function"></a>Завершение создания функции Azure

1. Вернитесь к функции Azure и разверните вкладку файлов справа.

    ![Просмотр файлов](images/pnpprovisioning-view-files.png)

1. Нажмите кнопку **Отправить** и отправьте созданный ранее файл шаблона подготовки.
1. Замените скрипт PowerShell на следующий код:

```powershell
$in = Get-Content $triggerInput -Raw
Write-Output "Incoming request for '$in'"
Connect-PnPOnline -AppId $env:SPO_AppId -AppSecret $env:SPO_AppSecret -Url $in
Write-Output "Connected to site"
Apply-PnPProvisioningTemplate -Path D:\home\site\wwwroot\ApplyPnPProvisioningTemplate\FlowDemoTemplate.xml
```

Обратите внимание на то, что мы используем 2 переменные среды — ```SPO_AppId``` и ```SPO_AppSecret```. Чтобы задать эти переменные, перейдите на главную страницу приложения-функции на портале Azure, выберите **Параметры приложения** и добавьте два новых параметра приложения:

1. ```SPO_AppId```. Укажите в качестве значения идентификатор клиента, скопированный на первом этапе во время создания приложения в клиенте.
2. ```SPO_AppSecret```. Укажите в качестве значения секрет клиента, скопированный на первом этапе во время создания приложения в клиенте.

## <a name="creating-the-site-design"></a>Создание макета сайта

Откройте PowerShell и убедитесь, что установлена консоль управления Microsoft Office 365.

Для начала подключитесь к клиенту с помощью командлета Connect-SPOService:

```powershell
Connect-SPOService -Url https://[yourtenant]-admin.sharepoint.com
```

Теперь вы можете получить имеющиеся макеты сайтов с помощью следующей команды: 

```powershell
Get-SPOSiteDesign
```

Перед созданием макета сайта необходимо создать скрипт сайта. Макет сайта можно рассматривать как контейнер, ссылающийся на один или несколько скриптов сайта.
1. Скопируйте приведенный ниже код JSON в буфер обмена и измените его. Задайте для свойства url значение, скопированное при создании потока. URL-адрес выглядит так: `https://prod-27.westus.logic.azure.com:443/workflows/ef7434cf0d704dd48ef5fb6...oke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun`

    ```json
    {
        "$schema": "schema.json",
        "actions": [
           {
                "verb": "triggerFlow",
                "url": "[paste the workflow trigger URL here]",
                "name": "Apply Template",
                "parameters": {
                    "event":"",
                    "product":""
                }
           }
        ],
        "bindata": {},
        "version": 1
    }
    ```

1. Когда вы измените код JSON, скопировав URL-адрес для вызова потока, выделите его и снова скопируйте в буфер обмена.
1. Откройте консоль PowerShell и введите приведенную ниже команду, чтобы скопировать скрипт в переменную и создать скрипт сайта.

    ```powershell
    $script = Get-Clipboard -Raw
    Add-SPOSiteScript -Title "Apply PnP Provisioning Template" -Content $script
    Get-SPOSiteScript
    ```

1. Должен появиться список из одного или нескольких скриптов сайта, включая только что созданный.
1. Выделите ИД только что созданного скрипта сайта и скопируйте его в буфер обмена.
1. Создайте макет сайта:

    ```powershell
    Add-SPOSiteDesign -Title "Site with footer" -SiteScripts [Paste the ID of the Site Script here] -WebTemplate "64"
    ```

Командлет Add-SPOSiteDesign сопоставит макет с сайтом группы. Чтобы сопоставить макет с сайтом для общения, используйте значение 68.

## <a name="conclusion"></a>Заключение

Мы создали очередь хранилища и ИД приложения, обеспечивающий доступ только для приложений, корректно создали функцию Azure и макет сайта, а затем вызвали правильный поток Microsoft Flow из макета сайта. Теперь все готово к работе. 

Чтобы создать новый сайт, перейдите к клиенту SharePoint. Выберите **SharePoint**, нажмите **Создать сайт** и выберите **Сайт группы**. Новый макет сайта должен появиться в списке доступных вариантов оформления. Создайте сайт и обратите внимание на то, как макет сайта применяется после его создания. Если все настроено надлежащим образом, должен вызываться поток. Вы можете просмотреть журнал запусков потока, чтобы проверить, был ли он запущен должным образом. Применение шаблона подготовки PnP может занять некоторое время, поэтому нижний колонтитул может появиться не сразу. Подождите минуту и перезагрузите сайт.


